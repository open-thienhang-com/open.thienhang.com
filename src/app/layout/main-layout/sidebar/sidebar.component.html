<div class="sidebar-container">
  <!-- Header actions with Search & Tools -->
  <div class="header-actions" [class.collapsed]="collapsed">
    <!-- Search Bar - Only visible when not collapsed -->
    <div class="search-container" *ngIf="!collapsed">
      <input type="text" 
             pInputText 
             [(ngModel)]="searchKeyword" 
             placeholder="Search..."
             (keyup.enter)="performSearch()"
             (input)="onSearchInput()"
             class="search-input">
      <i class="pi pi-search search-icon" (click)="performSearch()"></i>
      
      <!-- Search Results Overlay -->
      <div class="search-overlay" *ngIf="showSearchResults">
        <app-search-results
          [results]="searchResults$ | async"
          [isSearching]="isSearching$ | async"
          [popularSearches]="popularSearches"
          (clear)="clearSearch()"
          (resultClick)="onSearchResultClick($event)">
        </app-search-results>
      </div>
    </div>

    <!-- Action Buttons Row -->
    <div class="actions-row" [class.justify-center]="collapsed">
      <!-- App Switcher -->
      <button
        type="button"
        class="header-btn app-switcher-header-btn"
        (click)="openAppMatrix()"
        [pTooltip]="workspaceLabel"
        tooltipPosition="right">
        <i class="pi pi-th-large"></i>
      </button>

      <!-- Language Selector -->
      <button
        pStyleClass="@next"
        enterFromClass="hidden"
        enterActiveClass="animate-scalein"
        leaveToClass="hidden"
        leaveActiveClass="animate-fadeout"
        [hideOnOutsideClick]="true"
        type="button"
        class="header-btn"
        [pTooltip]="collapsed ? 'Language' : ''"
        tooltipPosition="right"
        *ngIf="!collapsed">
        <i class="pi pi-globe"></i>
      </button>
      <div class="dropdown-menu language-menu hidden" *ngIf="!collapsed">
        <button 
          (click)="changeLanguage('vi')"
          class="dropdown-item"
          [class.active]="currentLanguage() === 'vi'">
          <span class="text-lg">ðŸ‡»ðŸ‡³</span>
          <span class="text-sm">Tiáº¿ng Viá»‡t</span>
          <i *ngIf="currentLanguage() === 'vi'" class="pi pi-check text-green-500 ml-auto"></i>
        </button>
        <button 
          (click)="changeLanguage('en')"
          class="dropdown-item"
          [class.active]="currentLanguage() === 'en'">
          <span class="text-lg">ðŸ‡ºðŸ‡¸</span>
          <span class="text-sm">English</span>
          <i *ngIf="currentLanguage() === 'en'" class="pi pi-check text-green-500 ml-auto"></i>
        </button>
      </div>

      <!-- Theme Toggle -->
      <button type="button"
              class="header-btn"
              (click)="onThemeToggler()"
              [pTooltip]="collapsed ? 'Theme' : ''"
              tooltipPosition="right">
        <i [ngClass]="'pi ' + iconClass()"></i>
      </button>

      <!-- Color Palette -->
      <button
        pStyleClass="@next"
        enterFromClass="hidden"
        enterActiveClass="animate-scalein"
        leaveToClass="hidden"
        leaveActiveClass="animate-fadeout"
        [hideOnOutsideClick]="true"
        type="button"
        class="header-btn"
        [pTooltip]="collapsed ? 'Colors' : ''"
        tooltipPosition="right"
        *ngIf="!collapsed">
        <i class="pi pi-palette"></i>
      </button>
      <div class="dropdown-menu color-menu hidden" *ngIf="!collapsed">
        <div class="color-section">
          <span class="section-label">Primary Colors</span>
          <div class="color-grid">
            @for (primaryColor of primaryColors(); track primaryColor.name) {
              <button
                type="button"
                [title]="primaryColor.name"
                (click)="updateColors($event, 'primary', primaryColor)"
                class="color-swatch"
                [class.selected]="selectedPrimaryColor() === primaryColor.name"
                [ngStyle]="{
                  'background-color': primaryColor.name === 'noir' ? 'var(--text-color)' : primaryColor.palette['500']
                }">
              </button>
            }
          </div>
        </div>
        <div class="color-section">
          <span class="section-label">Surface Colors</span>
          <div class="color-grid">
            @for (surface of surfaces; track surface.name) {
              <button
                type="button"
                [title]="surface.name"
                (click)="updateColors($event, 'surface', surface)"
                class="color-swatch"
                [class.selected]="selectedSurfaceColor() === surface.name"
                [ngStyle]="{
                  'background-color': surface.palette['500']
                }">
              </button>
            }
          </div>
        </div>
        <div class="color-section">
          <span class="section-label">Preset</span>
          <p-selectbutton [options]="presets" [ngModel]="selectedPreset()" (ngModelChange)="onPresetChange($event)"
                          [unselectable]="false" size="small"/>
        </div>
        <div class="color-section">
          <span class="section-label">Ripple Effect</span>
          <p-toggleswitch [(ngModel)]="ripple"/>
        </div>
      </div>

      <!-- Logout - only when not collapsed -->
      <button
        class="header-btn logout-btn"
        *ngIf="!collapsed"
        (click)="doLogout()"
        type="button"
        [pTooltip]="'Logout'"
        tooltipPosition="right">
        <i class="pi pi-sign-out"></i>
      </button>
    </div>

    <!-- App Name Label - Below actions row -->
    <div class="app-name-label" *ngIf="!collapsed">
      <span class="app-name">{{ workspaceLabel }}</span>
    </div>

    <!-- Debug info (temporary) -->
    <div class="sidebar-debug p-2 text-xs text-gray-600 dark:text-gray-300" *ngIf="showDebug && !collapsed">
      <div><strong>DEBUG</strong></div>
      <div>appKey: <code>{{ appKey }}</code></div>
      <div>visibleGroups: <code>{{ visibleGroups?.length }}</code></div>
      <div *ngIf="visibleGroups && visibleGroups.length">
        <span *ngFor="let g of visibleGroups; let i = index">
          <code>{{ i+1 }}:{{ g.label || '(no-label)' }}[items={{ (g.items||[]).length }}|flat={{ (g._flattened||[]).length }}]</code>
          <span *ngIf="i < (visibleGroups.length -1)">, </span>
        </span>
      </div>
    </div>
  </div>

  <!-- Navigation - Scrollable Middle Section -->
  <div class="sidebar-content">
    <nav class="sidebar-nav" [class.collapsed]="collapsed">
      
      <!-- Quick Access Section -->
      <!-- Quick Access removed per request -->

      <!-- Main Navigation Groups -->
      <div class="nav-section" *ngFor="let group of visibleGroups; trackBy: trackByGroup">
        <!-- Group Header - Clickable to expand/collapse. Omit when _noHeader flag is set -->
        <ng-container *ngIf="!group._noHeader">
          <button 
            class="group-header"
            [class.expanded]="group.expanded"
            [class.collapsed-sidebar]="collapsed"
            (click)="!collapsed && toggleGroup(group)"
            type="button">
            <div class="group-title">
              <i [class]="group.icon"></i>
              <span *ngIf="!collapsed">{{ group.label }}</span>
            </div>
            <i 
              *ngIf="!collapsed && hasItems(group)" 
              class="pi pi-chevron-down expand-icon"
              [class.expanded]="group.expanded"></i>
          </button>
        </ng-container>

  <!-- Group Items - Flat list (NO nested subgroups) -->
  <!-- Render if group has items or if a flattened item list was provided (pseudo-group) -->
  <ul class="nav-list" *ngIf="!collapsed && (hasItems(group) || (group._flattened && group._flattened.length > 0))" [ngClass]="{ open: group.expanded || group._noHeader }">
          <li *ngFor="let item of group._flattened; trackBy: trackByItem">
            <a
              [routerLink]="getPath(item.url)"
              [queryParams]="getQueryParams(item.url)"
              class="nav-link sub-link"
              routerLinkActive="active"
              *ngIf="item.url">
              <i [class]="item.icon"></i>
              <span>{{ item.label }}</span>
            </a>
          </li>
        </ul>
      </div>

    </nav>
  </div>

  <!-- Footer - Fixed at bottom -->
  <div class="sidebar-footer" [class.collapsed]="collapsed">
    
    <!-- User Info removed per request -->

    <!-- Footer now only contains Profile (logout and app-switcher were moved to header) -->
    <div class="footer-actions">
      <button
        type="button"
        class="footer-btn profile-btn"
        (click)="openProfile()"
        [pTooltip]="collapsed ? userFullName() : ''"
        tooltipPosition="right">
        <i class="pi pi-user"></i>
        <span *ngIf="!collapsed">{{ userFullName() }}</span>
      </button>
    </div>
  </div>
</div>

<!-- App Matrix Dialog -->
<p-dialog 
  header="All Applications" 
  [(visible)]="showAppMatrix" 
  [modal]="true" 
  appendTo="body"
  [baseZIndex]="10000"
  [style]="{ width: '1200px', maxWidth: '96vw' }" 
  [closable]="true" 
  (onHide)="closeAppMatrix()"
  styleClass="app-matrix-dialog">
  <div class="apps-matrix-grid">
    <button *ngFor="let app of appMatrix(); let i = index" type="button"
            class="app-tile"
            [class.active]="selectedApp === app.key"
            [attr.data-app-key]="app.key"
            (click)="selectAppKey(app.key)"
            [attr.aria-label]="app.label">

      <!-- App Gradient Background with dynamic color -->
      <div class="app-background" [style.background]="app.gradient"></div>
      
      <!-- Animated gradient overlay -->
      <div class="gradient-overlay"></div>
      
      <!-- App Icon with glow effect -->
      <div class="app-icon-wrapper">
        <div class="icon-glow"></div>
        <i [class]="app.icon"></i>
      </div>
      
      <!-- App Content -->
      <div class="app-content">
        <h3 class="app-label">{{ app.label }}</h3>
        <p class="app-description" *ngIf="app.description">{{ app.description }}</p>
      </div>
      
      <!-- Active indicator badge -->
      <div class="active-badge" *ngIf="selectedApp === app.key">
        <i class="pi pi-check"></i>
      </div>

    </button>
  </div>
</p-dialog>

<!-- Info Dialog -->
<p-dialog 
  header="{{ selectedInfo?.title }}" 
  [(visible)]="infoDialogVisible" 
  [modal]="true" 
  [style]="{ width: '600px' }"
  [draggable]="false" 
  [resizable]="false"
  styleClass="info-dialog">
  
  <div *ngIf="selectedInfo" class="info-content">
    <!-- Description -->
    <div class="mb-4">
      <p class="text-gray-700 dark:text-gray-300 leading-relaxed">
        {{ selectedInfo.description }}
      </p>
    </div>

    <!-- Features -->
    <div class="mb-4">
      <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">
        <i class="pi pi-star text-blue-500 mr-2"></i>
        Key Features
      </h4>
      <ul class="space-y-2">
        <li *ngFor="let feature of selectedInfo.features" class="flex items-start gap-2">
          <i class="pi pi-check text-green-500 mt-0.5 text-sm"></i>
          <span class="text-gray-700 dark:text-gray-300 text-sm">{{ feature }}</span>
        </li>
      </ul>
    </div>

    <p-divider></p-divider>

    <!-- Usage -->
    <div class="mb-4">
      <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">
        <i class="pi pi-info-circle text-blue-500 mr-2"></i>
        How to Use
      </h4>
      <p class="text-gray-700 dark:text-gray-300 leading-relaxed">
        {{ selectedInfo.usage }}
      </p>
    </div>

    <!-- Tips -->
    <div *ngIf="selectedInfo.tips && selectedInfo.tips.length > 0" class="mb-4">
      <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">
        <i class="pi pi-lightbulb text-yellow-500 mr-2"></i>
        Pro Tips
      </h4>
      <ul class="space-y-2">
        <li *ngFor="let tip of selectedInfo.tips" class="flex items-start gap-2">
          <i class="pi pi-angle-right text-blue-500 mt-0.5 text-sm"></i>
          <span class="text-gray-700 dark:text-gray-300 text-sm">{{ tip }}</span>
        </li>
      </ul>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <div class="flex justify-end gap-2">
      <button 
        pButton 
        pRipple 
        label="Got it!" 
        icon="pi pi-check"
        class="p-button-primary"
        (click)="hideInfo()">
      </button>
    </div>
  </ng-template>
</p-dialog>