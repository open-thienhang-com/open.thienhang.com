<div class="role-detail-wrapper">
  <p-toast></p-toast>
  <p-confirmDialog></p-confirmDialog>

  <!-- Inline error banner for visible feedback when loading fails -->
  <div *ngIf="errorMessage" class="error-banner">
    <div class="error-banner-content">
      <i class="pi pi-exclamation-triangle"></i>
      <div class="error-text">
        <strong>Error:</strong>
        <span>{{ errorMessage }}</span>
      </div>
      <button pButton pRipple label="Back to Roles" icon="pi pi-arrow-left" 
              class="p-button-text p-button-sm" (click)="goBack()"></button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-state">
    <p-progressSpinner styleClass="large-spinner"></p-progressSpinner>
    <h3>Loading role details...</h3>
  </div>

  <!-- Main Content - New Layout -->
  <div *ngIf="!loading && role" class="role-detail-content">
    
    <!-- STICKY HEADER WITH BREADCRUMB & ACTIONS -->
    <div class="role-header sticky-header">
      <div class="header-left">
        <button pButton pRipple icon="pi pi-arrow-left" 
                class="p-button-text p-button-rounded back-button"
                pTooltip="Back to Roles" (click)="goBack()">
        </button>
        <div class="breadcrumb">
          <span class="breadcrumb-item">Governance</span>
          <i class="pi pi-angle-right"></i>
          <span class="breadcrumb-item">Roles</span>
          <i class="pi pi-angle-right"></i>
          <span class="breadcrumb-item active">{{ role.name }}</span>
        </div>
      </div>
      
      <div class="header-actions">
        <button pButton pRipple label="Edit" icon="pi pi-pencil" 
                class="p-button-outlined p-button-sm" (click)="editRole()">
        </button>
        <button pButton pRipple 
                [label]="role.is_active ? 'Deactivate' : 'Activate'"
                [icon]="role.is_active ? 'pi pi-times-circle' : 'pi pi-check-circle'"
                [class]="role.is_active ? 'p-button-outlined p-button-warning p-button-sm' : 'p-button-outlined p-button-success p-button-sm'"
                (click)="toggleRoleStatus()">
        </button>
        <button pButton pRipple icon="pi pi-trash" 
                class="p-button-outlined p-button-danger p-button-sm"
                pTooltip="Delete Role" (click)="deleteRole()">
        </button>
      </div>
    </div>

    <!-- ROLE OVERVIEW SECTION -->
    <div class="role-overview-section">
      <!-- Identity Card -->
      <div class="identity-card">
        <div class="role-avatar">
          <div class="avatar-icon" [ngClass]="'avatar-' + role.type">
            <i class="pi pi-shield"></i>
          </div>
        </div>
        
        <div class="role-identity">
          <h1 class="role-name">{{ role.name }}</h1>
          <div class="role-meta">
            <p-tag [value]="role.type | titlecase" 
                   [severity]="getRoleTypeSeverity(role.type)" 
                   styleClass="type-tag">
            </p-tag>
            <p-tag [value]="role.is_active ? 'Active' : 'Inactive'"
                   [severity]="role.is_active ? 'success' : 'secondary'"
                   styleClass="status-tag">
            </p-tag>
          </div>
          <p class="role-description" *ngIf="role.description">{{ role.description }}</p>
          <div class="role-metadata">
            <div class="meta-item" (click)="copyToClipboard(role.kid)">
              <i class="pi pi-id-card"></i>
              <span>{{ role.kid }}</span>
              <i class="pi pi-copy copy-icon"></i>
            </div>
            <div class="meta-item">
              <i class="pi pi-calendar"></i>
              <span>Created {{ role.created_at | date:'MMM d, y' }}</span>
            </div>
            <div class="meta-item">
              <i class="pi pi-clock"></i>
              <span>Updated {{ role.updated_at | date:'MMM d, y' }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Stats Dashboard -->
      <div class="stats-dashboard">
        <div class="stat-card">
          <div class="stat-icon permissions-icon">
            <i class="pi pi-shield"></i>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ role.permissions?.length || 0 }}</div>
            <div class="stat-label">Permissions</div>
            <div class="stat-breakdown">
              {{ getSelectedPermissionsCount() }} enabled
            </div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon assets-icon">
            <i class="pi pi-database"></i>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ getTotalAssetsCount() }}</div>
            <div class="stat-label">Protected Assets</div>
            <div class="stat-breakdown">
              {{ getAssetTypeStats().length }} types
            </div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon coverage-icon">
            <i class="pi pi-chart-pie"></i>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ getUniqueAssetCount() }}</div>
            <div class="stat-label">Unique Assets</div>
            <div class="stat-breakdown">
              Across all permissions
            </div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon actions-icon">
            <i class="pi pi-bolt"></i>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ actionOptions?.length || 0 }}</div>
            <div class="stat-label">Action Types</div>
            <div class="stat-breakdown">
              Read, Write, Delete...
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- TAB-BASED CONTENT -->
    <div class="permissions-content">
      <p-tabView [(activeIndex)]="activeTabIndex" styleClass="role-tabs">
        
        <!-- TAB 1: All Permissions -->
        <p-tabPanel header="All Permissions" leftIcon="pi pi-list">
          <ng-template pTemplate="header">
            <i class="pi pi-list"></i>
            <span>All Permissions</span>
            <p-badge [value]="role.permissions?.length" severity="info" styleClass="ml-2"></p-badge>
          </ng-template>

          <div class="tab-content">
            <!-- Search & Filter Toolbar -->
            <div class="content-toolbar">
              <span class="p-input-icon-left search-input">
                <i class="pi pi-search"></i>
                <input pInputText type="text" 
                       [(ngModel)]="searchTerm"
                       (input)="filterAssets($event)"
                       placeholder="Search permissions or assets..." />
                <button *ngIf="searchTerm" pButton pRipple icon="pi pi-times" 
                        class="p-button-text p-button-sm clear-search"
                        (click)="clearSearch()">
                </button>
              </span>

              <div class="toolbar-actions">
                <button pButton pRipple label="Expand All" icon="pi pi-angle-down"
                        class="p-button-outlined p-button-sm"
                        (click)="expandAllRows()">
                </button>
                <button pButton pRipple label="Collapse All" icon="pi pi-angle-up"
                        class="p-button-outlined p-button-sm"
                        (click)="collapseAllRows()">
                </button>
              </div>
            </div>

        <!-- Permissions Table -->
        <p-table 
          #permissionTable
          [value]="getFilteredPermissions()" 
          [expandedRowKeys]="expandedRows"
          dataKey="_id"
          [loading]="loading"
          [globalFilterFields]="['name', 'code', 'action', 'description']"
          styleClass="p-datatable-lg"
          [tableStyle]="{'min-width': '60rem'}"
          [paginator]="getFilteredPermissions().length > 10"
          [rows]="10"
          [showCurrentPageReport]="true"
          currentPageReportTemplate="Showing {first} to {last} of {totalRecords} permissions">
          
          <!-- Permission Columns -->
          <ng-template pTemplate="header">
            <tr>
              <th style="width: 3rem;">
                <i class="pi pi-plus-circle" style="font-size: 1.2rem; color: var(--primary-color);"></i>
              </th>
              <th style="width: 4rem;">
                <p-checkbox 
                  [binary]="true"
                  [ngModel]="areAllPermissionsSelected()"
                  (onChange)="toggleAllPermissions($event)"
                  [indeterminate]="isSomePermissionsSelected()">
                </p-checkbox>
              </th>
              <th>Permission</th>
              <th style="width: 8rem;">Action</th>
              <th style="width: 8rem;">Assets</th>
              <th style="width: 8rem;">Asset Types</th>
              <th style="width: 10rem;">Status</th>
            </tr>
          </ng-template>
          
          <!-- Permission Rows -->
          <ng-template pTemplate="body" let-permission let-expanded="expanded">
            <tr>
              <!-- Expand/Collapse Button -->
              <td>
                <button 
                  type="button" 
                  pButton 
                  pRipple 
                  [pRowToggler]="permission" 
                  class="p-button-text p-button-rounded p-button-plain"
                  [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'">
                </button>
              </td>
              
              <!-- Permission Checkbox -->
              <td>
                <p-checkbox 
                  [binary]="true"
                  [(ngModel)]="permission.selected"
                  (onChange)="togglePermission(permission)">
                </p-checkbox>
              </td>
              
              <!-- Permission Info -->
              <td>
                <div class="permission-info">
                  <div class="permission-name">{{ permission.name }}</div>
                  <div class="permission-code">{{ permission.code }}</div>
                  <div *ngIf="permission.description" class="permission-description">
                    {{ permission.description }}
                  </div>
                </div>
              </td>
              
              <!-- Action -->
              <td>
                <p-tag 
                  [value]="permission.action" 
                  [severity]="getActionSeverity(permission.action)"
                  styleClass="action-tag">
                </p-tag>
              </td>
              
              <!-- Asset Count -->
              <td>
                <div class="asset-stats">
                  <span class="asset-count">{{ permission.validAssets?.length || 0 }}</span>
                  <small>assets</small>
                </div>
              </td>
              
              <!-- Asset Types Count -->
              <td>
                <div class="asset-types">
                  <p-badge 
                    [value]="getAssetTypesForPermission(permission).length" 
                    severity="info"
                    styleClass="asset-types-badge">
                  </p-badge>
                  <small>types</small>
                </div>
              </td>
              
              <!-- Status -->
              <td>
                <p-tag 
                  [value]="permission.selected ? 'Enabled' : 'Disabled'"
                  [severity]="permission.selected ? 'success' : 'secondary'"
                  styleClass="status-tag">
                </p-tag>
              </td>
            </tr>
          </ng-template>
          
          <!-- Expanded Row Template - Assets List -->
          <ng-template pTemplate="rowexpansion" let-permission>
            <tr>
              <td colspan="7">
                <div class="assets-expansion-content">
                  <div class="assets-header">
                    <h4>
                      <i class="pi pi-database"></i>
                      Assets for {{ permission.name }}
                      <span class="assets-count">({{ permission.validAssets?.length || 0 }} total)</span>
                    </h4>
                    
                    <!-- Asset Type Filters -->
                    <div class="asset-type-filters" *ngIf="getAssetTypesForPermission(permission).length > 1">
                      <span class="filter-label">Filter by type:</span>
                      <p-chip 
                        *ngFor="let assetType of getAssetTypesForPermission(permission)"
                        [label]="assetType | titlecase"
                        [icon]="getAssetIcon(assetType)"
                        styleClass="asset-type-chip"
                        [class.active]="selectedAssetTypes.includes(assetType)"
                        (click)="toggleAssetTypeFilter(assetType)">
                      </p-chip>
                    </div>
                  </div>
                  
                  <!-- Assets Table -->
                  <p-table 
                    [value]="getFilteredAssetsForPermission(permission)"
                    styleClass="p-datatable-sm assets-table"
                    [tableStyle]="{'margin-top': '1rem'}"
                    [paginator]="getFilteredAssetsForPermission(permission).length > 5"
                    [rows]="5"
                    [showCurrentPageReport]="false">
                    
                    <!-- Assets Header -->
                    <ng-template pTemplate="header">
                      <tr>
                        <th style="width: 3rem;">
                          <p-checkbox 
                            [binary]="true"
                            [ngModel]="areAllAssetsSelected(permission)"
                            (onChange)="toggleAllAssetsForPermission(permission, $event)"
                            [indeterminate]="isSomeAssetsSelected(permission)">
                          </p-checkbox>
                        </th>
                        <th>Asset</th>
                        <th style="width: 8rem;">Type</th>
                        <th style="width: 8rem;">Sensitivity</th>
                        <th>Location</th>
                        <th style="width: 8rem;">Source</th>
                      </tr>
                    </ng-template>
                    
                    <!-- Assets Body -->
                    <ng-template pTemplate="body" let-asset>
                      <tr>
                        <!-- Asset Checkbox -->
                        <td>
                          <p-checkbox 
                            [binary]="true"
                            [(ngModel)]="asset.selected"
                            (onChange)="toggleAsset(permission, asset)">
                          </p-checkbox>
                        </td>
                        
                        <!-- Asset Info -->
                        <td>
                          <div class="asset-info">
                            <i [class]="getAssetIcon(asset.type)" class="asset-icon"></i>
                            <div class="asset-details">
                              <div class="asset-name">{{ asset.name }}</div>
                              <div class="asset-kid" *ngIf="asset.kid">{{ asset.kid }}</div>
                            </div>
                          </div>
                        </td>
                        
                        <!-- Asset Type -->
                        <td>
                          <p-tag 
                            [value]="asset.type | titlecase"
                            severity="info"
                            styleClass="type-tag">
                          </p-tag>
                        </td>
                        
                        <!-- Sensitivity -->
                        <td>
                          <p-tag 
                            *ngIf="asset.sensitivity"
                            [value]="asset.sensitivity | titlecase"
                            [severity]="getSensitivitySeverity(asset.sensitivity)"
                            styleClass="sensitivity-tag">
                          </p-tag>
                          <span *ngIf="!asset.sensitivity" class="no-data">-</span>
                        </td>
                        
                        <!-- Location -->
                        <td>
                          <span *ngIf="asset.location" class="asset-location" [title]="asset.location">
                            {{ asset.type === 'route' && asset.location.length > 50 
                               ? asset.location.substring(0, 50) + '...' 
                               : asset.location }}
                          </span>
                          <span *ngIf="!asset.location" class="no-data">-</span>
                        </td>
                        
                        <!-- Source -->
                        <td>
                          <span class="asset-source">{{ asset.source || 'unknown' }}</span>
                        </td>
                      </tr>
                    </ng-template>
                    
                    <!-- Empty Assets State -->
                    <ng-template pTemplate="emptymessage">
                      <tr>
                        <td colspan="6" class="text-center">
                          <div class="empty-assets-message">
                            <i class="pi pi-inbox"></i>
                            <p>No assets found for this permission</p>
                          </div>
                        </td>
                      </tr>
                    </ng-template>
                  </p-table>
                </div>
              </td>
            </tr>
          </ng-template>
          
          <!-- Empty Permissions State -->
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="7" class="text-center">
                <div class="empty-permissions-message">
                  <i class="pi pi-shield"></i>
                  <h3>No permissions found</h3>
                  <p *ngIf="searchTerm">
                    No permissions match "<strong>{{ searchTerm }}</strong>"
                  </p>
                  <p *ngIf="!searchTerm && role.permissions?.length === 0">
                    This role has no permissions assigned yet.
                  </p>
                  <button 
                    *ngIf="searchTerm"
                    pButton 
                    pRipple 
                    label="Clear Search" 
                    icon="pi pi-times"
                    class="p-button-outlined"
                    (click)="clearSearch()">
                  </button>
                </div>
              </td>
            </tr>
          </ng-template>
        </p-table>

        <!-- Table Footer -->
        <ng-template pTemplate="footer">
          <div class="table-footer">
            <div class="selection-summary">
              <div class="summary-section">
                <div class="summary-title">
                  <i class="pi pi-user"></i>
                  Role: {{ role.name }}
                </div>
                <div class="summary-stats">
                  <div class="summary-item">
                    <i class="pi pi-shield"></i>
                    <strong>{{ getSelectedPermissionsCount() }}</strong> of {{ role.permissions?.length || 0 }} permissions selected
                  </div>
                  <div class="summary-item">
                    <i class="pi pi-database"></i>
                    <strong>{{ getSelectedAssetsCount() }}</strong> of {{ getTotalAssetsCount() }} assets accessible
                  </div>
                </div>
              </div>
            </div>
            
            <div class="table-actions">
              <button 
                pButton 
                pRipple 
                label="Save Changes"
                icon="pi pi-save"
                class="p-button-success"
                [disabled]="!hasChanges()"
                (click)="savePermissionChanges()">
              </button>
              
              <button 
                pButton 
                pRipple 
                label="Reset"
                icon="pi pi-refresh"
                class="p-button-outlined p-button-secondary"
                [disabled]="!hasChanges()"
                (click)="resetChanges()">
              </button>
            </div>
          </div>
        </ng-template>
      </p-card>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="!loading && !role" class="error-state">
    <div class="error-content">
      <i class="pi pi-exclamation-triangle error-icon"></i>
      <h3>Role Not Found</h3>
      <p>The role you're looking for doesn't exist or has been deleted.</p>
      <button 
        pButton 
        pRipple 
        label="Back to Roles" 
        icon="pi pi-arrow-left"
        class="p-button-outlined"
        (click)="goBack()">
      </button>
    </div>
  </div>
</div>