<div class="role-detail-container">
  <p-toast></p-toast>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-state">
    <p-progressSpinner></p-progressSpinner>
    <p>Loading role details...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="!loading && errorMessage" class="error-state">
    <p-card>
      <h3>Error Loading Role</h3>
      <p>{{ errorMessage }}</p>
      <p-button label="Go Back" icon="pi pi-arrow-left" (onClick)="goBack()"></p-button>
    </p-card>
  </div>

  <!-- Role Detail Content -->
  <div *ngIf="!loading && !errorMessage && role" class="role-detail-content">
    <p-card>
      <ng-template pTemplate="header">
        <div class="card-header">
          <div>
            <h2>{{ role.name }}</h2>
            <p class="role-subtitle">{{ role.kid }}</p>
          </div>
          <p-button label="Back" icon="pi pi-arrow-left" (onClick)="goBack()"></p-button>
        </div>
      </ng-template>

      <div class="role-info">
        <div class="info-row" *ngIf="role.description">
          <strong>Description:</strong>
          <span>{{ role.description || 'No description' }}</span>
        </div>
        <div class="info-row">
          <strong>Type:</strong>
          <span>{{ role.type || 'N/A' }}</span>
        </div>
        <div class="info-row">
          <strong>Total Permissions:</strong>
          <span>{{ role.permissions?.length || 0 }}</span>
        </div>
        <div class="info-row">
          <strong>Total Assets:</strong>
          <span>{{ getTotalAssetsCount() }}</span>
        </div>
      </div>

      <h3 class="section-title">Permissions & Assets</h3>
      
      <!-- PrimeNG Table with RowSpan for Permission Grouping -->
      <p-table 
        *ngIf="role.permissions && role.permissions.length > 0"
        [value]="getExpandedPermissions()" 
        [tableStyle]="{ 'min-width': '60rem' }"
        styleClass="p-datatable-gridlines"
        [rowHover]="true">
        
        <ng-template pTemplate="header">
          <tr>
            <th style="width: 25%">Permission</th>
            <th style="width: 10%">Action</th>
            <th style="width: 20%">Asset Name</th>
            <th style="width: 10%">Type</th>
            <th style="width: 25%">Location</th>
            <th style="width: 10%">Status</th>
          </tr>
        </ng-template>
        
        <ng-template pTemplate="body" let-item let-rowIndex="rowIndex">
          <tr>
            <!-- Permission column with rowspan -->
            <td *ngIf="item.isFirstAsset" [attr.rowspan]="item.assetCount">
              <div class="permission-cell">
                <strong>{{ item.permission.name }}</strong>
                <small class="permission-code">{{ item.permission.code }}</small>
                <p class="permission-desc" *ngIf="item.permission.description">
                  {{ item.permission.description }}
                </p>
                <span class="asset-badge">{{ item.assetCount }} asset(s)</span>
              </div>
            </td>
            
            <!-- Action column with rowspan -->
            <td *ngIf="item.isFirstAsset" [attr.rowspan]="item.assetCount">
              <span class="action-badge action-{{ item.permission.action }}">
                {{ item.permission.action }}
              </span>
            </td>
            
            <!-- Asset details (one row per asset) -->
            <td>
              <span [class.unknown-asset]="!item.asset.kid">
                {{ item.asset.name }}
              </span>
            </td>
            <td>
              <span class="type-badge type-{{ item.asset.type }}">
                {{ item.asset.type }}
              </span>
            </td>
            <td>
              <small class="asset-location">{{ item.asset.location }}</small>
            </td>
            <td>
              <span class="status-badge status-{{ item.asset.status }}">
                {{ item.asset.status }}
              </span>
            </td>
          </tr>
        </ng-template>
        
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="6" class="text-center">No permissions or assets found.</td>
          </tr>
        </ng-template>
      </p-table>

      <p *ngIf="!role.permissions || role.permissions.length === 0" class="no-data">
        No permissions assigned to this role.
      </p>
    </p-card>
  </div>
</div>
