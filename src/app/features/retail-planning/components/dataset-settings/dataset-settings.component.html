<div class="min-h-screen bg-gray-50">
  <!-- Page Header -->
  <app-page-header 
    title="Cài Đặt Dataset" 
    subtitle="Cấu hình vùng, bưu cục, khoảng thời gian và ca làm việc"
    icon="⚙️">
  </app-page-header>

  <!-- Main Content -->
  <div class="p-6">
    <div class="max-w-6xl mx-auto space-y-6">
      
      <!-- Health Check Status -->
      <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2">
            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Trạng thái hệ thống
          </h3>
          <button 
            (click)="loadHealthChecks()" 
            [disabled]="loadingHealth"
            class="px-4 py-2 bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 text-white rounded-lg text-sm font-semibold transition-colors flex items-center gap-2">
            <svg *ngIf="!loadingHealth" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            <div *ngIf="loadingHealth" class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
            Làm mới
          </button>
        </div>

        <div *ngIf="loadingHealth" class="flex items-center justify-center py-8">
          <div class="text-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-2"></div>
            <p class="text-sm text-gray-600">Đang kiểm tra trạng thái hệ thống...</p>
          </div>
        </div>

        <div *ngIf="!loadingHealth" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <!-- Redis Status -->
          <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-semibold text-gray-700">Redis</span>
              <span [ngClass]="getHealthStatusClass(healthStatus.readiness?.redis)" 
                    class="px-2 py-1 rounded-full text-xs font-bold">
                {{ getHealthStatusText(healthStatus.readiness?.redis) }}
              </span>
            </div>
            <p class="text-xs text-gray-500">Kết nối cache</p>
          </div>

          <!-- MongoDB Status -->
          <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-semibold text-gray-700">MongoDB</span>
              <span [ngClass]="getHealthStatusClass(healthStatus.readiness?.mongodb)" 
                    class="px-2 py-1 rounded-full text-xs font-bold">
                {{ getHealthStatusText(healthStatus.readiness?.mongodb) }}
              </span>
            </div>
            <p class="text-xs text-gray-500">Cơ sở dữ liệu</p>
          </div>

          <!-- ETL Status -->
          <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-semibold text-gray-700">ETL Service</span>
              <span [ngClass]="getHealthStatusClass(healthStatus.etl?.status)" 
                    class="px-2 py-1 rounded-full text-xs font-bold">
                {{ getHealthStatusText(healthStatus.etl?.status) }}
              </span>
            </div>
            <div *ngIf="healthStatus.etl" class="text-xs text-gray-500 mt-1">
              <p>Scheduler: {{ healthStatus.etl.scheduler_running ? 'Đang chạy' : 'Dừng' }}</p>
              <p>Jobs: {{ healthStatus.etl.running_jobs_count }}/{{ healthStatus.etl.scheduled_jobs_count }}</p>
            </div>
            <p *ngIf="!healthStatus.etl" class="text-xs text-gray-400 mt-1">Chưa có dữ liệu</p>
          </div>

          <!-- Sync Status -->
          <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-semibold text-gray-700">Sync Service</span>
              <span [ngClass]="getHealthStatusClass(healthStatus.sync?.status)" 
                    class="px-2 py-1 rounded-full text-xs font-bold">
                {{ getHealthStatusText(healthStatus.sync?.status) }}
              </span>
            </div>
            <div *ngIf="healthStatus.sync" class="text-xs text-gray-500 mt-1">
              <p>Service: {{ healthStatus.sync.service }}</p>
            </div>
            <p *ngIf="!healthStatus.sync" class="text-xs text-gray-400 mt-1">Chưa có dữ liệu</p>
          </div>
        </div>

        <div *ngIf="healthError" class="mt-4 bg-red-50 border border-red-200 rounded-lg p-3">
          <p class="text-sm text-red-700">{{ healthError }}</p>
        </div>
      </div>

      <!-- Region and Warehouse Selection -->
      <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
        <div class="flex items-center gap-2 mb-4">
          <div class="w-9 h-9 rounded-lg bg-orange-100 flex items-center justify-center">
            <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
            </svg>
          </div>
          <h4 class="text-base font-bold text-gray-900">Chọn vùng và bưu cục</h4>
        </div>
        <div class="space-y-4">
          <!-- Region Selector -->
          <div>
            <label class="text-sm font-semibold text-gray-700 mb-2 block">Vùng <span class="text-red-500">*</span></label>
            <select
              [(ngModel)]="modalSelectedRegion"
              (change)="onModalRegionChange()"
              class="w-full border-2 border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-medium">
              <option value="" disabled>-- Chọn vùng --</option>
              <option *ngFor="let region of availableRegions" [value]="region.code">
                {{ region.code }} - {{ region.name }}
              </option>
            </select>
          </div>

          <!-- Warehouses List -->
          <div *ngIf="modalSelectedRegion" class="space-y-3">
            <!-- Loading State -->
            <div *ngIf="loadingModalWarehouses" class="flex items-center justify-center py-8 bg-white rounded-lg border border-gray-200">
              <div class="text-center">
                <div class="animate-spin rounded-full h-8 w-8 border-3 border-orange-500 border-t-transparent mx-auto mb-2"></div>
                <p class="text-sm font-medium text-gray-600">Đang tải danh sách bưu cục...</p>
              </div>
            </div>

            <!-- Error State -->
            <div *ngIf="modalWarehousesError && !loadingModalWarehouses" class="bg-red-50 border-2 border-red-200 rounded-lg p-4">
              <div class="flex items-center gap-2">
                <svg class="w-5 h-5 text-red-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="text-sm text-red-700">{{ modalWarehousesError }}</span>
              </div>
            </div>

            <!-- Action Bar -->
            <div *ngIf="!loadingModalWarehouses && !modalWarehousesError && modalWarehouses.length > 0" class="flex items-center justify-between bg-gradient-to-r from-gray-50 to-gray-50/50 rounded-lg px-4 py-2.5 border-2 border-gray-200">
              <div class="flex items-center gap-3">
                <div class="text-xs font-semibold text-gray-700">
                  Tổng: <span class="text-gray-900 font-bold">{{ modalWarehouses.length }}</span>
                </div>
                <div class="w-px h-4 bg-gray-300"></div>
                <div class="text-xs font-semibold text-orange-600">
                  Đã chọn: <span class="text-orange-700 font-bold">{{ modalSelectedWarehouses.size }}</span>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <button
                  type="button"
                  (click)="selectAllWarehousesInModal()"
                  [disabled]="modalSelectedWarehouses.size === modalWarehouses.length"
                  class="px-3 py-1.5 text-xs font-bold bg-green-500 hover:bg-green-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white rounded-lg transition-all shadow-sm">
                  ✓ Tất cả
                </button>
                <button
                  type="button"
                  (click)="deselectAllWarehousesInModal()"
                  [disabled]="modalSelectedWarehouses.size === 0"
                  class="px-3 py-1.5 text-xs font-bold bg-red-500 hover:bg-red-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white rounded-lg transition-all shadow-sm">
                  ✕ Bỏ chọn
                </button>
              </div>
            </div>

            <!-- Warehouses List (Scrollable) -->
            <div *ngIf="!loadingModalWarehouses && !modalWarehousesError && modalWarehouses.length > 0" class="border-2 border-gray-200 rounded-xl overflow-hidden bg-white shadow-sm max-h-[400px] overflow-y-auto">
              <table class="w-full">
                <thead class="bg-gradient-to-r from-gray-100 to-gray-50 sticky top-0 z-10 border-b-2 border-gray-200">
                  <tr>
                    <th class="px-3 py-2.5 text-left w-12">
                      <input
                        type="checkbox"
                        [checked]="modalSelectedWarehouses.size === modalWarehouses.length && modalWarehouses.length > 0"
                        (change)="modalSelectedWarehouses.size === modalWarehouses.length ? deselectAllWarehousesInModal() : selectAllWarehousesInModal()"
                        class="w-4 h-4 text-orange-600 border-gray-400 rounded focus:ring-2 focus:ring-orange-500 cursor-pointer">
                    </th>
                    <th class="px-3 py-2.5 text-left text-xs font-bold text-gray-700 uppercase w-12">STT</th>
                    <th class="px-3 py-2.5 text-left text-xs font-bold text-gray-700 uppercase">Tên bưu cục</th>
                    <th class="px-3 py-2.5 text-left text-xs font-bold text-gray-700 uppercase">Địa chỉ</th>
                    <th class="px-3 py-2.5 text-left text-xs font-bold text-gray-700 uppercase w-20">ID</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-150">
                  <tr *ngFor="let warehouse of modalWarehouses; let i = index"
                      class="hover:bg-orange-50/50 transition-colors cursor-pointer border-b border-gray-100"
                      (click)="toggleWarehouseSelection(warehouse)">
                    <td class="px-3 py-2.5" (click)="$event.stopPropagation()">
                      <input
                        type="checkbox"
                        [checked]="isWarehouseSelectedInModal(warehouse)"
                        (change)="toggleWarehouseSelection(warehouse)"
                        class="w-4 h-4 text-orange-600 border-gray-400 rounded focus:ring-2 focus:ring-orange-500 cursor-pointer">
                    </td>
                    <td class="px-3 py-2.5 text-sm font-bold text-gray-700">{{ i + 1 }}</td>
                    <td class="px-3 py-2.5">
                      <div class="font-semibold text-gray-900 text-sm">{{ warehouse.warehouse_name }}</div>
                    </td>
                    <td class="px-3 py-2.5">
                      <div class="text-xs text-gray-600">{{ warehouse.district_name }}, {{ warehouse.province_name }}</div>
                    </td>
                    <td class="px-3 py-2.5 text-xs text-gray-500 font-mono">{{ warehouse.warehouse_id || warehouse.id }}</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Empty State -->
            <div *ngIf="!loadingModalWarehouses && !modalWarehousesError && modalWarehouses.length === 0" class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
              <svg class="mx-auto h-10 w-10 text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
              </svg>
              <p class="text-sm font-medium text-gray-500">Không có bưu cục nào</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Date Range -->
      <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
        <div class="flex items-center gap-2 mb-4">
          <div class="w-9 h-9 rounded-lg bg-orange-100 flex items-center justify-center">
            <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
          </div>
          <h4 class="text-base font-bold text-gray-900">Khoảng thời gian</h4>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="text-sm font-semibold text-gray-700 mb-2 block">Từ ngày</label>
            <input type="date" [(ngModel)]="demandStartDate" (ngModelChange)="onDateRangeChange()" class="w-full border-2 border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-medium" />
          </div>
          <div>
            <label class="text-sm font-semibold text-gray-700 mb-2 block">Đến ngày</label>
            <input type="date" [(ngModel)]="demandEndDate" (ngModelChange)="onDateRangeChange()" class="w-full border-2 border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-medium" />
          </div>
        </div>
        <div *ngIf="demandErrors && demandErrors.length" class="mt-3 text-sm text-red-600 bg-red-50 border border-red-200 rounded-lg p-3">
          <div *ngFor="let err of demandErrors" class="flex items-center gap-2">
            <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            {{ err }}
          </div>
        </div>
      </div>

      <!-- Shift configuration -->
      <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
        <div class="flex items-center gap-2 mb-4">
          <div class="w-9 h-9 rounded-lg bg-orange-100 flex items-center justify-center">
            <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <h4 class="text-base font-bold text-gray-900">Cấu hình ca làm việc</h4>
        </div>
        <div class="space-y-3">
          <div *ngFor="let s of shifts; let i = index" class="flex items-center gap-3 p-4 bg-gray-50 rounded-xl border border-gray-200">
            <div class="w-8 h-8 rounded-full bg-gradient-to-br from-orange-400 to-orange-600 text-white flex items-center justify-center font-bold text-sm flex-shrink-0">
              {{ i + 1 }}
            </div>
            <input [(ngModel)]="s.name" class="border-2 border-gray-300 rounded-lg px-4 py-2 text-sm w-36 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-medium" placeholder="Tên ca" />
            <select [(ngModel)]="s.start_hour" class="border-2 border-gray-300 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-medium">
              <option *ngFor="let h of hours" [ngValue]="h">{{ h }}:00</option>
            </select>
            <span class="text-gray-500 font-semibold">—</span>
            <select [(ngModel)]="s.end_hour" class="border-2 border-gray-300 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-medium">
              <option *ngFor="let h of hoursInclusive" [ngValue]="h">{{ h }}:00</option>
            </select>
            <button class="ml-auto text-red-500 hover:bg-red-50 px-3 py-2 rounded-lg transition-colors font-medium" (click)="removeShift(i)" title="Xóa ca">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          <button class="w-full px-4 py-3 bg-white border-2 border-dashed border-gray-300 rounded-xl hover:border-orange-400 hover:bg-orange-50 text-sm font-semibold text-gray-700 transition-all flex items-center justify-center gap-2" (click)="addShift()">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Thêm ca làm việc
          </button>
        </div>
        <div *ngIf="shiftErrors && shiftErrors.length" class="mt-3 text-sm text-red-600 bg-red-50 border border-red-200 rounded-lg p-3">
          <div *ngFor="let err of shiftErrors" class="flex items-center gap-2">
            <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            {{ err }}
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex items-center justify-end gap-3 bg-white rounded-xl shadow-lg border border-gray-200 p-6">
        <button (click)="cancel()" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 transition text-sm font-semibold">Hủy</button>
        <button (click)="applySettings()" class="px-5 py-2 rounded-lg bg-orange-600 text-white hover:bg-orange-700 transition shadow-md text-sm font-semibold">Lưu và áp dụng</button>
      </div>
    </div>
  </div>
</div>
