<div id="content-dataset" class="tab-content min-h-screen bg-gray-50">
  <!-- Page Header -->
  <app-page-header 
    title="Stochastic Dataset" 
    subtitle="Manage and analyze stochastic datasets for forecasting"
    icon="ðŸ“Š">
  </app-page-header>

  <!-- Main Layout -->
  <div class="p-4">
    <!-- Retail Domain Overview -->
    <div class="mb-6 bg-white border border-gray-200 rounded-xl shadow-sm p-5" *ngIf="!selectedDatasetId">
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3 mb-4">
        <div>
          <h2 class="text-lg font-bold text-gray-900">Retail Domain Overview</h2>
          <p class="text-sm text-gray-600">Live status from Retail APIs</p>
        </div>
        <div *ngIf="loadingRetailOverview" class="text-sm text-gray-500">Loading retail APIs...</div>
      </div>

      <div *ngIf="retailOverviewNotice" class="mb-4 bg-amber-50 border border-amber-200 rounded-lg px-3 py-2 text-sm text-amber-700">
        {{ retailOverviewNotice }}
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
        <div class="border border-gray-200 rounded-lg p-4">
          <p class="text-xs text-gray-500 mb-1">Health</p>
          <div class="flex items-center gap-2 mb-1">
            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold" [ngClass]="getHealthBadgeClass(retailHealth.status)">
              {{ retailHealth.status || 'unknown' }}
            </span>
          </div>
          <p class="text-xs text-gray-600">{{ retailHealth.service || 'retail' }}</p>
          <p class="text-xs text-gray-500 mt-1" *ngIf="retailHealth.timestamp">
            {{ retailHealth.timestamp | date:'short' }}
          </p>
        </div>

        <div class="border border-gray-200 rounded-lg p-4">
          <p class="text-xs text-gray-500 mb-1">Version</p>
          <p class="text-xl font-bold text-gray-900">{{ retailVersion.version || 'N/A' }}</p>
          <p class="text-xs text-gray-600 mt-1">Adapter: {{ retailVersion.adapter || 'retail' }}</p>
        </div>

        <div class="border border-gray-200 rounded-lg p-4">
          <p class="text-xs text-gray-500 mb-1">Total Products</p>
          <p class="text-xl font-bold text-gray-900">{{ retailInventoryAnalytics.total_products || 0 | number }}</p>
          <p class="text-xs text-gray-600 mt-1">Total Quantity: {{ retailInventoryAnalytics.total_quantity || 0 | number }}</p>
        </div>

        <div class="border border-gray-200 rounded-lg p-4">
          <p class="text-xs text-gray-500 mb-1">Inventory Value</p>
          <p class="text-xl font-bold text-gray-900">{{ retailInventoryAnalytics.inventory_value || 0 | number }}</p>
          <p class="text-xs text-gray-600 mt-1">
            Low stock: {{ retailInventoryAnalytics.low_stock_products || 0 }} | Out of stock: {{ retailInventoryAnalytics.out_of_stock_products || 0 }}
          </p>
        </div>
      </div>

      <div class="border border-gray-200 rounded-lg">
        <div class="px-4 py-3 border-b border-gray-200 flex items-center justify-between">
          <h3 class="font-semibold text-gray-900">Stock Alerts</h3>
          <span class="text-xs text-gray-500">{{ retailAlerts.length }} alerts</span>
        </div>
        <div *ngIf="retailAlerts.length === 0" class="px-4 py-6 text-sm text-gray-500">
          No active alerts
        </div>
        <div *ngIf="retailAlerts.length > 0" class="divide-y divide-gray-100">
          <div *ngFor="let alert of retailAlerts | slice:0:5" class="px-4 py-3">
            <p class="text-sm font-medium text-gray-900">{{ getAlertTitle(alert) }}</p>
            <p class="text-xs text-gray-600" *ngIf="getAlertSubtitle(alert)">{{ getAlertSubtitle(alert) }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Content Area -->
    <div class="relative">
      <!-- Card View: When no dataset is selected -->
      <div *ngIf="!selectedDatasetId" class="w-full p-6">

        <!-- Loading State -->
        <div *ngIf="loading" class="flex items-center justify-center py-12">
          <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500 mx-auto mb-4"></div>
            <span class="text-gray-600 font-medium">Loading datasets...</span>
          </div>
        </div>

        <!-- Error State -->
        <div *ngIf="error && !loading" class="bg-red-50 border-2 border-red-200 rounded-xl p-6 mb-6">
          <div class="flex items-center gap-3">
            <svg class="w-6 h-6 text-red-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div>
              <h4 class="text-red-800 font-bold mb-1">Data loading error</h4>
              <span class="text-red-700">{{ error }}</span>
            </div>
          </div>
        </div>

        <!-- Fallback Notice -->
        <div *ngIf="fallbackNotice && !loading" class="bg-amber-50 border-2 border-amber-200 rounded-xl p-4 mb-6">
          <div class="flex items-start gap-3">
            <svg class="w-5 h-5 text-amber-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M12 3l9 16H3l9-16z"></path>
            </svg>
            <div>
              <h4 class="text-amber-800 font-semibold mb-1">Default data mode</h4>
              <span class="text-amber-700 text-sm">{{ fallbackNotice }}</span>
            </div>
          </div>
        </div>

        <!-- Dataset Cards Grid -->
        <div *ngIf="!loading && !error && datasets.length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <!-- API Datasets Cards -->
          <button *ngFor="let dataset of datasets; trackBy: trackByDatasetId"
                   (click)="viewDataset(dataset)"
                   class="bg-white border border-gray-200 rounded-xl shadow-sm hover:shadow-md transition-all duration-200 p-5 text-left group"
                   [ngClass]="{
                     'border-orange-300 bg-orange-50/50 ring-1 ring-orange-200': selectedDatasetId === dataset.id,
                     'hover:border-orange-200 hover:bg-gray-50': selectedDatasetId !== dataset.id
                   }">
              <div class="flex items-center gap-3 mb-4">
                <div class="w-12 h-12 rounded-xl flex items-center justify-center shadow-md flex-shrink-0"
                     [style.background]="dataset.type === 'demand' ? 'linear-gradient(to bottom right, #fb923c, #ea580c)' : 
                                        dataset.type === 'truck' ? 'linear-gradient(to bottom right, #60a5fa, #3b82f6)' : 
                                        dataset.type === 'trip' ? 'linear-gradient(to bottom right, #4ade80, #22c55e)' : 
                                        dataset.type === 'hub' ? 'linear-gradient(to bottom right, #a78bfa, #8b5cf6)' : 
                                        'linear-gradient(to bottom right, #6b7280, #374151)'">
                  <!-- Truck Icon -->
                  <svg *ngIf="dataset.type === 'truck'" class="w-6 h-6" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"></path>
                  </svg>
                  <!-- Demand Icon -->
                  <svg *ngIf="dataset.type === 'demand'" class="w-6 h-6" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                  </svg>
                  <!-- Trip Icon -->
                  <svg *ngIf="dataset.type === 'trip'" class="w-6 h-6" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                  </svg>
                  <!-- Hub Icon -->
                  <svg *ngIf="dataset.type === 'hub'" class="w-6 h-6" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                  </svg>
                  <!-- Default Icon (for unknown types or null) -->
                  <svg *ngIf="!dataset.type || (dataset.type !== 'truck' && dataset.type !== 'demand' && dataset.type !== 'trip' && dataset.type !== 'hub')" class="w-6 h-6" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                  </svg>
                </div>
                <div class="flex-1 min-w-0">
                  <h4 class="font-bold text-gray-900 text-lg truncate">{{ dataset.name || 'Unnamed Dataset' }}</h4>
                  <p class="text-xs text-gray-500 mt-0.5">
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium"
                          [ngClass]="{
                            'bg-orange-100 text-orange-700': dataset.type === 'demand',
                            'bg-blue-100 text-blue-700': dataset.type === 'truck',
                            'bg-green-100 text-green-700': dataset.type === 'trip',
                            'bg-purple-100 text-purple-700': dataset.type === 'hub',
                            'bg-gray-100 text-gray-700': !['demand', 'truck', 'trip', 'hub'].includes(dataset.type || '')
                          }">
                      {{ dataset.type || 'unknown' }}
                    </span>
                  </p>
                </div>
              </div>
            <p class="text-sm text-gray-600 line-clamp-2" *ngIf="dataset.description">{{ dataset.description }}</p>
            <div class="space-y-2">
              <div class="flex items-center justify-between text-sm">
                <span class="text-gray-600">Records:</span>
                <span class="font-semibold text-gray-900">{{ dataset.records || 0 | number }}</span>
              </div>
              <div *ngIf="dataset.created_at" class="flex items-center justify-between text-sm">
                <span class="text-gray-600">Created:</span>
                <span class="font-medium text-gray-700">{{ dataset.created_at | date:'short' }}</span>
              </div>
            </div>
          </button>
        </div>

        <!-- Empty State -->
        <div *ngIf="!loading && !error && datasets.length === 0" class="flex items-center justify-center py-20">
          <div class="text-center">
            <svg class="w-20 h-20 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <h3 class="text-lg font-semibold text-gray-700 mb-2">No datasets yet</h3>
            <p class="text-sm text-gray-500 mb-4">Create a dataset to start analysis</p>
            <button 
              (click)="createDataset()"
              class="px-5 py-2.5 bg-orange-500 hover:bg-orange-600 text-white rounded-lg font-medium shadow-sm hover:shadow-md transition-all duration-200">
              Create Dataset
            </button>
          </div>
        </div>

      </div>

      <!-- Detail View: When dataset is selected - 2 Column Layout -->
      <div *ngIf="selectedDatasetId" class="w-full h-full flex gap-4">
        <!-- Left Column: Filters and Configuration -->
        <div class="w-fit min-w-[320px] max-w-[400px] sticky top-4 self-start max-h-[calc(100vh-2rem)] overflow-y-auto bg-white rounded-xl shadow-lg border border-gray-200 flex flex-col">
          <!-- Header: Information -->
          <div class="bg-gray-50 border-b border-gray-200 px-4 py-3 flex-shrink-0">
            <div class="flex items-center justify-between">
              <h2 class="text-base font-bold text-gray-900 flex items-center gap-2">
                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span>Information</span>
              </h2>
              <button (click)="openSettingsModal()" class="p-1.5 text-gray-400 hover:text-orange-600 hover:bg-orange-50 rounded-lg transition-all" title="Edit">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
              </button>
            </div>
          </div>

          <!-- Controls Section: Meta Data, Time Range, Select Stops -->
          <div class="flex-1 overflow-y-auto p-4 space-y-4">
            <!-- Meta Data Table -->
            <div *ngIf="selectedDatasetId === 'demand'" class="bg-white border border-gray-200 rounded-lg overflow-hidden">
              <table class="w-full text-sm">
                <tbody>
                  <tr class="border-b border-gray-200">
                    <td class="px-3 py-2.5 font-semibold text-gray-700 bg-gray-50 w-1/3">Time Range:</td>
                    <td class="px-3 py-2.5 text-gray-900">
                      <span *ngIf="demandStartDate && demandEndDate">
                        {{ demandStartDate | date:'dd/MM/yyyy' }} - {{ demandEndDate | date:'dd/MM/yyyy' }}
                      </span>
                      <span *ngIf="!demandStartDate || !demandEndDate" class="text-gray-400">Not selected</span>
                    </td>
                  </tr>
                  <tr class="border-b border-gray-200">
                    <td class="px-3 py-2.5 font-semibold text-gray-700 bg-gray-50 w-1/3">Region:</td>
                    <td class="px-3 py-2.5 text-gray-900">
                      <span *ngIf="warehouseRegionShortname">
                        {{ warehouseRegionShortname }} - {{ getRegionName(warehouseRegionShortname) }}
                      </span>
                      <span *ngIf="!warehouseRegionShortname" class="text-gray-400">-</span>
                    </td>
                  </tr>
                  <tr class="border-b border-gray-200">
                    <td class="px-3 py-2.5 font-semibold text-gray-700 bg-gray-50 w-1/3">Province:</td>
                    <td class="px-3 py-2.5 text-gray-900">
                      <span *ngIf="timelineWarehouses.length > 0 && timelineWarehouses[0].province_name">
                        {{ timelineWarehouses[0].province_name }}
                      </span>
                      <span *ngIf="timelineWarehouses.length === 0 || !timelineWarehouses[0].province_name" class="text-gray-400">-</span>
                    </td>
                  </tr>
                  <tr>
                    <td class="px-3 py-2.5 font-semibold text-gray-700 bg-gray-50 w-1/3">Shifts:</td>
                    <td class="px-3 py-2.5 text-gray-900">
                      <div *ngIf="shifts && shifts.length > 0" class="space-y-1">
                        <!-- Header for sub-columns -->
                        <div class="grid grid-cols-2 gap-3 pb-1 border-b border-gray-200 mb-1">
                          <div class="text-xs font-semibold text-gray-600 uppercase">Shift Name</div>
                          <div class="text-xs font-semibold text-gray-600 uppercase">Time Range</div>
                        </div>
                        <!-- Shift rows -->
                        <div *ngFor="let shift of shifts" class="grid grid-cols-2 gap-3 border-b border-gray-100 last:border-b-0 pb-1 last:pb-0">
                          <div class="font-medium text-gray-700">{{ shift.name || 'Ca' }}</div>
                          <div class="text-gray-600">{{ formatShiftTime(shift) }}</div>
                        </div>
                      </div>
                      <span *ngIf="!shifts || shifts.length === 0" class="text-gray-400">-</span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Warehouse List -->
            <div *ngIf="selectedDatasetId === 'demand'" class="bg-gray-50 rounded-lg border border-gray-200 p-3 flex-1 flex flex-col min-h-0">
              <div class="flex items-center justify-between mb-3 flex-shrink-0">
                <h3 class="text-sm font-bold text-gray-900 flex items-center gap-2">
                  <svg class="w-4 h-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <span>Warehouse List</span>
                  <span class="px-2 py-0.5 bg-orange-100 text-orange-700 rounded-full text-xs font-semibold">{{ timelineWarehouses.length }}</span>
                </h3>
                <button *ngIf="timelineWarehouses.length > 0"
                        (click)="clearAllPoints()"
                        class="text-xs text-red-600 hover:text-red-700 font-medium">
                  Clear all
                </button>
              </div>

              <!-- Search Bar -->
              <div class="mb-3 flex-shrink-0">
                <div class="relative">
                  <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                  </div>
                  <input 
                    type="text" 
                    [(ngModel)]="demandSearchQuery"
                    (ngModelChange)="triggerChangeDetection()"
                    placeholder="Search by warehouse name or ID..." 
                    class="w-full pl-8 pr-8 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 text-xs bg-white"
                  />
                  <button 
                    *ngIf="demandSearchQuery"
                    (click)="clearSearch()"
                    class="absolute inset-y-0 right-0 pr-2 flex items-center text-gray-400 hover:text-gray-600"
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                  </button>
                </div>
              </div>

              <!-- Timeline List -->
              <div *ngIf="timelineWarehouses.length > 0" class="flex-1 overflow-y-auto space-y-2 min-h-0">
                <div *ngFor="let warehouse of paginatedTimelineWarehouses; let i = index"
                     class="flex items-center gap-2 p-2 bg-white border border-orange-200 rounded-lg hover:shadow-sm transition-all group">
                  <div class="flex items-center justify-center w-6 h-6 bg-gradient-to-br from-orange-500 to-orange-600 rounded-full text-white text-xs font-bold flex-shrink-0 shadow-sm">
                    {{ (timelineCurrentPage - 1) * timelinePageSize + i + 1 }}
                  </div>
                  <div class="flex-1 min-w-0">
                    <div class="font-semibold text-gray-900 text-xs mb-0.5 truncate">{{ warehouse.warehouse_name }}</div>
                    <div class="text-xs text-gray-600 truncate">{{ warehouse.district_name }}, {{ warehouse.province_name }}</div>
                  </div>
                  <button
                    (click)="removeFromTimeline(warehouse)"
                    class="flex-shrink-0 p-1 text-red-500 hover:bg-red-100 rounded transition-all opacity-0 group-hover:opacity-100"
                    title="Delete">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                  </button>
                </div>
              </div>

              <!-- Pagination -->
              <div *ngIf="timelineWarehouses.length > timelinePageSize" class="flex items-center justify-between mt-3 pt-3 border-t border-gray-200 flex-shrink-0">
                <div class="text-xs text-gray-600">
                  Showing {{ getTimelinePageStart() }}-{{ getTimelinePageEnd() }} / {{ timelineWarehouses.length }}
                </div>
                <div class="flex items-center gap-2">
                  <button
                    (click)="goToTimelinePreviousPage()"
                    [disabled]="timelineCurrentPage === 1"
                    class="px-2 py-1 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                    Previous
                  </button>
                  <span class="text-xs text-gray-700 font-medium">
                    {{ timelineCurrentPage }} / {{ timelineTotalPages }}
                  </span>
                  <button
                    (click)="goToTimelineNextPage()"
                    [disabled]="timelineCurrentPage === timelineTotalPages"
                    class="px-2 py-1 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                    Next
                  </button>
                </div>
              </div>

              <!-- Empty Timeline State -->
              <div *ngIf="timelineWarehouses.length === 0" class="text-center py-6 text-gray-400">
                <svg class="w-10 h-10 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <p class="text-xs font-medium text-gray-500">No warehouse selected</p>
                <p class="text-xs text-gray-400 mt-0.5">Select region and warehouse to add to the list</p>
              </div>
            </div>
          </div>
        </div>

          <!-- Right Column: Content Area with all UI (default render even without data) -->
        <div class="flex-1 min-w-0 h-full overflow-y-auto">
          <!-- Content View - Default Display Demand, or selected dataset -->
          <div *ngIf="selectedDatasetId === 'demand'" class="w-full h-full bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden flex flex-col">
        <!-- Header: Volume Management -->
        <div class="bg-gray-50 border-b border-gray-200 px-6 py-4 flex-shrink-0">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-bold text-gray-900 flex items-center gap-2">
              <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
              </svg>
              <span>Volume Management</span>
            </h2>
          </div>
        </div>

        <!-- Content Area: Dataset Demand View -->
        <div class="flex-1 overflow-y-auto bg-white">
          <!-- Loading State for Demands -->
          <div *ngIf="loadingDemands" class="flex items-center justify-center py-20">
            <div class="text-center">
              <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-400 mx-auto mb-4"></div>
              <span class="text-sm text-gray-600 font-medium">Loading demand data...</span>
            </div>
          </div>

          <!-- Error State for Demands -->
          <div *ngIf="demandsError && !loadingDemands" class="bg-red-50 border-2 border-red-200 rounded-xl p-5 mb-6 shadow-sm mx-6 mt-6">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center flex-shrink-0">
                <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
              <div>
                <h4 class="text-red-800 font-bold mb-1">Data loading error</h4>
                <span class="text-red-700">{{ demandsError }}</span>
              </div>
            </div>
          </div>

          <!-- Summary Statistics Cards - Always render -->
          <div class="px-6 pt-6 pb-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <!-- Total Pick/Deliver Card -->
              <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-5 hover:shadow-md transition-all duration-200">
                <div class="flex items-center justify-between mb-4">
                  <div class="w-12 h-12 rounded-lg bg-orange-500 flex items-center justify-center shadow-sm">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                  </div>
                </div>
                <div class="text-3xl font-bold text-gray-900 mb-1">{{ totalPickAndDeliver | number }}</div>
                <div class="text-gray-600 text-sm font-medium">Total Pick/Deliver</div>
              </div>
              <!-- Total Pick Card -->
              <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-5 hover:shadow-md transition-all duration-200">
                <div class="flex items-center justify-between mb-4">
                  <div class="w-12 h-12 rounded-lg bg-orange-500 flex items-center justify-center shadow-sm">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                    </svg>
                  </div>
                </div>
                <div class="text-3xl font-bold text-gray-900 mb-1">{{ totalPick | number }}</div>
                <div class="text-gray-600 text-sm font-medium">Total Pick</div>
              </div>
              <!-- Total Deliver Card -->
              <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-5 hover:shadow-md transition-all duration-200">
                <div class="flex items-center justify-between mb-4">
                  <div class="w-12 h-12 rounded-lg bg-orange-500 flex items-center justify-center shadow-sm">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                    </svg>
                  </div>
                </div>
                <div class="text-3xl font-bold text-gray-900 mb-1">{{ totalDeliver | number }}</div>
                <div class="text-gray-600 text-sm font-medium">Total Deliver</div>
              </div>
            </div>
          </div>

          <!-- Timeline Area Chart Section - Always render -->
          <div class="mb-6 px-6">
            <div>
              <!-- Header Section -->
              <div class="bg-gray-50 border-b border-gray-200 p-6">
                <div class="flex items-center gap-4">
                  <div class="w-14 h-14 rounded-xl bg-orange-500 flex items-center justify-center shadow-sm">
                    <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                  </div>
                  <div>
                    <h3 class="text-2xl font-bold mb-1 text-gray-900">Volume Trend Over Time</h3>
                    <p class="text-gray-600 text-sm">Daily Volume - Total picked and delivered volume for the selected date range (based on Information time)</p>
                  </div>
                </div>
              </div>
              <div class="p-6">
                <!-- Loading State -->
                <div *ngIf="loadingTimelineData" class="bg-orange-50 border-2 border-orange-200 rounded-lg p-8 text-center">
                  <div class="flex items-center justify-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500 mr-3"></div>
                    <span class="text-sm text-gray-600 font-medium">Loading timeline data...</span>
                  </div>
                </div>

                <!-- Error State -->
                <div *ngIf="!loadingTimelineData && timelineDataError" class="bg-red-50 border-2 border-red-200 rounded-lg p-4 text-center">
                  <p class="text-sm text-red-600">{{ timelineDataError }}</p>
                </div>

                <!-- Controls - Show when data is loaded -->
                <div *ngIf="!loadingTimelineData && !timelineDataError && hasTimelineData" class="mb-4 space-y-4">
                  <!-- Chart Type Selector -->
                  <div class="flex items-center gap-4">
                    <label class="text-sm font-semibold text-gray-700">Chart Type:</label>
                    <div class="flex gap-2">
                      <button 
                        (click)="timelineChartType = 'column'; updateTimelineChart()" 
                        [ngClass]="{'bg-orange-600 text-white': timelineChartType === 'column', 'bg-gray-200 text-gray-700 hover:bg-gray-300': timelineChartType !== 'column'}"
                        class="px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                        Bar
                      </button>
                      <button 
                        (click)="timelineChartType = 'line'; updateTimelineChart()" 
                        [ngClass]="{'bg-orange-600 text-white': timelineChartType === 'line', 'bg-gray-200 text-gray-700 hover:bg-gray-300': timelineChartType !== 'line'}"
                        class="px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                        Line
                      </button>
                    </div>
                  </div>

                  <!-- Average Line Toggle -->
                  <div class="flex items-center gap-2">
                    <input 
                      type="checkbox" 
                      id="showTimelineAverage"
                      [(ngModel)]="showTimelineAverage" 
                      (change)="updateTimelineChart()"
                      class="w-4 h-4 text-orange-600 rounded focus:ring-2 focus:ring-orange-300">
                    <label for="showTimelineAverage" class="text-sm text-gray-700 cursor-pointer">
                      Show average line
                    </label>
                  </div>

                </div>

                <!-- Chart Container - Always show when not loading and no error -->
                <div *ngIf="!loadingTimelineData && !timelineDataError" class="bg-gradient-to-br from-white to-orange-50 border-2 border-orange-200 rounded-xl p-6 shadow-sm mb-4">
                  <div class="flex items-center justify-center" style="height: 400px; position: relative;">
                    <canvas #demandTimelineAreaCanvas 
                            style="display: block !important; max-width: 100% !important; max-height: 100% !important; height: 400px !important; width: 100% !important;"></canvas>
                  </div>
                  <!-- Show message if no data -->
                  <div *ngIf="!hasTimelineData" class="mt-4 text-center">
                    <p class="text-sm text-gray-500 italic">No data to display</p>
                  </div>
                </div>

                <!-- Warehouse Selection Table - Below Chart -->
                <div *ngIf="!loadingTimelineData && !timelineDataError && availableTimelineWarehouses.length > 1" class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden">
                  <div class="bg-orange-50 border-b border-orange-200 px-4 py-3 flex items-center justify-between">
                    <label class="text-sm font-semibold text-gray-700">
                      Select Warehouses ({{ selectedTimelineWarehouseIds.length === 0 ? 'All' : selectedTimelineWarehouseIds.length + ' selected' }})
                    </label>
                    <div class="flex gap-2">
                      <button 
                        (click)="selectAllTimelineWarehouses()"
                        class="px-3 py-1 text-xs bg-orange-100 text-orange-700 rounded hover:bg-orange-200 transition-colors">
                        Select all
                      </button>
                      <button 
                        (click)="deselectAllTimelineWarehouses()"
                        class="px-3 py-1 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition-colors">
                        Clear selection
                      </button>
                    </div>
                  </div>
                  <div class="overflow-x-auto">
                    <table class="w-full">
                      <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                          <th class="px-4 py-2 text-left w-12">
                            <input 
                              type="checkbox" 
                              [checked]="selectedTimelineWarehouseIds.length === availableTimelineWarehouses.length && availableTimelineWarehouses.length > 0"
                              (change)="selectedTimelineWarehouseIds.length === availableTimelineWarehouses.length ? deselectAllTimelineWarehouses() : selectAllTimelineWarehouses()"
                              class="w-4 h-4 text-orange-600 border-gray-400 rounded focus:ring-2 focus:ring-orange-500 cursor-pointer">
                          </th>
                          <th class="px-4 py-2 text-left text-xs font-bold text-gray-700 uppercase">Warehouse Name</th>
                          <th class="px-4 py-2 text-left text-xs font-bold text-gray-700 uppercase w-24">ID</th>
                        </tr>
                      </thead>
                      <tbody class="divide-y divide-gray-200">
                        <tr *ngFor="let warehouse of paginatedAvailableTimelineWarehouses" 
                            class="hover:bg-orange-50 transition-colors cursor-pointer"
                            (click)="toggleTimelineWarehouse(toString(warehouse.warehouse_id || warehouse.id))">
                          <td class="px-4 py-3" (click)="$event.stopPropagation()">
                            <input 
                              type="checkbox" 
                              [checked]="selectedTimelineWarehouseIds.length === 0 || selectedTimelineWarehouseIds.includes(toString(warehouse.warehouse_id || warehouse.id))"
                              (change)="toggleTimelineWarehouse(toString(warehouse.warehouse_id || warehouse.id))"
                              class="w-4 h-4 text-orange-600 rounded focus:ring-2 focus:ring-orange-300 cursor-pointer">
                          </td>
                          <td class="px-4 py-3 text-sm text-gray-900 font-medium">{{ warehouse.warehouse_name }}</td>
                          <td class="px-4 py-3 text-xs text-gray-500">{{ warehouse.warehouse_id }}</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  
                  <!-- Pagination Controls -->
                  <div *ngIf="timelineWarehouseTotalPages > 1" class="bg-gray-50 border-t border-gray-200 px-4 py-3 flex items-center justify-between">
                    <div class="text-sm text-gray-700">
                      Showing <span class="font-semibold">{{ getTimelineWarehousePageStart() }}</span> to                       <span class="font-semibold">{{ getTimelineWarehousePageEnd() }}</span> in total 
                      <span class="font-semibold">{{ availableTimelineWarehouses.length }}</span> warehouses
                    </div>
                    <div class="flex items-center gap-2">
                      <button 
                        (click)="goToTimelineWarehousePreviousPage()"
                        [disabled]="timelineWarehouseCurrentPage === 1"
                        [ngClass]="{
                          'bg-orange-100 text-orange-700 hover:bg-orange-200 cursor-pointer': timelineWarehouseCurrentPage > 1,
                          'bg-gray-100 text-gray-400 cursor-not-allowed': timelineWarehouseCurrentPage === 1
                        }"
                        class="px-3 py-1 text-xs rounded transition-colors">
                        Previous
                      </button>
                      <span class="text-sm text-gray-700">
                        Page <span class="font-semibold">{{ timelineWarehouseCurrentPage }}</span> / 
                        <span class="font-semibold">{{ timelineWarehouseTotalPages }}</span>
                      </span>
                      <button 
                        (click)="goToTimelineWarehouseNextPage()"
                        [disabled]="timelineWarehouseCurrentPage === timelineWarehouseTotalPages"
                        [ngClass]="{
                          'bg-orange-100 text-orange-700 hover:bg-orange-200 cursor-pointer': timelineWarehouseCurrentPage < timelineWarehouseTotalPages,
                          'bg-gray-100 text-gray-400 cursor-not-allowed': timelineWarehouseCurrentPage === timelineWarehouseTotalPages
                        }"
                        class="px-3 py-1 text-xs rounded transition-colors">
                        Next
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Region Analysis Section V2 - Moved outside "Volume Analysis" -->
          <div *ngIf="!selectedDatasetId || selectedDatasetId === 'demand'" class="mb-6 px-6 pt-6">
            <div>
              <!-- Header Section - Consistent with "Volume Chart by Warehouse" -->
              <div class="bg-gray-50 border-b border-gray-200 p-6">
                <div class="flex items-center gap-4">
                  <div class="w-14 h-14 rounded-xl bg-orange-500 flex items-center justify-center shadow-sm">
                    <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                  </div>
                  <div>
                    <h3 class="text-2xl font-bold mb-1 text-gray-900">Shift-based Volume Analysis</h3>
                    <p class="text-gray-600 text-sm">Analyze volume distribution by shift and time window</p>
                  </div>
                </div>
              </div>
              <div class="p-6">
                <!-- Loading State -->
                <div *ngIf="loadingShiftRatio" class="bg-orange-50 border-2 border-orange-200 rounded-lg p-8 text-center">
                  <div class="flex items-center justify-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500 mr-3"></div>
                    <span class="text-sm text-gray-600 font-medium">Loading shift ratio data...</span>
                  </div>
                </div>


                <!-- Empty/Error State - Always show when no data or error -->
                <div *ngIf="!loadingShiftRatio && (shiftRatioError || !shiftRatios || shiftRatios.length === 0)" class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-8 text-center mb-8">
                  <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                  <h3 class="text-lg font-medium text-gray-900 mb-2">No data</h3>
                  <p class="text-gray-500" *ngIf="shiftRatioError">{{ shiftRatioError }}</p>
                  <p class="text-gray-500" *ngIf="!shiftRatioError">No regional analysis data found</p>
                </div>

                <!-- Shift Ratios Table -->
                <div *ngIf="!loadingShiftRatio" class="mb-8">
                  <h4 class="text-md font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Shift Volume Ratio Table
                  </h4>
                  <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                      <thead class="bg-gradient-to-r from-orange-50 to-orange-100">
                        <tr>
                          <th class="px-4 py-3 text-left text-xs font-bold text-orange-800 uppercase tracking-wider border-b border-gray-200">Shift</th>
                          <th class="px-4 py-3 text-center text-xs font-bold text-orange-800 uppercase tracking-wider border-b border-gray-200">Time Slot</th>
                          <th class="px-4 py-3 text-right text-xs font-bold text-orange-800 uppercase tracking-wider border-b border-gray-200">Pick Ratio (%)</th>
                          <th class="px-4 py-3 text-right text-xs font-bold text-orange-800 uppercase tracking-wider border-b border-gray-200">Deliver Ratio (%)</th>
                        </tr>
                      </thead>
                      <tbody class="divide-y divide-gray-200">
                        <tr *ngIf="!shiftRatios || shiftRatios.length === 0" class="hover:bg-gray-50">
                          <td colspan="4" class="px-4 py-8 text-center text-sm text-gray-500">
                            No data
                          </td>
                        </tr>
                        <tr *ngFor="let ratio of shiftRatios; let i = index" class="hover:bg-orange-50 transition-colors">
                          <td class="px-4 py-3 whitespace-nowrap">
                            <div class="flex items-center">
                              <div class="w-8 h-8 rounded-full bg-orange-100 flex items-center justify-center mr-3">
                                <span class="text-xs font-bold text-orange-700">{{ i + 1 }}</span>
                              </div>
                              <div>
                                <div class="text-sm font-semibold text-gray-900">{{ ratio.shift_name || ratio.shift?.name || shifts[i]?.name || 'Shift ' + (i+1) }}</div>
                              </div>
                            </div>
                          </td>
                          <td class="px-4 py-3 text-center whitespace-nowrap">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-orange-100 text-orange-700">
                              {{ (ratio.shift?.start_hour !== undefined ? ratio.shift.start_hour : shifts[i]?.start_hour || 0) }}:00 - {{ (ratio.shift?.end_hour !== undefined ? ratio.shift.end_hour : shifts[i]?.end_hour || 0) }}:00
                            </span>
                          </td>
                          <td class="px-4 py-3 text-right whitespace-nowrap">
                            <div class="flex items-center justify-end gap-2">
                              <span class="text-sm font-semibold text-orange-800">{{ ((ratio.pick_ratio || 0) * 100).toFixed(1) }}%</span>
                              <div class="w-24 h-2 bg-gray-200 rounded-full overflow-hidden">
                                <div class="h-full bg-orange-600 rounded-full transition-all" [style.width.%]="(ratio.pick_ratio || 0) * 100"></div>
                              </div>
                            </div>
                          </td>
                          <td class="px-4 py-3 text-right whitespace-nowrap">
                            <div class="flex items-center justify-end gap-2">
                              <span class="text-sm font-semibold text-gray-800">{{ ((ratio.deliver_ratio || 0) * 100).toFixed(1) }}%</span>
                              <div class="w-24 h-2 bg-gray-200 rounded-full overflow-hidden">
                                <div class="h-full bg-gray-800 rounded-full transition-all" [style.width.%]="(ratio.deliver_ratio || 0) * 100"></div>
                              </div>
                            </div>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <!-- Time Distribution Charts -->
                <div *ngIf="!loadingShiftRatio && shiftRatios && shiftRatios.length > 0" class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
                  <!-- Pickup Time Distribution Chart -->
                  <div class="bg-gradient-to-br from-orange-50 to-white border-2 border-orange-200 rounded-xl p-6 shadow-sm">
                    <div class="flex items-center gap-3 mb-4">
                      <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-orange-500 to-orange-600 flex items-center justify-center shadow-md">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                      </div>
                      <div>
                        <h5 class="text-lg font-bold text-gray-900">Pick Distribution by Shift</h5>
                        <p class="text-xs text-gray-600">Total pick volume by shift</p>
                      </div>
                    </div>
                    <div class="flex items-center justify-center" style="height: 500px; position: relative;">
                      <canvas #demandPickupTimeCanvas 
                              [style.display]="(!shiftRatios || shiftRatios.length === 0) ? 'none' : 'block'"
                              style="display: block !important; max-width: 100% !important; max-height: 100% !important; height: 500px !important; width: 500px !important;"></canvas>
                    </div>
                  </div>

                  <!-- Delivery Time Distribution Chart -->
                  <div class="bg-gradient-to-br from-gray-50 to-white border-2 border-gray-200 rounded-xl p-6 shadow-sm">
                    <div class="flex items-center gap-3 mb-4">
                      <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-gray-600 to-gray-700 flex items-center justify-center shadow-md">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                      </div>
                      <div>
                        <h5 class="text-lg font-bold text-gray-900">Deliver Distribution by Shift</h5>
                        <p class="text-xs text-gray-600">Total deliver volume by shift</p>
                      </div>
                    </div>
                    <div class="flex items-center justify-center" style="height: 500px; position: relative;">
                      <canvas #demandDeliveryTimeCanvas 
                              [style.display]="(!shiftRatios || shiftRatios.length === 0) ? 'none' : 'block'"
                              style="display: block !important; max-width: 100% !important; max-height: 100% !important; height: 500px !important; width: 500px !important;"></canvas>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Bar Chart Section - Always render -->
          <div class="mb-6 px-6">
            <div>
              <!-- Modern Header -->
              <div class="bg-gray-50 border-b border-gray-200 p-6">
                <div class="flex items-center justify-between mb-6">
                  <div class="flex items-center gap-4">
                    <div class="w-14 h-14 rounded-xl bg-orange-500 flex items-center justify-center shadow-sm">
                      <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                      </svg>
                    </div>
                    <div>
                      <h3 class="text-2xl font-bold mb-1 text-gray-900">Volume Chart by Warehouse</h3>
                      <p class="text-gray-600 text-sm">Analyze and compare volume across warehouses</p>
                    </div>
                  </div>
                  <!-- Chart Type Selector -->
                  <div class="flex items-center gap-2 bg-gray-100 rounded-lg p-1 border border-gray-200">
                    <button 
                      (click)="chartType = 'bar'; triggerChangeDetection()" 
                      [ngClass]="{'bg-orange-500 text-white shadow-sm': chartType === 'bar', 'text-gray-600 hover:bg-gray-200': chartType !== 'bar'}"
                      class="px-4 py-2 rounded-md text-sm font-semibold transition-all duration-200">
                      <svg class="w-4 h-4 inline mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                      </svg>
                      Bar
                    </button>
                    <button 
                      (click)="chartType = 'line'; triggerChangeDetection()" 
                      [ngClass]="{'bg-orange-500 text-white shadow-sm': chartType === 'line', 'text-gray-600 hover:bg-gray-200': chartType !== 'line'}"
                      class="px-4 py-2 rounded-md text-sm font-semibold transition-all duration-200">
                      <svg class="w-4 h-4 inline mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                      </svg>
                      Line
                    </button>
                  </div>
                </div>
                
                <!-- Enhanced Chart Toggle Controls -->
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                  <div class="flex items-center gap-2 mb-3">
                    <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                    </svg>
                    <span class="text-sm font-semibold text-gray-700">Showing data:</span>
                  </div>
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <label class="flex items-center gap-2.5 cursor-pointer group bg-white hover:bg-orange-50 rounded-lg p-3 transition-all border border-gray-200 hover:border-orange-200">
                      <input type="checkbox" [(ngModel)]="chartShowPick" (change)="triggerChangeDetection()" class="w-4 h-4 text-orange-500 rounded focus:ring-2 focus:ring-orange-300">
                      <div class="flex items-center gap-2 flex-1">
                        <div class="w-3 h-3 rounded-full bg-orange-500 shadow-sm"></div>
                        <span class="text-sm font-medium text-gray-700">Total Pick</span>
                      </div>
                    </label>
                    <label class="flex items-center gap-2.5 cursor-pointer group bg-white hover:bg-orange-50 rounded-lg p-3 transition-all border border-gray-200 hover:border-orange-200">
                      <input type="checkbox" [(ngModel)]="chartShowDeliver" (change)="triggerChangeDetection()" class="w-4 h-4 text-orange-500 rounded focus:ring-2 focus:ring-orange-300">
                      <div class="flex items-center gap-2 flex-1">
                        <div class="w-3 h-3 rounded-full bg-orange-500 shadow-sm"></div>
                        <span class="text-sm font-medium text-gray-700">Total Deliver</span>
                      </div>
                    </label>
                    <label class="flex items-center gap-2.5 cursor-pointer group bg-white hover:bg-orange-50 rounded-lg p-3 transition-all border border-gray-200 hover:border-orange-200">
                      <input type="checkbox" [(ngModel)]="chartShowAvgPick" (change)="triggerChangeDetection()" class="w-4 h-4 text-orange-500 rounded focus:ring-2 focus:ring-orange-300">
                      <div class="flex items-center gap-2 flex-1">
                        <div class="w-3 h-3 rounded-full bg-orange-500 shadow-sm"></div>
                        <span class="text-sm font-medium text-gray-700">Avg Pick/Day</span>
                      </div>
                    </label>
                    <label class="flex items-center gap-2.5 cursor-pointer group bg-white hover:bg-orange-50 rounded-lg p-3 transition-all border border-gray-200 hover:border-orange-200">
                      <input type="checkbox" [(ngModel)]="chartShowAvgDeliver" (change)="triggerChangeDetection()" class="w-4 h-4 text-orange-500 rounded focus:ring-2 focus:ring-orange-300">
                      <div class="flex items-center gap-2 flex-1">
                        <div class="w-3 h-3 rounded-full bg-orange-500 shadow-sm"></div>
                        <span class="text-sm font-medium text-gray-700">Avg Deliver/Day</span>
                      </div>
                    </label>
                  </div>
                </div>
              </div>

              <!-- Chart Container with Modern Design -->
              <div class="p-8 bg-gradient-to-br from-gray-50 via-white to-gray-50">
                <div class="w-full rounded-2xl border-2 border-gray-200 bg-white shadow-inner" 
                     [style.min-height.px]="getChartHeight()" 
                     [style.height.px]="getChartHeight()" 
                     style="position: relative; background: linear-gradient(to bottom, #ffffff 0%, #f9fafb 100%); padding: 2rem;">
                  <!-- Scrollable chart container -->
                  <div class="overflow-x-auto overflow-y-hidden" 
                       style="position: relative; padding-top: 1rem; height: 936px; width: 100%; -webkit-overflow-scrolling: touch; scrollbar-width: thin; scrollbar-color: rgba(156, 163, 175, 0.5) transparent;">
                    <div [ngStyle]="{'min-width': getChartMinWidth() > 100 ? getChartMinWidth() + 'px' : '100%'}" 
                         style="height: 936px; position: relative;">
                      <p-chart [type]="getChartType()" 
                               [data]="getDemandsChartData('combined')" 
                               [options]="chartOptions" 
                               style="display: block !important; width: 100% !important; height: 936px !important; min-height: 936px !important;"></p-chart>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Data Table Section - Always render -->
          <div class="mb-6 px-6">
            <div>
              <!-- Header Section - Consistent with "Region Analysis V2" -->
              <div class="bg-white border-b-2 border-orange-200 p-6">
                <div class="flex items-center gap-4 mb-4">
                  <div class="w-14 h-14 rounded-2xl bg-orange-500 flex items-center justify-center shadow-sm">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                      </svg>
                  </div>
                  <div class="flex-1">
                    <h3 class="text-2xl font-bold mb-1 text-gray-900">Warehouse Volume Details</h3>
                    <p class="text-gray-600 text-sm">Detailed analysis of picked and delivered volume by warehouse</p>
                  </div>
                </div>
                <!-- Color Legend and Summary Info -->
                <div class="flex items-center justify-between mt-4 pt-4 border-t border-orange-200">
                    <div class="flex items-center gap-3 text-xs">
                      <div class="flex items-center gap-1.5">
                        <div class="w-4 h-4 rounded bg-green-100 border border-green-300"></div>
                      <span class="text-gray-700">Above Avg</span>
                      </div>
                      <div class="flex items-center gap-1.5">
                        <div class="w-4 h-4 rounded bg-red-100 border border-red-300"></div>
                      <span class="text-gray-700">Below Avg</span>
                      </div>
                    </div>
                  <div class="text-sm text-gray-700 font-medium">
                    Total: <span class="text-orange-600 font-bold">{{ demands.length }}</span> warehouses
                    <span *ngIf="demandSearchQuery" class="ml-2 text-gray-600">
                        (Showing: <span class="font-bold text-orange-600">{{ filteredDemands.length }}</span>)
                      </span>
                  </div>
                </div>
              </div>

              <div class="p-6">
            <!-- Loading -->
            <div *ngIf="loadingDemands" class="flex items-center justify-center py-20">
              <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500 mx-auto mb-4"></div>
                <span class="text-sm text-gray-600 font-medium">Loading demand data...</span>
              </div>
            </div>

            <!-- Error -->
            <div *ngIf="demandsError && !loadingDemands" class="bg-red-50 border-2 border-red-200 rounded-xl p-5 mb-6 shadow-sm">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center flex-shrink-0">
                  <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                </div>
                <div>
                  <h4 class="text-red-800 font-bold mb-1">Data loading error</h4>
                  <span class="text-red-700">{{ demandsError }}</span>
                </div>
              </div>
            </div>

            <!-- No warehouses message -->
            <div *ngIf="!loadingDemands && !demandsError && timelineWarehouses.length === 0" class="bg-gradient-to-r from-orange-50 to-orange-100 border-2 border-orange-200 rounded-xl p-6 mb-6 shadow-sm">
              <div class="flex items-start gap-4">
                <div class="w-12 h-12 rounded-full bg-orange-500 flex items-center justify-center flex-shrink-0 shadow-sm">
                  <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                </div>
                <div>
                  <h4 class="text-orange-800 font-bold mb-1">No warehouses yet</h4>
                  <p class="text-orange-700">Please add warehouses to the timeline to view demand data.</p>
                </div>
              </div>
            </div>

                  <!-- Two column layout: Chart on left, Table on right -->
                  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Chart Column (Left) -->
                    <div class="lg:col-span-1 flex flex-col">
                      <!-- Pick/Deliver Ratio Chart -->
                      <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-6 flex-1 flex flex-col h-full">
                        <div class="flex items-center gap-3 mb-6">
                          <div class="w-10 h-10 rounded-lg bg-orange-500 flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path>
                            </svg>
                          </div>
                          <div>
                            <h5 class="text-lg font-semibold text-gray-900">Pick/Deliver Ratio</h5>
                            <p class="text-xs text-gray-500 mt-0.5">Volume distribution</p>
                          </div>
                        </div>
                        <div class="flex-1 flex items-center justify-center" style="min-height: 400px; position: relative;">
                          <div *ngIf="!selectedDemand && (!demands || demands.length === 0)" class="text-center text-gray-400">
                            <svg class="w-16 h-16 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            <p class="text-sm">Select warehouses to view details</p>
                          </div>
                          <canvas #demandSummaryCanvas [style.display]="(!selectedDemand && (!demands || demands.length === 0)) ? 'none' : 'block'" style="max-width: 100%; max-height: 100%;"></canvas>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Table Column (Right) -->
                    <div class="lg:col-span-1">
                      <div class="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
                  <p-table [value]="filteredDemands" [paginator]="true" [rows]="10" [showCurrentPageReport]="true"
                           currentPageReportTemplate="Showing {first} to {last} of {totalRecords} warehouses"
                           [rowsPerPageOptions]="[5,10,25,50]"
                           styleClass="p-datatable-striped"
                                 [tableStyle]="{'min-width': '100%'}">
                    <ng-template pTemplate="header">
                      <tr class="bg-white border-b-2 border-orange-200">
                        <th class="text-left font-semibold text-orange-600 py-4 px-6 border-b border-orange-200">
                          <button (click)="sortDemands('warehouse_name')" class="flex items-center gap-2 hover:text-orange-100 transition-colors text-white">
                            Warehouse
                            <svg *ngIf="demandSortField === 'warehouse_name'" class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet">
                              <path *ngIf="demandSortOrder === 'asc'" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                              <path *ngIf="demandSortOrder === 'desc'" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                          </button>
                        </th>
                        <th class="text-right font-semibold text-orange-600 py-4 px-6 border-b border-orange-200">
                          <button (click)="sortDemands('total_pick')" class="flex items-center justify-end gap-2 hover:text-orange-700 transition-colors w-full text-orange-600">
                            Total Pick
                            <svg *ngIf="demandSortField === 'total_pick'" class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet">
                              <path *ngIf="demandSortOrder === 'asc'" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                              <path *ngIf="demandSortOrder === 'desc'" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                          </button>
                        </th>
                        <th class="text-right font-semibold text-orange-600 py-4 px-6 border-b border-orange-200">
                          <button (click)="sortDemands('total_deliver')" class="flex items-center justify-end gap-2 hover:text-orange-700 transition-colors w-full text-orange-600">
                            Total Deliver
                            <svg *ngIf="demandSortField === 'total_deliver'" class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet">
                              <path *ngIf="demandSortOrder === 'asc'" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                              <path *ngIf="demandSortOrder === 'desc'" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                          </button>
                        </th>
                        <th class="text-right font-semibold text-orange-600 py-4 px-6 border-b border-orange-200">
                          <button (click)="sortDemands('avg_pick_per_day')" class="flex items-center justify-end gap-2 hover:text-orange-700 transition-colors w-full text-orange-600">
                            Avg Pick/Day
                            <svg *ngIf="demandSortField === 'avg_pick_per_day'" class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet">
                              <path *ngIf="demandSortOrder === 'asc'" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                              <path *ngIf="demandSortOrder === 'desc'" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                          </button>
                        </th>
                        <th class="text-right font-semibold text-orange-600 py-4 px-6 border-b border-orange-200">
                          <button (click)="sortDemands('avg_deliver_per_day')" class="flex items-center justify-end gap-2 hover:text-orange-700 transition-colors w-full text-orange-600">
                            Avg Deliver/Day
                            <svg *ngIf="demandSortField === 'avg_deliver_per_day'" class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet">
                              <path *ngIf="demandSortOrder === 'asc'" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                              <path *ngIf="demandSortOrder === 'desc'" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                          </button>
                        </th>
                      </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-demand>
                      <tr (click)="selectDemand(demand)" 
                          [ngClass]="{
                            'bg-orange-50': isDemandSelected(demand),
                            'hover:bg-gray-50': !isDemandSelected(demand)
                          }"
                          class="cursor-pointer transition-colors border-b border-gray-100">
                        <td class="py-4 px-6">
                          <div>
                            <div class="text-gray-900 font-medium text-sm">{{ demand.warehouse_name || 'â€”' }}</div>
                            <div class="text-xs text-gray-500 mt-0.5">ID: {{ demand.warehouse_id }}</div>
                          </div>
                        </td>
                      <td class="text-right py-4 px-6 text-gray-700 font-medium">
                        {{ demand.total_pick | number }}
                      </td>
                      <td class="text-right py-4 px-6 text-gray-700 font-medium">
                        {{ demand.total_deliver | number }}
                      </td>
                      <td class="text-right py-4 px-6 text-orange-600 font-medium">
                          {{ demand.avg_pick_per_day | number:'1.1-1' }}
                      </td>
                      <td class="text-right py-4 px-6 text-orange-600 font-medium">
                          {{ demand.avg_deliver_per_day | number:'1.1-1' }}
                      </td>
                      </tr>
                    </ng-template>
                    <ng-template pTemplate="emptymessage">
                      <tr>
                        <td colspan="5" class="text-center py-12">
                          <div class="flex flex-col items-center gap-3">
                            <svg class="w-16 h-16 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="text-gray-500 font-medium">
                              <span *ngIf="demandSearchQuery">No results for "{{ demandSearchQuery }}"</span>
                              <span *ngIf="!demandSearchQuery">No data</span>
                            </div>
                            <button 
                              *ngIf="demandSearchQuery"
                              (click)="clearSearch()"
                              class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors text-sm font-medium"
                            >
                              Clear filter
                            </button>
                          </div>
                        </td>
                      </tr>
                    </ng-template>
                  </p-table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Dataset Detail Component (for non-demand datasets) -->
      <div *ngIf="selectedDatasetId && selectedDatasetId !== 'demand'" class="w-full h-full bg-white rounded-xl shadow-xl border-2 border-gray-200 overflow-hidden flex flex-col">
        <!-- Header with Close Button -->
        <div class="bg-white border-b-2 border-orange-200 px-6 py-4 flex-shrink-0 flex items-center justify-between">
          <h2 class="text-lg font-bold text-gray-900 flex items-center gap-2">
            <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
            </svg>
            <span>Dataset Details</span>
          </h2>
          <button (click)="closeDetails()" class="bg-white hover:bg-gray-50 text-gray-700 border-2 border-gray-200 rounded-lg px-4 py-2 shadow-sm flex items-center gap-2 transition-all hover:shadow-md hover:border-gray-300">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            <span class="text-sm font-semibold">Close</span>
          </button>
        </div>
        <div class="flex-1 overflow-y-auto">
          <app-dataset-detail [datasetIdInput]="selectedDatasetId" [embedded]="true"></app-dataset-detail>
        </div>
      </div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div *ngIf="showSettingsModal" class="fixed inset-0 z-[3000] bg-black/40 backdrop-blur-sm flex items-center justify-center px-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden">
      <div class="flex items-center justify-between px-6 py-4 border-b-2 border-orange-200 bg-white">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl bg-orange-500 flex items-center justify-center shadow-sm">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5h2m-1-2v4m-7 4h2m-1-2v4m11-2h2m-1-2v4m-7 4h2m-1-2v4M4 4l16 16"></path>
            </svg>
          </div>
          <div>
            <h3 class="text-lg font-bold text-orange-600">Information</h3>
            <p class="text-sm text-gray-600">Select time range and configure shifts</p>
          </div>
        </div>
        <button (click)="closeSettingsModal()" class="p-2 rounded-lg bg-orange-50 hover:bg-orange-100 text-orange-600 transition border border-orange-200">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <div class="p-6 overflow-y-auto max-h-[70vh] space-y-6">
        <!-- Region and Warehouse Selection -->
        <div class="bg-gray-50 rounded-xl border border-gray-200 p-5">
          <div class="flex items-center gap-2 mb-4">
            <div class="w-9 h-9 rounded-lg bg-orange-500 flex items-center justify-center shadow-sm">
              <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
              </svg>
            </div>
            <h4 class="text-base font-bold text-gray-900">Select region and warehouses</h4>
          </div>
          <div class="space-y-4">
            <!-- Region Selector -->
            <div>
              <label class="text-sm font-semibold text-gray-700 mb-2 block">Region <span class="text-red-500">*</span></label>
              <select
                [(ngModel)]="modalSelectedRegion"
                (change)="onModalRegionChange()"
                class="w-full border-2 border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-medium">
                <option value="" disabled>-- Select region --</option>
                <option *ngFor="let region of availableRegions" [value]="region.code">
                  {{ region.code }} - {{ region.name }}
                </option>
              </select>
            </div>

            <!-- Warehouses List -->
            <div *ngIf="modalSelectedRegion" class="space-y-3">
              <!-- Loading State -->
              <div *ngIf="loadingModalWarehouses" class="flex items-center justify-center py-8 bg-white rounded-lg border border-gray-200">
                <div class="text-center">
                  <div class="animate-spin rounded-full h-8 w-8 border-3 border-orange-500 border-t-transparent mx-auto mb-2"></div>
                  <p class="text-sm font-medium text-gray-600">Loading warehouse list...</p>
                </div>
              </div>

              <!-- Error State -->
              <div *ngIf="modalWarehousesError && !loadingModalWarehouses" class="bg-red-50 border-2 border-red-200 rounded-lg p-4">
                <div class="flex items-center gap-2">
                  <svg class="w-5 h-5 text-red-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <span class="text-sm text-red-700">{{ modalWarehousesError }}</span>
                </div>
              </div>

              <!-- Action Bar -->
              <div *ngIf="!loadingModalWarehouses && !modalWarehousesError && modalWarehouses.length > 0" class="flex items-center justify-between bg-gradient-to-r from-gray-50 to-gray-50/50 rounded-lg px-4 py-2.5 border-2 border-gray-200">
                <div class="flex items-center gap-3">
                  <div class="text-xs font-semibold text-gray-700">
                    Total: <span class="text-gray-900 font-bold">{{ modalWarehouses.length }}</span>
                  </div>
                  <div class="w-px h-4 bg-gray-300"></div>
                  <div class="text-xs font-semibold text-orange-600">
                    Selected: <span class="text-orange-700 font-bold">{{ modalSelectedWarehouses.size }}</span>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <button
                    type="button"
                    (click)="selectAllWarehousesInModal()"
                    [disabled]="modalSelectedWarehouses.size === modalWarehouses.length"
                    class="px-3 py-1.5 text-xs font-bold bg-green-500 hover:bg-green-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white rounded-lg transition-all shadow-sm">
                    âœ“ All
                  </button>
                  <button
                    type="button"
                    (click)="deselectAllWarehousesInModal()"
                    [disabled]="modalSelectedWarehouses.size === 0"
                    class="px-3 py-1.5 text-xs font-bold bg-red-500 hover:bg-red-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white rounded-lg transition-all shadow-sm">
                    âœ• Clear selection
                  </button>
                </div>
              </div>

              <!-- Warehouses List (Scrollable) -->
              <div *ngIf="!loadingModalWarehouses && !modalWarehousesError && modalWarehouses.length > 0" class="border-2 border-gray-200 rounded-xl overflow-hidden bg-white shadow-sm max-h-[400px] overflow-y-auto">
                <table class="w-full">
                  <thead class="bg-gradient-to-r from-gray-100 to-gray-50 sticky top-0 z-10 border-b-2 border-gray-200">
                    <tr>
                      <th class="px-3 py-2.5 text-left w-12">
                        <input
                          type="checkbox"
                          [checked]="modalSelectedWarehouses.size === modalWarehouses.length && modalWarehouses.length > 0"
                          (change)="modalSelectedWarehouses.size === modalWarehouses.length ? deselectAllWarehousesInModal() : selectAllWarehousesInModal()"
                          class="w-4 h-4 text-orange-600 border-gray-400 rounded focus:ring-2 focus:ring-orange-500 cursor-pointer">
                      </th>
                      <th class="px-3 py-2.5 text-left text-xs font-bold text-gray-700 uppercase w-12">STT</th>
                      <th class="px-3 py-2.5 text-left text-xs font-bold text-gray-700 uppercase">Warehouse Name</th>
                      <th class="px-3 py-2.5 text-left text-xs font-bold text-gray-700 uppercase">Address</th>
                      <th class="px-3 py-2.5 text-left text-xs font-bold text-gray-700 uppercase w-20">ID</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-150">
                    <tr *ngFor="let warehouse of modalWarehouses; let i = index"
                        class="hover:bg-orange-50/50 transition-colors cursor-pointer border-b border-gray-100"
                        (click)="toggleWarehouseSelection(warehouse)">
                      <td class="px-3 py-2.5" (click)="$event.stopPropagation()">
                        <input
                          type="checkbox"
                          [checked]="isWarehouseSelectedInModal(warehouse)"
                          (change)="toggleWarehouseSelection(warehouse)"
                          class="w-4 h-4 text-orange-600 border-gray-400 rounded focus:ring-2 focus:ring-orange-500 cursor-pointer">
                      </td>
                      <td class="px-3 py-2.5 text-sm font-bold text-gray-700">{{ i + 1 }}</td>
                      <td class="px-3 py-2.5">
                        <div class="font-semibold text-gray-900 text-sm">{{ warehouse.warehouse_name }}</div>
                      </td>
                      <td class="px-3 py-2.5">
                        <div class="text-xs text-gray-600">{{ warehouse.district_name }}, {{ warehouse.province_name }}</div>
                      </td>
                      <td class="px-3 py-2.5 text-xs text-gray-500 font-mono">{{ warehouse.warehouse_id || warehouse.id }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- Empty State -->
              <div *ngIf="!loadingModalWarehouses && !modalWarehousesError && modalWarehouses.length === 0" class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                <svg class="mx-auto h-10 w-10 text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                </svg>
                <p class="text-sm font-medium text-gray-500">No warehouses available</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Date Range -->
        <div class="bg-gray-50 rounded-xl border border-gray-200 p-5">
          <div class="flex items-center gap-2 mb-4">
            <div class="w-9 h-9 rounded-lg bg-orange-500 flex items-center justify-center shadow-sm">
              <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
            </div>
            <h4 class="text-base font-bold text-gray-900">Time Range</h4>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="text-sm font-semibold text-gray-700 mb-2 block">From date</label>
              <input type="date" [(ngModel)]="demandStartDate" (ngModelChange)="onDateRangeChange()" class="w-full border-2 border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-medium" />
            </div>
            <div>
              <label class="text-sm font-semibold text-gray-700 mb-2 block">To date</label>
              <input type="date" [(ngModel)]="demandEndDate" (ngModelChange)="onDateRangeChange()" class="w-full border-2 border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-medium" />
            </div>
          </div>
          <div *ngIf="demandErrors && demandErrors.length" class="mt-3 text-sm text-red-600 bg-red-50 border border-red-200 rounded-lg p-3">
            <div *ngFor="let err of demandErrors" class="flex items-center gap-2">
              <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              {{ err }}
            </div>
          </div>
        </div>

        <!-- Shift configuration -->
        <div class="bg-gray-50 rounded-xl border border-gray-200 p-5">
          <div class="flex items-center gap-2 mb-4">
            <div class="w-9 h-9 rounded-lg bg-orange-500 flex items-center justify-center shadow-sm">
              <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <h4 class="text-base font-bold text-gray-900">Shift configuration</h4>
          </div>
          <div class="space-y-3">
            <div *ngFor="let s of shifts; let i = index" class="flex items-center gap-3 p-4 bg-white rounded-xl border border-gray-200">
              <div class="w-8 h-8 rounded-full bg-gradient-to-br from-orange-400 to-orange-600 text-white flex items-center justify-center font-bold text-sm flex-shrink-0">
                {{ i + 1 }}
              </div>
              <input [(ngModel)]="s.name" class="border-2 border-gray-300 rounded-lg px-4 py-2 text-sm w-36 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-medium" placeholder="Shift Name" />
              <select [(ngModel)]="s.start_hour" class="border-2 border-gray-300 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-medium">
                <option *ngFor="let h of hours" [ngValue]="h">{{ h }}:00</option>
              </select>
              <span class="text-gray-500 font-semibold">â€”</span>
              <select [(ngModel)]="s.end_hour" class="border-2 border-gray-300 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-medium">
                <option *ngFor="let h of hoursInclusive" [ngValue]="h">{{ h }}:00</option>
              </select>
              <button class="ml-auto text-red-500 hover:bg-red-50 px-3 py-2 rounded-lg transition-colors font-medium" (click)="removeShift(i)" title="Delete ca">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            <button class="w-full px-4 py-3 bg-white border-2 border-dashed border-gray-300 rounded-xl hover:border-orange-400 hover:bg-orange-50 text-sm font-semibold text-gray-700 transition-all flex items-center justify-center gap-2" (click)="addShift()">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
              </svg>
              Add shift
            </button>
          </div>
          <div *ngIf="shiftErrors && shiftErrors.length" class="mt-3 text-sm text-red-600 bg-red-50 border border-red-200 rounded-lg p-3">
            <div *ngFor="let err of shiftErrors" class="flex items-center gap-2">
              <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              {{ err }}
            </div>
          </div>
        </div>
      </div>

      <div class="flex items-center justify-end gap-3 px-6 py-4 border-t border-gray-200 bg-gray-50">
        <button (click)="closeSettingsModal()" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 transition text-sm font-semibold">Cancel</button>
        <button (click)="applySettings()" class="px-5 py-2 rounded-lg bg-orange-600 text-white hover:bg-orange-700 transition shadow-md text-sm font-semibold">Save and apply</button>
      </div>
    </div>
  </div>

</div>
