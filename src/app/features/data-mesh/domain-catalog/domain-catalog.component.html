<!-- Domain Catalog - Clean & Simple UI -->
<p-toast></p-toast>

<div class="min-h-screen bg-slate-50">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <!-- Loading State -->
    <div *ngIf="loading" class="w-full">
      <app-loading 
        type="data-flow" 
        [message]="'common.loading' | translate" 
        size="large">
      </app-loading>
    </div>

    <!-- Main Content -->
    <div *ngIf="!loading" class="space-y-6">
      
      <!-- Header -->
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
          <h1 class="text-3xl font-bold text-slate-900">Domains</h1>
          <p class="text-slate-600 mt-1">Manage and explore your data domains</p>
        </div>
      </div>

      <!-- Search & Filters -->
      <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-4">
        <div class="flex flex-col sm:flex-row gap-3">
          <!-- Search -->
          <div class="flex-1">
            <div class="relative">
              <i class="pi pi-search absolute left-3 top-3 text-slate-400"></i>
              <input
                type="text"
                [(ngModel)]="searchTerm"
                (input)="onSearch()"
                placeholder="Search domains..."
                class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
          </div>

          <!-- Status Filter -->
          <div class="w-full sm:w-48">
            <p-dropdown 
              [(ngModel)]="filters.status"
              [options]="statusOptions"
              optionLabel="label"
              optionValue="value"
              (onChange)="onFilterChange()"
              placeholder="All Status"
              styleClass="w-full">
            </p-dropdown>
          </div>

          <!-- Clear Button -->
          <button
            (click)="clearFilters()"
            class="px-4 py-2 border border-slate-300 rounded-lg text-sm font-medium text-slate-700 bg-white hover:bg-slate-50 transition-colors">
            Clear
          </button>
        </div>
      </div>

      <!-- Domains Table -->
      <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
        
        <!-- Table Header with Count -->
        <div class="px-6 py-4 border-b border-slate-200 bg-slate-50">
          <p class="text-sm font-medium text-slate-700">
            {{ filteredDomains.length }} {{ filteredDomains.length === 1 ? 'domain' : 'domains' }} found
          </p>
        </div>

        <!-- Domains List -->
        <div *ngIf="filteredDomains.length > 0" class="divide-y divide-slate-200">
          <div *ngFor="let domain of filteredDomains; trackBy: trackByDomainKey"
               (click)="showDomainDetails(domain)"
               class="px-6 py-4 hover:bg-blue-50 transition-colors cursor-pointer group">
            <div class="flex items-center justify-between gap-4">
              <!-- Domain Info -->
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-3 mb-1">
                  <div class="h-10 w-10 rounded-lg bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center flex-shrink-0">
                    <i [class]="'pi ' + getDomainIcon(domain.domain_key) + ' text-white text-sm'"></i>
                  </div>
                  <div class="min-w-0">
                    <h3 class="text-sm font-semibold text-slate-900 truncate">
                      {{ domain.display_name || domain.name }}
                    </h3>
                    <p class="text-xs text-slate-500">{{ domain.domain_key }}</p>
                  </div>
                </div>
                <p class="text-sm text-slate-600 line-clamp-1 ml-13">
                  {{ domain.description || 'No description' }}
                </p>
              </div>

              <!-- Status Badge -->
              <div class="flex-shrink-0">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium"
                      [class]="getStatusClass(domain.status)">
                  {{ domain.status }}
                </span>
              </div>

              <!-- APIs Button -->
              <button
                (click)="$event.stopPropagation(); showDomainApis(domain)"
                class="px-3 py-2 text-xs font-medium text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors flex items-center gap-2 flex-shrink-0">
                <i class="pi pi-code text-sm"></i>
                <span class="hidden sm:inline">APIs</span>
              </button>

              <!-- Arrow Icon -->
              <div class="flex-shrink-0 text-slate-400 group-hover:text-blue-500 transition-colors">
                <i class="pi pi-chevron-right text-sm"></i>
              </div>
            </div>
          </div>
        </div>

        <!-- Empty State -->
        <div *ngIf="filteredDomains.length === 0" class="px-6 py-12 text-center">
          <div class="flex justify-center mb-4">
            <div class="h-16 w-16 rounded-full bg-slate-100 flex items-center justify-center">
              <i class="pi pi-inbox text-slate-400 text-2xl"></i>
            </div>
          </div>
          <h3 class="text-lg font-medium text-slate-900 mb-2">No domains found</h3>
          <p class="text-slate-600 mb-4">Try adjusting your search or filters</p>
          <button
            (click)="clearFilters()"
            class="inline-flex items-center px-4 py-2 border border-slate-300 rounded-lg text-sm font-medium text-slate-700 bg-white hover:bg-slate-50 transition-colors">
            <i class="pi pi-times mr-2"></i>
            Clear Filters
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Domain Detail Dialog -->
<p-dialog 
  [(visible)]="showDetailDialog" 
  [header]="selectedDomain?.display_name || selectedDomain?.name" 
  [modal]="true" 
  [style]="{ width: '90vw', maxWidth: '800px' }"
  [closable]="true"
  (onHide)="closeDomainDetails()"
  styleClass="domain-detail-dialog">
  
  <!-- Loading State -->
  <div *ngIf="loadingDetail" class="space-y-4">
    <p-skeleton height="2rem" styleClass="mb-2"></p-skeleton>
    <p-skeleton height="1rem" styleClass="mb-2"></p-skeleton>
    <p-divider></p-divider>
    <div class="grid grid-cols-2 gap-4">
      <p-skeleton height="3rem"></p-skeleton>
      <p-skeleton height="3rem"></p-skeleton>
    </div>
  </div>

  <!-- Content State -->
  <div *ngIf="!loadingDetail && selectedDomain" class="space-y-4">
    
    <!-- Description -->
    <p class="text-slate-600">{{ selectedDomain.description }}</p>

    <p-divider></p-divider>

    <!-- Owner & Team -->
    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="text-xs font-semibold text-slate-500 uppercase">Owner</label>
        <p class="text-slate-900 font-medium">{{ selectedDomain.owner || 'N/A' }}</p>
      </div>
      <div>
        <label class="text-xs font-semibold text-slate-500 uppercase">Team</label>
        <p class="text-slate-900 font-medium">{{ selectedDomain.team || 'N/A' }}</p>
      </div>
    </div>

    <p-divider></p-divider>

    <!-- Metrics & SLA -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <div class="p-3 bg-blue-50 rounded-lg">
        <p class="text-xs text-slate-600">Quality Score</p>
        <p class="text-lg font-bold text-blue-600">{{ selectedDomain.metrics?.quality_score || 'N/A' }}</p>
      </div>
      <div class="p-3 bg-purple-50 rounded-lg">
        <p class="text-xs text-slate-600">Subscribers</p>
        <p class="text-lg font-bold text-purple-600">{{ selectedDomain.metrics?.subscribers || 0 }}</p>
      </div>
      <div class="p-3 bg-emerald-50 rounded-lg">
        <p class="text-xs text-slate-600">Availability</p>
        <p class="text-lg font-bold text-emerald-600">{{ selectedDomain.sla?.availability || 'N/A' }}</p>
      </div>
      <div class="p-3 bg-orange-50 rounded-lg">
        <p class="text-xs text-slate-600">Version</p>
        <p class="text-lg font-bold text-orange-600">{{ selectedDomain.sla?.version || 'N/A' }}</p>
      </div>
    </div>

    <p-divider></p-divider>

    <!-- Tags -->
    <div *ngIf="selectedDomain.tags && selectedDomain.tags.length > 0">
      <label class="text-xs font-semibold text-slate-500 uppercase mb-2 block">Tags</label>
      <div class="flex flex-wrap gap-2">
        <p-tag *ngFor="let tag of selectedDomain.tags" [value]="tag"></p-tag>
      </div>
    </div>

    <div *ngIf="!selectedDomain.tags || selectedDomain.tags.length === 0" class="text-sm text-slate-500">
      No tags
    </div>

    <p-divider></p-divider>

    <!-- Data Products -->
    <div>
      <label class="text-xs font-semibold text-slate-500 uppercase mb-2 block">
        Data Products ({{ selectedDomain.data_products?.length || 0 }})
      </label>
      <div *ngIf="selectedDomain.data_products && selectedDomain.data_products.length > 0" class="space-y-2">
        <div *ngFor="let product of selectedDomain.data_products" class="p-3 bg-slate-50 rounded-lg border border-slate-200">
          <p class="font-medium text-slate-900">{{ product.name }}</p>
          <p class="text-sm text-slate-600 mt-1">{{ product.description }}</p>
          <p class="text-xs text-slate-500 mt-1">
            <i class="pi pi-code mr-1"></i>{{ product.endpoints_count || 0 }} endpoints
          </p>
        </div>
      </div>
      <p *ngIf="!selectedDomain.data_products || selectedDomain.data_products.length === 0" class="text-sm text-slate-500">
        No data products available
      </p>
    </div>

    <p-divider></p-divider>

    <!-- Contact Info -->
    <div>
      <label class="text-xs font-semibold text-slate-500 uppercase mb-2 block">Contact</label>
      <div class="space-y-1 text-sm">
        <p *ngIf="selectedDomain.contact?.email" class="text-slate-600">
          <span class="font-medium">Email:</span>
          <a [href]="'mailto:' + selectedDomain.contact.email" class="text-blue-600 hover:underline ml-2">
            {{ selectedDomain.contact.email }}
          </a>
        </p>
        <p *ngIf="selectedDomain.contact?.slack" class="text-slate-600">
          <span class="font-medium">Slack:</span>
          <span class="ml-2">{{ selectedDomain.contact.slack }}</span>
        </p>
        <p *ngIf="selectedDomain.contact?.support" class="text-slate-600">
          <span class="font-medium">Support:</span>
          <span class="ml-2">{{ selectedDomain.contact.support }}</span>
        </p>
      </div>
    </div>
  </div>

  <!-- Dialog Footer -->
  <ng-template pTemplate="footer">
    <button pButton type="button" label="Close" (click)="closeDomainDetails()" [disabled]="loadingDetail" class="p-button-secondary"></button>
  </ng-template>
</p-dialog>

<!-- APIs Dialog -->
<p-dialog 
  [(visible)]="showApisDialog" 
  [header]="'APIs - ' + (selectedDomainForApis?.display_name || selectedDomainForApis?.name)" 
  [modal]="true" 
  [style]="{ width: '95vw', maxWidth: '1200px' }"
  [closable]="true"
  (onHide)="closeApisDialog()"
  styleClass="apis-dialog">
  
  <!-- Loading State -->
  <div *ngIf="loadingApis" class="flex items-center justify-center py-12">
    <div class="text-center">
      <i class="pi pi-spinner pi-spin text-4xl text-blue-500 mb-4 block"></i>
      <p class="text-slate-600">Loading APIs...</p>
    </div>
  </div>

  <!-- APIs Content -->
  <div *ngIf="!loadingApis && domainApis" class="space-y-4">
    
    <!-- Search & Filter -->
    <div class="flex gap-3">
      <div class="flex-1">
        <div class="relative">
          <i class="pi pi-search absolute left-3 top-3 text-slate-400"></i>
          <input
            type="text"
            [(ngModel)]="apiSearchTerm"
            (input)="filterApis()"
            placeholder="Search APIs..."
            class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
        </div>
      </div>
    </div>

    <!-- APIs Count & Info -->
    <div class="flex items-center justify-between text-sm">
      <p class="text-slate-700 font-medium">
        {{ filteredApis.length }} {{ filteredApis.length === 1 ? 'API' : 'APIs' }} found
        <span class="text-slate-500 ml-2">(Total: {{ domainApis.length }})</span>
      </p>
    </div>

    <!-- APIs List -->
    <div class="space-y-2 max-h-96 overflow-y-auto">
      <div *ngFor="let api of filteredApis" class="p-4 bg-slate-50 border border-slate-200 rounded-lg hover:border-blue-300 transition-colors">
        <!-- API Header -->
        <div class="flex items-start justify-between gap-3 mb-2">
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-1">
              <span class="inline-flex items-center px-2 py-1 rounded text-xs font-semibold"
                    [class]="{
                      'bg-blue-100 text-blue-800': api.method === 'GET',
                      'bg-green-100 text-green-800': api.method === 'POST',
                      'bg-yellow-100 text-yellow-800': api.method === 'PUT',
                      'bg-red-100 text-red-800': api.method === 'DELETE',
                      'bg-purple-100 text-purple-800': api.method === 'PATCH'
                    }">
                {{ api.method }}
              </span>
              <code class="text-sm font-mono text-slate-700">{{ api.path }}</code>
            </div>
            <p class="text-sm text-slate-600">{{ api.description }}</p>
          </div>
        </div>

        <!-- API Meta -->
        <div class="flex flex-wrap gap-4 text-xs text-slate-500 mt-3 pt-3 border-t border-slate-200">
          <div>
            <span class="font-medium">Data Product:</span>
            <span class="ml-1">{{ api.data_product }}</span>
          </div>
          <div>
            <span class="font-medium">Source:</span>
            <span class="ml-1 px-2 py-1 rounded bg-slate-200">{{ api.source }}</span>
          </div>
          <div>
            <span class="font-medium">Full Path:</span>
            <code class="ml-1 font-mono bg-slate-200 px-2 py-1 rounded">{{ api.full_path }}</code>
          </div>
        </div>
      </div>
    </div>

    <!-- No Results -->
    <div *ngIf="filteredApis.length === 0" class="text-center py-8">
      <i class="pi pi-inbox text-slate-300 text-3xl mb-3 block"></i>
      <p class="text-slate-500">No APIs found</p>
    </div>

    <!-- Pagination Info -->
    <div class="text-xs text-slate-500 text-center pt-4 border-t border-slate-200">
      {{ domainApis.length }} of {{ totalApiCount }} APIs displayed
      <span *ngIf="totalApiCount > domainApis.length" class="text-slate-400">
        (Showing first 10, total: {{ totalApiCount }})
      </span>
    </div>
  </div>

  <!-- Empty State -->
  <div *ngIf="!loadingApis && (!domainApis || domainApis.length === 0)" class="text-center py-12">
    <i class="pi pi-inbox text-slate-300 text-4xl mb-4 block"></i>
    <p class="text-slate-500">No APIs available for this domain</p>
  </div>

  <!-- Dialog Footer -->
  <ng-template pTemplate="footer">
    <button pButton type="button" label="Close" (click)="closeApisDialog()" class="p-button-secondary"></button>
  </ng-template>
</p-dialog>
