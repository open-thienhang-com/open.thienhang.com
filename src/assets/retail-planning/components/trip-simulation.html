<!-- Trip Simulation Component -->
<link rel="stylesheet" href="../css/scenario-tuning.css">
<div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6 overflow-hidden">
  <!-- Top Control Bar -->
  <div class="bg-gradient-to-r from-orange-50 to-orange-100 border-b border-orange-200 px-6 py-4">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-4">
        <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2">
          <span>üöÄ</span>
          <span>M√¥ Ph·ªèng Chuy·∫øn Xe</span>
          <span id="selected-plan-info" class="text-sm font-normal text-orange-600 bg-orange-100 px-3 py-1 rounded-full border border-orange-200 hidden">
            <span class="mr-1">üìã</span>
            <span>Cho l·ªãch t·∫£i: </span>
            <span id="selected-plan-name" class="font-semibold">Ch∆∞a ch·ªçn</span>
          </span>
        </h3>
      </div>
      <div class="flex items-center gap-3">
        <!-- Action buttons moved to top for easier access -->
        <div class="hidden sm:flex items-center gap-3">
          <button 
            type="button"
            id="btn-run-forecast-2" 
            class="inline-flex items-center gap-2 px-4 py-2 bg-orange-400 hover:bg-orange-500 text-white text-sm font-medium rounded-lg transition-colors shadow-sm disabled:opacity-50 disabled:cursor-not-allowed" 
            >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
            </svg>
            <span>M√¥ Ph·ªèng</span>
          </button>
        </div>
      </div>
    </div>
    
    <!-- Quick Inputs: Plan ID / Model ID / Persist / Run Fast -->
    <div class="px-6 py-3 border-t border-orange-100 bg-orange-50">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-end">
        <div>

        <script>
          (function(){
            function $(id){ return document.getElementById(id); }
            
            // Define trip popup functions IMMEDIATELY at script load
            window.hideTripPopup = function(){
              console.log('[Trip Popup] Hiding modal...');
              var modal = document.getElementById('trip-popup-modal');
              if(modal) {
                modal.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
                console.log('[Trip Popup] Modal hidden');
              } else {
                console.warn('[Trip Popup] Modal element not found');
              }
            };
            
            window.populateTripDetails = function(trip){
              console.log('[Trip Popup] Populating details for:', trip);
              if(!trip || typeof trip !== 'object'){
                console.warn('[Trip Popup] populateTripDetails called with invalid trip:', trip);
                trip = trip || {};
              }
              
              // Helper to safely set text content ‚Äî treat 0 as a valid value
              var setText = function(id, value) {
                var el = document.getElementById(id);
                if(el) {
                  var display = (value === undefined || value === null || value === '') ? '-' : value;
                  el.textContent = display;
                  console.log('[Trip Popup] Set', id, '=', display);
                } else {
                  console.warn('[Trip Popup] Element not found:', id);
                }
              };
              
              // Stats cards
              setText('trip-stat-date', trip.date);
              setText('trip-stat-shift', trip.shift);
              setText('trip-stat-ontime', (trip.ontime_rate != null ? trip.ontime_rate + '%' : (trip.ontime_rate_percent != null ? trip.ontime_rate_percent + '%' : null)));
              setText('trip-stat-drop', (trip.drop_rate_percent != null ? trip.drop_rate_percent + '%' : (trip.drop_rate != null ? trip.drop_rate + '%' : null)));
              setText('trip-stat-load', (trip.load_factor != null ? trip.load_factor + '%' : null));
              
              // Detail fields
              setText('trip-detail-code', trip.code);
              setText('trip-detail-stt', trip.stt);
              setText('trip-detail-route', trip.route);
              setText('trip-detail-checkin', trip.check_in || trip.checkin);
              setText('trip-detail-checkout', trip.check_out || trip.checkout);
              setText('trip-detail-pickup', trip.pickup_volume);
              setText('trip-detail-delivery', trip.delivery_volume);
              setText('trip-detail-processing', trip.processing);
              
              // Metrics with bars
              var ontime = parseFloat(trip.ontime_rate || trip.ontime_rate_percent) || 0;
              var drop = parseFloat((trip.drop_rate_percent != null) ? trip.drop_rate_percent : trip.drop_rate) || 0;
              var load = parseFloat(trip.load_factor) || 0;
              
              // Update text displays
              setText('trip-metric-ontime', ontime.toFixed(1) + '%');
              setText('trip-metric-drop', drop.toFixed(1) + '%');
              setText('trip-metric-load', load.toFixed(1) + '%');
              
              // Animate progress bars
              setTimeout(function() {
                var ontimeBar = document.getElementById('trip-bar-ontime');
                if(ontimeBar) ontimeBar.style.width = ontime + '%';
                
                var dropBar = document.getElementById('trip-bar-drop');
                if(dropBar) dropBar.style.width = drop + '%';
                
                var loadBar = document.getElementById('trip-bar-load');
                if(loadBar) loadBar.style.width = load + '%';
              }, 100);
              
              // ===== NEW: Animate Visual Metrics =====
              
              // 1. Truck Load Factor Animation
              setTimeout(function() {
                var fillLevel = document.getElementById('truck-fill-level');
                var fillText = document.getElementById('truck-fill-text');
                var loadValue = document.getElementById('load-factor-value');
                
                console.log('[Visual Metrics] Truck elements:', {fillLevel: !!fillLevel, fillText: !!fillText, loadValue: !!loadValue, load: load});
                
                if(fillLevel && fillText && loadValue) {
                  // Calculate fill height (max 67px for 100%)
                  var fillHeight = Math.min((load / 100) * 67, 67);
                  var fillY = 110 - fillHeight;
                  
                  fillLevel.setAttribute('y', fillY);
                  fillLevel.setAttribute('height', fillHeight);
                  fillText.textContent = load.toFixed(0) + '%';
                  loadValue.textContent = load.toFixed(1) + '%';
                  
                  console.log('[Visual Metrics] Truck updated - height:', fillHeight, 'y:', fillY, 'text:', load.toFixed(1) + '%');
                } else {
                  console.warn('[Visual Metrics] Truck elements missing');
                }
              }, 200);
              
              // 2. Ontime Progress Ring Animation
              setTimeout(function() {
                var ontimeRing = document.getElementById('ontime-progress-ring');
                var ontimeValue = document.getElementById('ontime-rate-value');
                
                console.log('[Visual Metrics] Ontime elements:', {ontimeRing: !!ontimeRing, ontimeValue: !!ontimeValue, ontime: ontime});
                
                if(ontimeRing && ontimeValue) {
                  var circumference = 2 * Math.PI * 60; // r=60
                  var offset = circumference - (ontime / 100) * circumference;
                  ontimeRing.style.strokeDashoffset = offset;
                  ontimeValue.textContent = ontime.toFixed(1) + '%';
                  
                  console.log('[Visual Metrics] Ontime updated - offset:', offset, 'text:', ontime.toFixed(1) + '%');
                } else {
                  console.warn('[Visual Metrics] Ontime elements missing');
                }
              }, 300);
              
              // 3. Drop Rate Progress Ring Animation
              setTimeout(function() {
                var dropRing = document.getElementById('drop-progress-ring');
                var dropValue = document.getElementById('drop-rate-value');
                
                console.log('[Visual Metrics] Drop elements:', {dropRing: !!dropRing, dropValue: !!dropValue, drop: drop});
                
                if(dropRing && dropValue) {
                  var circumference = 2 * Math.PI * 60;
                  var offset = circumference - (drop / 100) * circumference;
                  dropRing.style.strokeDashoffset = offset;
                  dropValue.textContent = drop.toFixed(1) + '%';
                  
                  console.log('[Visual Metrics] Drop updated - offset:', offset, 'text:', drop.toFixed(1) + '%');
                } else {
                  console.warn('[Visual Metrics] Drop elements missing');
                }
              }, 400);
              
              console.log('[Trip Popup] Details and visual metrics populated successfully');
              console.log('[Trip Popup] Metrics summary -> ontime:', ontime, 'drop:', drop, 'load:', load);
            };
            
            window.showTripPopup = function(trip){
              console.log('[Trip Popup] Showing modal with trip:', trip);
              var modal = document.getElementById('trip-popup-modal');
              if(!modal) {
                console.error('[Trip Popup] Modal not found!');
                return;
              }
              
              // Populate details
              if(typeof window.populateTripDetails === 'function'){
                try {
                  window.populateTripDetails(trip);
                } catch(e) {
                  console.error('[Trip Popup] Error populating details:', e);
                }
              }
              
              // Set route title
              var routeTitle = document.getElementById('trip-popup-route-title');
              if(routeTitle) routeTitle.textContent = trip.route || trip.code || 'Route Info';
              
              // Set JSON content
              var content = document.getElementById('trip-popup-content');
              if(content) content.textContent = JSON.stringify(trip || {}, null, 2);
              
              // Show modal
              modal.classList.remove('hidden');
              document.body.classList.add('overflow-hidden');
              console.log('[Trip Popup] Modal shown');
              
              // Initialize Route Map 2D Visualization
              setTimeout(function(){
                console.log('[Trip Popup] Starting Route Map initialization');
                console.log('[Trip Popup] Checking if SVG elements exist...');
                console.log('[Trip Popup] route-map-svg:', document.getElementById('route-map-svg'));
                console.log('[Trip Popup] route-paths:', document.getElementById('route-paths'));
                console.log('[Trip Popup] route-nodes:', document.getElementById('route-nodes'));
                
                if (typeof window.initRouteMap === 'function') {
                  try {
                    window.initRouteMap(trip);
                  } catch(e) {
                    console.error('[Trip Popup] Route Map init error:', e);
                  }
                } else {
                  console.error('[Trip Popup] initRouteMap function not found');
                }
              }, 300);
            };
            
            // ============================================
            // Route Map 2D Visualization with Animation
            // ============================================
            window.routeMapState = {
              stops: [],
              currentIndex: 0,
              isPlaying: false,
              animationId: null,
              speed: 1,
              truckProgress: 0
            };
            
            window.initRouteMap = function(trip) {
              console.log('[Route Map] Initializing with trip:', trip);
              
              var svg = document.getElementById('route-map-svg');
              var pathsGroup = document.getElementById('route-paths');
              var nodesGroup = document.getElementById('route-nodes');
              var truck = document.getElementById('route-truck');
              var timeline = document.getElementById('route-timeline');
              var stopsList = document.getElementById('stops-list');
              var stopsCount = document.getElementById('stops-count');
              
              console.log('[Route Map] Elements found:', {
                svg: !!svg,
                pathsGroup: !!pathsGroup,
                nodesGroup: !!nodesGroup,
                truck: !!truck,
                timeline: !!timeline,
                stopsList: !!stopsList,
                stopsCount: !!stopsCount
              });
              
              if (!svg || !pathsGroup || !nodesGroup) {
                console.error('[Route Map] Required SVG elements not found, svg:', svg, 'paths:', pathsGroup, 'nodes:', nodesGroup);
                return;
              }
              
              // Parse stops from trip data
              var stops = window.parseStopsFromTrip(trip);
              window.routeMapState.stops = stops;
              window.routeMapState.currentIndex = 0;
              window.routeMapState.truckProgress = 0;
              
              if (stops.length === 0) {
                console.warn('[Route Map] No stops found in trip data');
                nodesGroup.innerHTML = '<text x="450" y="150" fill="#9ca3af" text-anchor="middle">Kh√¥ng c√≥ d·ªØ li·ªáu ƒëi·ªÉm d·ª´ng</text>';
                return;
              }
              
              console.log('[Route Map] Parsed', stops.length, 'stops');
              
              // Update stops count
              if (stopsCount) stopsCount.textContent = stops.length + ' ƒëi·ªÉm';
              
              // Render route graph
              window.renderRouteGraph(stops, pathsGroup, nodesGroup);
              
              // Render timeline
              window.renderRouteTimeline(stops, timeline);
              
              // Render stops list
              window.renderStopsList(stops, stopsList);
              
              // Position truck at first stop
              if (truck && stops.length > 0) {
                truck.setAttribute('transform', 'translate(' + stops[0].x + ',' + stops[0].y + ')');
                truck.style.display = '';
              }
              
              // Setup controls
              window.setupRouteMapControls();
            };
            
            window.parseStopsFromTrip = function(trip) {
              var stops = [];
              console.log('[Route Map] parseStopsFromTrip input:', trip);
              
              // Try to parse route string like "KC1 ‚Üí BC1 ‚Üí BC2 ‚Üí KC2"
              var routeStr = trip.route || trip.route_name || '';
              console.log('[Route Map] Route string:', routeStr);
              var routeParts = routeStr.split(/\s*[‚Üí\->\s]+\s*/);
              console.log('[Route Map] Route parts:', routeParts);
              
              if (routeParts.length > 1) {
                routeParts.forEach(function(part, idx) {
                  var name = part.trim();
                  if (!name) return;
                  
                  var type = 'post_office'; // b∆∞u c·ª•c
                  if (/^(KC|KHO|WH|WAREHOUSE)/i.test(name)) {
                    type = 'warehouse'; // kho
                  } else if (/^(KTC|TRANSIT|TRUNG)/i.test(name)) {
                    type = 'transit'; // kho trung chuy·ªÉn
                  }
                  
                  stops.push({
                    id: idx,
                    name: name,
                    type: type,
                    visited: false,
                    x: 0,
                    y: 0
                  });
                });
              }
              
              // Fallback: create default stops if no route parsed
              if (stops.length === 0) {
                // Try stops array in trip
                if (Array.isArray(trip.stops)) {
                  trip.stops.forEach(function(s, idx) {
                    stops.push({
                      id: idx,
                      name: s.name || s.station || ('ƒêi·ªÉm ' + (idx + 1)),
                      type: s.type || 'post_office',
                      time: s.time || s.arrival_time,
                      visited: false,
                      x: 0,
                      y: 0
                    });
                  });
                } else {
                  // Create placeholder stops
                  var codes = (trip.code || 'A').split('');
                  stops.push({ id: 0, name: 'Kho Xu·∫•t Ph√°t', type: 'warehouse', visited: false, x: 0, y: 0 });
                  stops.push({ id: 1, name: 'B∆∞u c·ª•c 1', type: 'post_office', visited: false, x: 0, y: 0 });
                  stops.push({ id: 2, name: 'B∆∞u c·ª•c 2', type: 'post_office', visited: false, x: 0, y: 0 });
                  stops.push({ id: 3, name: 'Kho K·∫øt Th√∫c', type: 'warehouse', visited: false, x: 0, y: 0 });
                }
              }
              
              // Calculate positions
              var padding = 80;
              var svgWidth = 900;
              var svgHeight = 300;
              var usableWidth = svgWidth - padding * 2;
              var usableHeight = svgHeight - padding * 2;
              
              stops.forEach(function(stop, idx) {
                // Horizontal layout with slight vertical variation
                var progress = stops.length > 1 ? idx / (stops.length - 1) : 0.5;
                stop.x = padding + progress * usableWidth;
                // Alternate y position for visual interest
                var yOffset = (idx % 2 === 0) ? 0 : 30;
                stop.y = svgHeight / 2 + yOffset;
              });
              
              return stops;
            };
            
            window.renderRouteGraph = function(stops, pathsGroup, nodesGroup) {
              pathsGroup.innerHTML = '';
              nodesGroup.innerHTML = '';
              
              // Draw paths between stops
              for (var i = 0; i < stops.length - 1; i++) {
                var from = stops[i];
                var to = stops[i + 1];
                
                // Calculate control points for curved path
                var midX = (from.x + to.x) / 2;
                var midY = Math.min(from.y, to.y) - 30;
                
                var pathD = 'M ' + from.x + ' ' + from.y + 
                           ' Q ' + midX + ' ' + midY + ' ' + to.x + ' ' + to.y;
                
                // Background path
                var bgPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                bgPath.setAttribute('d', pathD);
                bgPath.setAttribute('fill', 'none');
                bgPath.setAttribute('stroke', '#374151');
                bgPath.setAttribute('stroke-width', '4');
                bgPath.setAttribute('stroke-linecap', 'round');
                pathsGroup.appendChild(bgPath);
                
                // Animated path (highlighted when active)
                var animPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                animPath.setAttribute('d', pathD);
                animPath.setAttribute('fill', 'none');
                animPath.setAttribute('stroke', 'url(#routeGradient)');
                animPath.setAttribute('stroke-width', '3');
                animPath.setAttribute('stroke-linecap', 'round');
                animPath.setAttribute('stroke-dasharray', '10 5');
                animPath.setAttribute('class', 'route-segment');
                animPath.setAttribute('data-segment', i);
                animPath.style.opacity = '0';
                pathsGroup.appendChild(animPath);
              }
              
              // Draw nodes
              stops.forEach(function(stop, idx) {
                var g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                g.setAttribute('class', 'route-node');
                g.setAttribute('data-stop', idx);
                g.style.cursor = 'pointer';
                
                // Node styling based on type
                var nodeColor = '#f97316'; // orange for post office
                var nodeSize = 18;
                var icon = 'üì¨';
                
                if (stop.type === 'warehouse') {
                  nodeColor = '#a855f7'; // purple for warehouse
                  nodeSize = 22;
                  icon = 'üè≠';
                } else if (stop.type === 'transit') {
                  nodeColor = '#3b82f6'; // blue for transit warehouse
                  nodeSize = 24;
                  icon = 'üè¢';
                }
                
                // Glow effect
                var glow = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                glow.setAttribute('cx', stop.x);
                glow.setAttribute('cy', stop.y);
                glow.setAttribute('r', nodeSize + 8);
                glow.setAttribute('fill', nodeColor);
                glow.setAttribute('opacity', '0.2');
                glow.setAttribute('class', 'node-glow');
                g.appendChild(glow);
                
                // Main node circle
                var circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', stop.x);
                circle.setAttribute('cy', stop.y);
                circle.setAttribute('r', nodeSize);
                circle.setAttribute('fill', nodeColor);
                circle.setAttribute('stroke', '#fff');
                circle.setAttribute('stroke-width', '3');
                circle.setAttribute('class', 'node-circle');
                g.appendChild(circle);
                
                // Visited indicator (inner circle)
                var inner = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                inner.setAttribute('cx', stop.x);
                inner.setAttribute('cy', stop.y);
                inner.setAttribute('r', nodeSize - 6);
                inner.setAttribute('fill', '#22c55e');
                inner.setAttribute('class', 'node-visited');
                inner.style.display = 'none';
                g.appendChild(inner);
                
                // Icon or number
                var text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', stop.x);
                text.setAttribute('y', stop.y + 1);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('dominant-baseline', 'middle');
                text.setAttribute('fill', '#fff');
                text.setAttribute('font-size', '12');
                text.setAttribute('font-weight', 'bold');
                text.textContent = idx + 1;
                g.appendChild(text);
                
                // Label below node
                var label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                label.setAttribute('x', stop.x);
                label.setAttribute('y', stop.y + nodeSize + 18);
                label.setAttribute('text-anchor', 'middle');
                label.setAttribute('fill', '#e5e7eb');
                label.setAttribute('font-size', '11');
                label.setAttribute('font-weight', '500');
                label.textContent = stop.name.length > 12 ? stop.name.substring(0, 10) + '...' : stop.name;
                g.appendChild(label);
                
                // Click handler
                g.addEventListener('click', function() {
                  window.jumpToStop(idx);
                });
                
                nodesGroup.appendChild(g);
              });
            };
            
            window.renderRouteTimeline = function(stops, timeline) {
              if (!timeline) return;
              timeline.innerHTML = '';
              
              stops.forEach(function(stop, idx) {
                var item = document.createElement('div');
                item.className = 'flex-shrink-0 flex flex-col items-center cursor-pointer timeline-item';
                item.setAttribute('data-stop', idx);
                
                var typeColor = stop.type === 'warehouse' ? 'bg-gray-700' : 
                               stop.type === 'transit' ? 'bg-gray-600' : 'bg-gray-500';
                
                item.innerHTML = 
                  '<div class="w-8 h-8 rounded-full ' + typeColor + ' flex items-center justify-center text-white text-xs font-bold border-2 border-white/30 timeline-dot" data-visited="false" data-type="' + (stop.type || 'post_office') + '">' + 
                    (idx + 1) + 
                  '</div>' +
                  '<div class="text-xs text-gray-400 mt-1 max-w-16 text-center truncate">' + 
                    (stop.name.length > 8 ? stop.name.substring(0, 6) + '..' : stop.name) + 
                  '</div>';
                
                if (idx < stops.length - 1) {
                  var connector = document.createElement('div');
                  connector.className = 'w-8 h-0.5 bg-gray-300 self-center mt-4 timeline-connector';
                  item.appendChild(connector);
                }
                
                item.addEventListener('click', function() {
                  window.jumpToStop(idx);
                });
                
                timeline.appendChild(item);
              });
            };
            
            window.renderStopsList = function(stops, container) {
              if (!container) return;
              
              var html = '';
              stops.forEach(function(stop, idx) {
                var typeLabel = stop.type === 'warehouse' ? 'üè≠ Kho' : 
                               stop.type === 'transit' ? 'üè¢ Kho TC' : 'üì¨ B∆∞u c·ª•c';
                var typeColor = 'text-gray-700 bg-gray-50';
                
                html += 
                  '<div class="px-4 py-2.5 flex items-center justify-between hover:bg-gray-50 cursor-pointer stop-item" data-stop="' + idx + '">' +
                    '<div class="flex items-center gap-3">' +
                      '<span class="w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center text-xs font-bold text-gray-600">' + (idx + 1) + '</span>' +
                      '<div>' +
                        '<div class="text-sm font-medium text-gray-900">' + stop.name + '</div>' +
                        (stop.time ? '<div class="text-xs text-gray-500">' + stop.time + '</div>' : '') +
                      '</div>' +
                    '</div>' +
                    '<span class="text-xs px-2 py-0.5 rounded ' + typeColor + '">' + typeLabel + '</span>' +
                  '</div>';
              });
              
              container.innerHTML = html;
              
              // Add click handlers
              container.querySelectorAll('.stop-item').forEach(function(item) {
                item.addEventListener('click', function() {
                  var stopIdx = parseInt(this.getAttribute('data-stop'));
                  window.jumpToStop(stopIdx);
                });
              });
            };
            
            window.setupRouteMapControls = function() {
              var playBtn = document.getElementById('route-map-play');
              var resetBtn = document.getElementById('route-map-reset');
              var speedSlider = document.getElementById('route-map-speed');
              
              if (playBtn) {
                playBtn.onclick = function() {
                  if (window.routeMapState.isPlaying) {
                    window.pauseRouteAnimation();
                  } else {
                    window.playRouteAnimation();
                  }
                };
              }
              
              if (resetBtn) {
                resetBtn.onclick = function() {
                  window.resetRouteAnimation();
                };
              }
              
              if (speedSlider) {
                speedSlider.oninput = function() {
                  window.routeMapState.speed = parseFloat(this.value);
                };
              }
              
              // JSON toggle
              var jsonToggle = document.getElementById('trip-json-toggle');
              var jsonContent = document.getElementById('trip-json-content');
              var jsonArrow = document.getElementById('trip-json-arrow');
              if (jsonToggle && jsonContent) {
                jsonToggle.onclick = function() {
                  jsonContent.classList.toggle('hidden');
                  if (jsonArrow) {
                    jsonArrow.style.transform = jsonContent.classList.contains('hidden') ? '' : 'rotate(180deg)';
                  }
                };
              }
            };
            
            window.playRouteAnimation = function() {
              var state = window.routeMapState;
              if (state.isPlaying) return;
              if (state.stops.length === 0) return;
              
              state.isPlaying = true;
              
              var playIcon = document.getElementById('route-map-play-icon');
              var playText = document.getElementById('route-map-play-text');
              if (playIcon) playIcon.textContent = '‚è∏';
              if (playText) playText.textContent = 'D·ª´ng';
              
              var infoPanel = document.getElementById('route-map-info');
              if (infoPanel) infoPanel.classList.remove('hidden');
              
              window.animateToNextStop();
            };
            
            window.pauseRouteAnimation = function() {
              var state = window.routeMapState;
              state.isPlaying = false;
              
              if (state.animationId) {
                cancelAnimationFrame(state.animationId);
                state.animationId = null;
              }
              
              var playIcon = document.getElementById('route-map-play-icon');
              var playText = document.getElementById('route-map-play-text');
              if (playIcon) playIcon.textContent = '‚ñ∂';
              if (playText) playText.textContent = 'Ch·∫°y';
            };
            
            window.resetRouteAnimation = function() {
              window.pauseRouteAnimation();
              
              var state = window.routeMapState;
              state.currentIndex = 0;
              state.truckProgress = 0;
              
              // Reset all visited states
              state.stops.forEach(function(stop) {
                stop.visited = false;
              });
              
              // Reset visual states
              document.querySelectorAll('.node-visited').forEach(function(el) {
                el.style.display = 'none';
              });
              document.querySelectorAll('.route-segment').forEach(function(el) {
                el.style.opacity = '0';
              });
              document.querySelectorAll('.timeline-dot').forEach(function(el) {
                el.setAttribute('data-visited', 'false');
                el.classList.remove('bg-emerald-500');
              });
              
              // Move truck to first stop
              var truck = document.getElementById('route-truck');
              if (truck && state.stops.length > 0) {
                truck.setAttribute('transform', 'translate(' + state.stops[0].x + ',' + state.stops[0].y + ')');
              }
              
              // Hide info panel
              var infoPanel = document.getElementById('route-map-info');
              if (infoPanel) infoPanel.classList.add('hidden');
            };
            
            window.animateToNextStop = function() {
              var state = window.routeMapState;
              if (!state.isPlaying) return;
              if (state.currentIndex >= state.stops.length - 1) {
                // Mark last stop as visited
                window.markStopVisited(state.currentIndex);
                window.pauseRouteAnimation();
                return;
              }
              
              var from = state.stops[state.currentIndex];
              var to = state.stops[state.currentIndex + 1];
              
              // Mark current stop as visited
              window.markStopVisited(state.currentIndex);
              
              // Show current segment
              var segment = document.querySelector('.route-segment[data-segment="' + state.currentIndex + '"]');
              if (segment) segment.style.opacity = '1';
              
              // Animate truck
              window.animateTruck(from, to, function() {
                state.currentIndex++;
                state.truckProgress = 0;
                
                if (state.isPlaying) {
                  setTimeout(function() {
                    window.animateToNextStop();
                  }, 500 / state.speed);
                }
              });
            };
            
            window.animateTruck = function(from, to, callback) {
              var state = window.routeMapState;
              var truck = document.getElementById('route-truck');
              var currentStop = document.getElementById('route-map-current-stop');
              
              if (!truck) {
                if (callback) callback();
                return;
              }
              
              // Update info panel
              if (currentStop) {
                currentStop.textContent = from.name + ' ‚Üí ' + to.name;
              }
              
              var duration = 2000 / state.speed;
              var startTime = null;
              
              // Calculate control point for curved path (same as in renderRouteGraph)
              var midX = (from.x + to.x) / 2;
              var midY = Math.min(from.y, to.y) - 30;
              
              function animate(timestamp) {
                if (!state.isPlaying) return;
                
                if (!startTime) startTime = timestamp;
                var progress = (timestamp - startTime) / duration;
                
                if (progress >= 1) {
                  truck.setAttribute('transform', 'translate(' + to.x + ',' + to.y + ')');
                  if (callback) callback();
                  return;
                }
                
                // Quadratic bezier interpolation
                var t = progress;
                var x = (1-t)*(1-t)*from.x + 2*(1-t)*t*midX + t*t*to.x;
                var y = (1-t)*(1-t)*from.y + 2*(1-t)*t*midY + t*t*to.y;
                
                truck.setAttribute('transform', 'translate(' + x + ',' + y + ')');
                
                state.animationId = requestAnimationFrame(animate);
              }
              
              state.animationId = requestAnimationFrame(animate);
            };
            
            window.markStopVisited = function(idx) {
              var state = window.routeMapState;
              if (idx < 0 || idx >= state.stops.length) return;
              
              state.stops[idx].visited = true;
              
              // Update node visual
              var node = document.querySelector('.route-node[data-stop="' + idx + '"]');
              if (node) {
                var visited = node.querySelector('.node-visited');
                if (visited) visited.style.display = '';
                var glow = node.querySelector('.node-glow');
                if (glow) glow.setAttribute('fill', '#22c55e');
              }
              
              // Update timeline
              var timelineItem = document.querySelector('.timeline-item[data-stop="' + idx + '"] .timeline-dot');
                if (timelineItem) {
                    timelineItem.setAttribute('data-visited', 'true');
                    timelineItem.classList.add('bg-emerald-500');
                  }
            };
            
            window.jumpToStop = function(idx) {
              window.pauseRouteAnimation();
              
              var state = window.routeMapState;
              if (idx < 0 || idx >= state.stops.length) return;
              
              // Reset all
              state.stops.forEach(function(stop, i) {
                stop.visited = i < idx;
              });
              
              // Update visuals for all stops up to idx
              for (var i = 0; i < state.stops.length; i++) {
                var node = document.querySelector('.route-node[data-stop="' + i + '"]');
                var timelineItem = document.querySelector('.timeline-item[data-stop="' + i + '"] .timeline-dot');
                var segment = document.querySelector('.route-segment[data-segment="' + i + '"]');
                
                if (i < idx) {
                  // Visited
                  if (node) {
                    var visited = node.querySelector('.node-visited');
                    if (visited) visited.style.display = '';
                    var glow = node.querySelector('.node-glow');
                    if (glow) glow.setAttribute('fill', '#22c55e');
                  }
                    if (timelineItem) {
                      timelineItem.setAttribute('data-visited', 'true');
                      timelineItem.classList.add('bg-emerald-500');
                    }
                  if (segment) segment.style.opacity = '1';
                } else {
                  // Not visited
                  if (node) {
                    var visited = node.querySelector('.node-visited');
                    if (visited) visited.style.display = 'none';
                    var glow = node.querySelector('.node-glow');
                    var stop = state.stops[i];
                    var color = stop.type === 'warehouse' ? '#374151' : 
                               stop.type === 'transit' ? '#4B5563' : '#6B7280';
                    if (glow) glow.setAttribute('fill', color);
                  }
                  if (timelineItem) {
                    timelineItem.setAttribute('data-visited', 'false');
                    timelineItem.classList.remove('bg-emerald-500');
                  }
                  if (segment) segment.style.opacity = '0';
                }
              }
              
              // Move truck to this stop
              var truck = document.getElementById('route-truck');
              if (truck) {
                truck.setAttribute('transform', 'translate(' + state.stops[idx].x + ',' + state.stops[idx].y + ')');
              }
              
              state.currentIndex = idx;
              
              // Show info panel
              var infoPanel = document.getElementById('route-map-info');
              var currentStop = document.getElementById('route-map-current-stop');
              if (infoPanel) infoPanel.classList.remove('hidden');
              if (currentStop) currentStop.textContent = state.stops[idx].name;
            };

            function getSelectedRadio(name){
              var r = document.querySelector('input[name="' + name + '"]:checked');
              return r ? r.value : null;
            }

            function buildPayload(){
              // Helper to safely get element value
              function getValue(id, defaultValue) {
                var el = $(id);
                return el && el.value ? el.value.trim() : (defaultValue || '');
              }
              
              // Helper to safely get checkbox checked state
              function getChecked(id, defaultValue) {
                var el = $(id);
                return el ? el.checked : (defaultValue || false);
              }

              var planIdEl = $('sim-plan-id-2');
              var planId = planIdEl ? planIdEl.value.trim() : '';
              
              // Fallback to global state if input doesn't exist or is empty
              if (!planId) {
                planId = window.selectedPlanId || 
                        (window.planningState && window.planningState.selectedPlanId) ||
                        (window.planningState && window.planningState.currentPlan && (window.planningState.currentPlan.id || window.planningState.currentPlan.uuid)) ||
                        '';
              }
              
              if (!planId) {
                console.error('[buildPayload] sim-plan-id-2 element not found or empty, and no plan ID in global state');
                return null;
              }

              var modelId = getValue('sim-model-id-2');
              var modelName = getValue('sim-model-name-2');
              var fromDate = getValue('sim-date-from-2');
              var toDate = getValue('sim-date-to-2');
              var persist = getChecked('sim-persist-2', false);
              var runFast = getChecked('sim-run-fast-2', false);
              var notes = getValue('sim-notes-2');
              var bufferThroughputEl = $('buffer-throughput-2');
              var bufferThroughput = bufferThroughputEl ? parseFloat(bufferThroughputEl.value || '1.0') : 1.0;

              var cargoType = getSelectedRadio('cargo-type-2') || 'normal';
              var weather = getSelectedRadio('weather-condition-2') || 'sunny';

              var ktc = {
                dropoff_before_19: {
                  enabled: getChecked('ktc-dropoff-before-19', false),
                  cutoff_time: getValue('ktc-dropoff-before-19-time'),
                  apply_next_day: false
                },
                dropoff_after_19: {
                  enabled: getChecked('ktc-dropoff-after-19', false),
                  cutoff_time: getValue('ktc-dropoff-after-19-time'),
                  apply_next_day: true
                },
                pickup_before_11: {
                  enabled: getChecked('ktc-pickup-before-11', false),
                  cutoff_time: getValue('ktc-pickup-before-11-time'),
                  apply_next_day: false
                },
                pickup_after_11: {
                  enabled: getChecked('ktc-pickup-after-11', false),
                  cutoff_time: getValue('ktc-pickup-after-11-time'),
                  apply_next_day: true
                }
              };
              // Read additional KTC flow params (if inputs exist)
              try {
                var ktcTravelEl = $('ktc-travel-ktc-to-bc');
                var ktcReturnMaxEl = $('ktc-return-max-delay');
                var ktcAnimateEl = $('ktc-flow-animate');
                var ktcTravel = ktcTravelEl ? parseInt(ktcTravelEl.value || '30', 10) : 30;
                var ktcReturnMax = ktcReturnMaxEl ? parseInt(ktcReturnMaxEl.value || '60', 10) : 60;
                var ktcAnimate = ktcAnimateEl ? ktcAnimateEl.checked : false;
                ktc.travel_minutes = ktcTravel;
                ktc.return_max_delay_minutes = ktcReturnMax;
                ktc.animate = ktcAnimate;
              } catch(e){ console.warn('Failed to read KTC flow extra params', e); }

              var trafficBiasEl = $('traffic-bias-2');
              var roadConditionEl = $('road-condition-2');
              var deliveryDifficultyEl = $('delivery-difficulty-2');
              var scenario = {
                traffic_bias_percent: trafficBiasEl ? parseInt(trafficBiasEl.value || '0', 10) : 0,
                road_condition_percent: roadConditionEl ? parseInt(roadConditionEl.value || '0', 10) : 0,
                delivery_difficulty_percent: deliveryDifficultyEl ? parseInt(deliveryDifficultyEl.value || '0', 10) : 0
              };

              // Get scenario configuration from checkboxes
              var scenarioTuning = {};
              if (typeof window.getScenarioConfig === 'function') {
                scenarioTuning = window.getScenarioConfig();
              }

              var payload = {
                plan_id: planId || undefined,
                model_id: modelId,
                from_date: fromDate,
                to_date: toDate,
                persist: persist,
                buffer_throughtput: bufferThroughput,
                simulation: {
                  date_range: { start_date: fromDate, end_date: toDate },
                  model_name: modelName,
                  cargo_type: cargoType,
                  weather: weather,
                  ktc: ktc,
                  scenario: scenario,
                  scenario_tuning: scenarioTuning, // Add scenario tuning config
                  run_fast: runFast,
                  notes: notes
                }
              };

              return payload;
            }

            function setLoading(isLoading){
              var btn = $('btn-run-forecast-2');
              if(!btn) return;
              btn.disabled = isLoading;
              btn.textContent = isLoading ? 'ƒêang ch·∫°y...' : 'Ch·∫°y M√¥ Ph·ªèng';
            }

            function updateForecastSummary(trips){
              // Helper to safely set textContent
              function setText(id, value) {
                var el = $(id);
                if (el) {
                  el.textContent = value;
                }
              }
              
              if(!trips || trips.length === 0){
                // Reset to defaults (only if elements exist)
                setText('forecast-total-trips', '0');
                setText('forecast-ontime-rate', '0%');
                setText('forecast-drop-rate', '0%');
                setText('forecast-load-factor', '0%');
                return;
              }
              
              var totalTrips = trips.length;
              var totalOntime = 0;
              var totalDrop = 0;
              var totalLoad = 0;
              var validCount = 0;
              
              trips.forEach(function(trip){
                if(trip.ontime_rate_percent != null){
                  totalOntime += trip.ontime_rate_percent;
                  validCount++;
                }
                if(trip.drop_rate_percent != null){
                  totalDrop += trip.drop_rate_percent;
                }
                if(trip.load_factor != null){
                  totalLoad += trip.load_factor;
                }
              });
              
              var avgOntime = validCount > 0 ? (totalOntime / validCount).toFixed(1) : 0;
              var avgDrop = trips.length > 0 ? (totalDrop / trips.length).toFixed(1) : 0;
              var avgLoad = trips.length > 0 ? (totalLoad / trips.length).toFixed(1) : 0;
              
              // Safely update elements if they exist
              setText('forecast-total-trips', totalTrips);
              setText('forecast-ontime-rate', avgOntime + '%');
              setText('forecast-drop-rate', avgDrop + '%');
              setText('forecast-load-factor', avgLoad + '%');
            }
            
            function updateForecastInsights(trips){
              var insightsDiv = $('forecast-insights');
              if(!insightsDiv) return;
              
              var insights = [];
              
              if(trips.length === 0){
                insights.push('Kh√¥ng c√≥ d·ªØ li·ªáu chuy·∫øn xe ƒë·ªÉ ph√¢n t√≠ch.');
              } else {
                // Calculate metrics
                var totalTrips = trips.length;
                var avgOntime = 0, avgDrop = 0, avgLoad = 0, count = 0;
                var totalVolume = 0, totalDistance = 0, totalDelay = 0;
                var shiftStats = { 'Ca 1': 0, 'Ca 2': 0, 'Ca 3': 0, 'Kh√°c': 0 };
                
                trips.forEach(function(t){
                  if(t.ontime_rate_percent != null){ avgOntime += t.ontime_rate_percent; count++; }
                  if(t.drop_rate_percent != null) avgDrop += t.drop_rate_percent;
                  if(t.load_factor != null) avgLoad += t.load_factor;
                  if(t.pickup_volume) totalVolume += t.pickup_volume;
                  if(t.delivery_volume) totalVolume += t.delivery_volume;
                  if(t.predicted_total_delay_sec) totalDelay += t.predicted_total_delay_sec;
                  
                  var shift = t.shift || 'Kh√°c';
                  if(shiftStats.hasOwnProperty(shift)) shiftStats[shift]++;
                  else shiftStats['Kh√°c']++;
                });
                
                avgOntime = count > 0 ? avgOntime / count : 0;
                avgDrop = trips.length > 0 ? avgDrop / trips.length : 0;
                avgLoad = trips.length > 0 ? avgLoad / trips.length : 0;
                totalDelay = totalDelay / 3600; // Convert to hours
                
                // Generate insights
                insights.push('üìä <strong>T·ªïng quan:</strong> ' + totalTrips + ' chuy·∫øn xe, ' + totalVolume.toFixed(0) + ' kg h√†ng h√≥a');
                
                // Performance insights
                if(avgOntime >= 85) insights.push('‚úÖ <strong>Hi·ªáu su·∫•t cao:</strong> T·ª∑ l·ªá ƒë√∫ng gi·ªù ' + avgOntime.toFixed(1) + '% - Xu·∫•t s·∫Øc');
                else if(avgOntime >= 70) insights.push('‚ö†Ô∏è <strong>Hi·ªáu su·∫•t kh√°:</strong> T·ª∑ l·ªá ƒë√∫ng gi·ªù ' + avgOntime.toFixed(1) + '% - C·∫ßn c·∫£i thi·ªán nh·∫π');
                else if(avgOntime >= 50) insights.push('üî¥ <strong>Hi·ªáu su·∫•t trung b√¨nh:</strong> T·ª∑ l·ªá ƒë√∫ng gi·ªù ' + avgOntime.toFixed(1) + '% - C·∫ßn ƒëi·ªÅu ch·ªânh l·ªô tr√¨nh');
                else insights.push('üö® <strong>Hi·ªáu su·∫•t th·∫•p:</strong> T·ª∑ l·ªá ƒë√∫ng gi·ªù ' + avgOntime.toFixed(1) + '% - C·∫ßn xem x√©t to√†n di·ªán');
                
                // Drop rate insights
                if(avgDrop <= 5) insights.push('üéØ <strong>Qu·∫£n l√Ω t·ªët:</strong> T·ª∑ l·ªá r·ªõt h√†ng ch·ªâ ' + avgDrop.toFixed(1) + '%');
                else if(avgDrop <= 15) insights.push('üì¶ <strong>C·∫ßn theo d√µi:</strong> T·ª∑ l·ªá r·ªõt h√†ng ' + avgDrop.toFixed(1) + '% - M·ª©c ch·∫•p nh·∫≠n ƒë∆∞·ª£c');
                else insights.push('‚ö†Ô∏è <strong>C·∫ßn can thi·ªáp:</strong> T·ª∑ l·ªá r·ªõt h√†ng ' + avgDrop.toFixed(1) + '% - TƒÉng c∆∞·ªùng x·ª≠ l√Ω');
                
                // Load factor insights
                if(avgLoad >= 80) insights.push('üöõ <strong>T·ªëi ∆∞u t·∫£i:</strong> T·ª∑ l·ªá l·∫•p ƒë·∫ßy ' + avgLoad.toFixed(1) + '% - Hi·ªáu qu·∫£ cao');
                else if(avgLoad >= 60) insights.push('üìà <strong>C√≤n d∆∞ ƒë·ªãa:</strong> T·ª∑ l·ªá l·∫•p ƒë·∫ßy ' + avgLoad.toFixed(1) + '% - C√≥ th·ªÉ tƒÉng t·∫£i');
                else insights.push('üìâ <strong>Ch∆∞a t·ªëi ∆∞u:</strong> T·ª∑ l·ªá l·∫•p ƒë·∫ßy ' + avgLoad.toFixed(1) + '% - C·∫ßn t·ªëi ∆∞u h√≥a');
                
                // Time insights
                if(totalDelay > 0) {
                  insights.push('‚è±Ô∏è <strong>Th·ªùi gian:</strong> T·ªïng delay ' + totalDelay.toFixed(1) + ' gi·ªù - Trung b√¨nh ' + (totalDelay*60/totalTrips).toFixed(1) + ' ph√∫t/chuy·∫øn');
                }
                
                // Shift insights  
                var dominantShift = Object.keys(shiftStats).reduce(function(a, b) { return shiftStats[a] > shiftStats[b] ? a : b; });
                if(dominantShift !== 'Kh√°c') {
                  insights.push('üïê <strong>Ca l√†m vi·ªác:</strong> ' + dominantShift + ' chi·∫øm ∆∞u th·∫ø v·ªõi ' + shiftStats[dominantShift] + '/' + totalTrips + ' chuy·∫øn');
                }
                
                // Scenario recommendations
                if(window.scenarioConfig && Object.values(window.scenarioConfig).some(arr => arr.length > 0)) {
                  insights.push('üéõÔ∏è <strong>K·ªãch b·∫£n:</strong> ƒê√£ √°p d·ª•ng ' + Object.values(window.scenarioConfig).reduce((sum, arr) => sum + arr.length, 0) + ' y·∫øu t·ªë t√¨nh hu·ªëng');
                }
                
                // Final recommendations
                if(avgOntime < 70 || avgDrop > 15) {
                  insights.push('üí° <strong>Khuy·∫øn ngh·ªã:</strong> T·ªëi ∆∞u h√≥a l·ªãch tr√¨nh, tƒÉng buffer time, ki·ªÉm tra c√¥ng su·∫•t x·ª≠ l√Ω');
                } else {
                  insights.push('üí° <strong>Khuy·∫øn ngh·ªã:</strong> Duy tr√¨ hi·ªáu su·∫•t hi·ªán t·∫°i, ti·∫øp t·ª•c theo d√µi v√† c·∫£i ti·∫øn li√™n t·ª•c');
                }
              }
              
              insightsDiv.innerHTML = insights.map(function(ins){
                return '<p class="flex items-start gap-2 mb-2"><span class="text-orange-500 flex-shrink-0">‚Ä¢</span><span class="text-sm">' + ins + '</span></p>';
              }).join('');
            }
            
            // Update vehicle information by load capacity and shifts
            function updateVehicleInformation(trips) {
              if (!trips || trips.length === 0) return;
              
              // Initialize counters
              var vehicleStats = {
                heavy: { count: 0, trips: 0, weight: 0 },
                medium: { count: 0, trips: 0, weight: 0 },
                light: { count: 0, trips: 0, weight: 0 },
                van: { count: 0, trips: 0, weight: 0 },
                motorcycle: { count: 0, trips: 0, weight: 0 },
                other: { count: 0, trips: 0, weight: 0 }
              };
              
              var shiftStats = {
                morning: { total: 0, vehicles: JSON.parse(JSON.stringify(vehicleStats)) },
                afternoon: { total: 0, vehicles: JSON.parse(JSON.stringify(vehicleStats)) },
                night: { total: 0, vehicles: JSON.parse(JSON.stringify(vehicleStats)) }
              };
              
              var uniqueVehicles = new Set();
              var totalWeight = 0;
              
              // Process trips data
              trips.forEach(function(trip) {
                // Get vehicle info
                var vehicleCode = trip.vehicle_code || trip.code || 'unknown';
                var capacity = parseFloat(trip.vehicle_capacity || trip.capacity || 0);
                var weight = parseFloat(trip.pickup_weight || trip.weight || 0);
                var shift = getShiftFromTime(trip.checkin_time || trip.start_time || '');
                
                uniqueVehicles.add(vehicleCode);
                totalWeight += weight;
                
                // Categorize by capacity
                var category = categorizeVehicle(capacity);
                vehicleStats[category].trips++;
                vehicleStats[category].weight += weight;
                
                // Track by shift
                if (shift && shiftStats[shift]) {
                  shiftStats[shift].total++;
                  shiftStats[shift].vehicles[category].trips++;
                  shiftStats[shift].vehicles[category].weight += weight;
                }
              });
              
              // Count unique vehicles per category (simplified estimation)
              Object.keys(vehicleStats).forEach(function(category) {
                // Estimate vehicle count based on trips (assuming avg 2-3 trips per vehicle per day)
                vehicleStats[category].count = Math.ceil(vehicleStats[category].trips / 2.5);
              });
              
              // Update total summary
              document.getElementById('total-vehicles-count').textContent = uniqueVehicles.size + ' xe';
              document.getElementById('total-trips-summary').textContent = trips.length;
              document.getElementById('total-weight-summary').textContent = formatWeight(totalWeight);
              
              // Calculate average efficiency
              var totalEfficiency = trips.reduce(function(sum, trip) { return sum + (trip.load_factor || 0); }, 0);
              var avgEfficiency = trips.length > 0 ? Math.round(totalEfficiency / trips.length) : 0;
              document.getElementById('avg-efficiency-summary').textContent = avgEfficiency + '%';
              
              // Update vehicle type counts
              document.getElementById('heavy-truck-count').textContent = vehicleStats.heavy.count;
              document.getElementById('heavy-truck-trips').textContent = vehicleStats.heavy.trips + ' chuy·∫øn';
              
              document.getElementById('medium-truck-count').textContent = vehicleStats.medium.count;
              document.getElementById('medium-truck-trips').textContent = vehicleStats.medium.trips + ' chuy·∫øn';
              
              document.getElementById('light-truck-count').textContent = vehicleStats.light.count;
              document.getElementById('light-truck-trips').textContent = vehicleStats.light.trips + ' chuy·∫øn';
              
              document.getElementById('van-count').textContent = vehicleStats.van.count;
              document.getElementById('van-trips').textContent = vehicleStats.van.trips + ' chuy·∫øn';
              
              document.getElementById('motorcycle-count').textContent = vehicleStats.motorcycle.count;
              document.getElementById('motorcycle-trips').textContent = vehicleStats.motorcycle.trips + ' chuy·∫øn';
              
              document.getElementById('other-vehicle-count').textContent = vehicleStats.other.count;
              document.getElementById('other-vehicle-trips').textContent = vehicleStats.other.trips + ' chuy·∫øn';
              
              // Update shift statistics
              updateShiftStatistics(shiftStats);
              
              // Hide no-data placeholders
              document.getElementById('vehicle-no-data').classList.add('hidden');
              
              console.log('Vehicle information updated:', vehicleStats, shiftStats);
            }
            
            // Categorize vehicle by capacity
            function categorizeVehicle(capacity) {
              if (capacity > 15000) return 'heavy';      // > 15 t·∫•n
              if (capacity > 5000) return 'medium';      // 5-15 t·∫•n  
              if (capacity > 1000) return 'light';       // 1-5 t·∫•n
              if (capacity > 200) return 'van';          // 200kg - 1 t·∫•n
              if (capacity > 0) return 'motorcycle';     // < 200kg
              return 'other';                            // Unknown/special
            }
            
            // Get shift from time
            function getShiftFromTime(timeStr) {
              if (!timeStr) return null;
              
              var hour = 0;
              if (timeStr.includes(':')) {
                hour = parseInt(timeStr.split(':')[0]);
              } else {
                // Handle other time formats
                var match = timeStr.match(/(\d{1,2})/);
                if (match) hour = parseInt(match[1]);
              }
              
              if (hour >= 6 && hour < 14) return 'morning';
              if (hour >= 14 && hour < 22) return 'afternoon';
              return 'night';
            }
            
            // Update shift statistics display
            function updateShiftStatistics(shiftStats) {
              // Morning shift
              document.getElementById('morning-shift-total').textContent = shiftStats.morning.total + ' chuy·∫øn';
              populateShiftVehicles('morning-shift-vehicles', shiftStats.morning.vehicles);
              
              // Afternoon shift  
              document.getElementById('afternoon-shift-total').textContent = shiftStats.afternoon.total + ' chuy·∫øn';
              populateShiftVehicles('afternoon-shift-vehicles', shiftStats.afternoon.vehicles);
              
              // Night shift
              document.getElementById('night-shift-total').textContent = shiftStats.night.total + ' chuy·∫øn';
              populateShiftVehicles('night-shift-vehicles', shiftStats.night.vehicles);
              
              // Hide no-data if we have data
              if (shiftStats.morning.total > 0 || shiftStats.afternoon.total > 0 || shiftStats.night.total > 0) {
                document.getElementById('shift-no-data').classList.add('hidden');
              }
            }
            
            // Populate shift vehicles display
            function populateShiftVehicles(containerId, vehicles) {
              var container = document.getElementById(containerId);
              if (!container) return;
              
              var html = '';
              var categories = [
                {key: 'heavy', icon: 'üöõ', name: 'N·∫∑ng', color: 'red'},
                {key: 'medium', icon: 'üöö', name: 'Trung', color: 'orange'},
                {key: 'light', icon: 'üöê', name: 'Nh·∫π', color: 'green'},
                {key: 'van', icon: 'üöô', name: 'Van', color: 'blue'},
                {key: 'motorcycle', icon: 'üèçÔ∏è', name: 'Xe m√°y', color: 'purple'},
                {key: 'other', icon: 'üöó', name: 'Kh√°c', color: 'gray'}
              ];
              
              categories.forEach(function(cat) {
                var count = Math.ceil(vehicles[cat.key].trips / 2.5); // Estimate vehicle count
                var trips = vehicles[cat.key].trips;
                
                html += '<div class="bg-white border-2 border-' + cat.color + '-200 rounded-lg p-3 text-center">' +
                        '<div class="text-lg mb-1">' + cat.icon + '</div>' +
                        '<div class="text-xs font-medium text-gray-700 mb-1">' + cat.name + '</div>' +
                        '<div class="text-lg font-bold text-' + cat.color + '-600">' + count + '</div>' +
                        '<div class="text-xs text-gray-500">' + trips + ' chuy·∫øn</div>' +
                        '</div>';
              });
              
              container.innerHTML = html;
            }
            
            // Format weight display
            function formatWeight(weight) {
              if (weight >= 1000000) {
                return Math.round(weight / 1000000) + ' ngh√¨n t·∫•n';
              }
              if (weight >= 1000) {
                return Math.round(weight / 1000) + ' t·∫•n';
              }
              return Math.round(weight) + ' kg';
            }
            
            function updateForecastCharts(trips) {
              // Update vehicle information
              updateVehicleInformation(trips);
              
              // Update daily performance chart
              updateDailyPerformanceChart(trips);
              
              // Update time distribution chart  
              updateTimeDistributionChart(trips);
              
              // Update route comparison chart
              updateRouteComparisonChart(trips);
              
              // Update cargo volume chart
              updateCargoVolumeChart(trips);
            }
            
            function updateDailyPerformanceChart(trips) {
              var canvas = document.getElementById('daily-performance-chart');
              if(!canvas) return;
              
              // Group trips by date
              var dailyData = {};
              trips.forEach(function(trip) {
                var date = trip.date || 'Unknown';
                if(!dailyData[date]) {
                  dailyData[date] = { ontime: [], drop: [], load: [], count: 0 };
                }
                dailyData[date].count++;
                if(trip.ontime_rate_percent != null) dailyData[date].ontime.push(trip.ontime_rate_percent);
                if(trip.drop_rate_percent != null) dailyData[date].drop.push(trip.drop_rate_percent);
                if(trip.load_factor != null) dailyData[date].load.push(trip.load_factor);
              });
              
              // Prepare chart data
              var dates = Object.keys(dailyData).sort();
              var ontimeData = dates.map(function(date) {
                var values = dailyData[date].ontime;
                return values.length > 0 ? values.reduce((a,b) => a+b, 0) / values.length : 0;
              });
              
              // Simple canvas drawing (fallback without Chart.js)
              var ctx = canvas.getContext('2d');
              ctx.clearRect(0, 0, canvas.width, canvas.height);
              ctx.fillStyle = '#f97316';
              ctx.font = '12px Arial';
              ctx.fillText('üìà Performance by Day: ' + dates.length + ' days', 10, 20);
              
              // Draw simple bars
              var barWidth = Math.min(40, (canvas.width - 40) / dates.length);
              ontimeData.forEach(function(value, index) {
                var height = (value / 100) * (canvas.height - 60);
                var x = 20 + index * barWidth;
                var y = canvas.height - 20 - height;
                
                ctx.fillStyle = '#10b981';
                ctx.fillRect(x, y, barWidth - 5, height);
                
                ctx.fillStyle = '#374151';
                ctx.font = '8px Arial';
                ctx.fillText(value.toFixed(0) + '%', x + 2, y - 2);
              });
            }
            
            function updateTimeDistributionChart(trips) {
              var canvas = document.getElementById('time-distribution-chart');
              if(!canvas) return;
              
              var ctx = canvas.getContext('2d');
              ctx.clearRect(0, 0, canvas.width, canvas.height);
              ctx.fillStyle = '#6366f1';
              ctx.font = '12px Arial';
              ctx.fillText('‚è±Ô∏è Time Distribution: Service vs Delay', 10, 20);
              
              // Calculate totals
              var totalService = 0, totalDelay = 0;
              trips.forEach(function(trip) {
                if(trip.predicted_total_server_time_sec) totalService += trip.predicted_total_server_time_sec;
                if(trip.predicted_total_delay_sec) totalDelay += trip.predicted_total_delay_sec;
              });
              
              if(totalService + totalDelay > 0) {
                var serviceRatio = totalService / (totalService + totalDelay);
                var delayRatio = totalDelay / (totalService + totalDelay);
                
                // Draw pie chart
                var centerX = canvas.width / 2;
                var centerY = canvas.height / 2;
                var radius = Math.min(centerX, centerY) - 40;
                
                // Service time (green)
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, -Math.PI/2, -Math.PI/2 + serviceRatio * 2 * Math.PI);
                ctx.closePath();
                ctx.fillStyle = '#10b981';
                ctx.fill();
                
                // Delay time (red)  
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, -Math.PI/2 + serviceRatio * 2 * Math.PI, Math.PI * 1.5);
                ctx.closePath();
                ctx.fillStyle = '#ef4444';
                ctx.fill();
                
                // Labels
                ctx.fillStyle = '#374151';
                ctx.font = '10px Arial';
                ctx.fillText('Service: ' + (serviceRatio * 100).toFixed(1) + '%', 10, canvas.height - 30);
                ctx.fillText('Delay: ' + (delayRatio * 100).toFixed(1) + '%', 10, canvas.height - 15);
              }
            }
            
            function updateRouteComparisonChart(trips) {
              var canvas = document.getElementById('route-comparison-chart');
              if(!canvas) return;
              
              var ctx = canvas.getContext('2d');
              ctx.clearRect(0, 0, canvas.width, canvas.height);
              ctx.fillStyle = '#f59e0b';
              ctx.font = '12px Arial';
              ctx.fillText('üó∫Ô∏è Routes: ' + trips.length + ' trips across routes', 10, 20);
              
              // Group by route efficiency
              var routes = {};
              trips.forEach(function(trip) {
                var routeKey = (trip.route || 'Unknown').substring(0, 20) + '...';
                if(!routes[routeKey]) {
                  routes[routeKey] = { count: 0, avgOntime: 0, totalOntime: 0 };
                }
                routes[routeKey].count++;
                if(trip.ontime_rate_percent != null) {
                  routes[routeKey].totalOntime += trip.ontime_rate_percent;
                }
              });
              
              // Calculate averages and draw
              var routeNames = Object.keys(routes).slice(0, 5); // Top 5 routes
              routeNames.forEach(function(routeName, index) {
                var route = routes[routeName];
                var avgOntime = route.count > 0 ? route.totalOntime / route.count : 0;
                
                var y = 40 + index * 30;
                var barWidth = (avgOntime / 100) * (canvas.width - 150);
                
                ctx.fillStyle = '#3b82f6';
                ctx.fillRect(100, y, barWidth, 20);
                
                ctx.fillStyle = '#374151';
                ctx.font = '10px Arial';
                ctx.fillText(routeName, 5, y + 14);
                ctx.fillText(avgOntime.toFixed(1) + '%', 105 + barWidth, y + 14);
              });
            }
            
            function updateCargoVolumeChart(trips) {
              var canvas = document.getElementById('cargo-volume-chart');
              if(!canvas) return;
              
              var ctx = canvas.getContext('2d');
              ctx.clearRect(0, 0, canvas.width, canvas.height);
              ctx.fillStyle = '#8b5cf6';
              ctx.font = '12px Arial';
              ctx.fillText('üì¶ Cargo Volume by Day', 10, 20);
              
              // Group by date
              var dailyVolume = {};
              trips.forEach(function(trip) {
                var date = trip.date || 'Unknown';
                if(!dailyVolume[date]) {
                  dailyVolume[date] = { pickup: 0, delivery: 0 };
                }
                dailyVolume[date].pickup += trip.pickup_volume || 0;
                dailyVolume[date].delivery += trip.delivery_volume || 0;
              });
              
              var dates = Object.keys(dailyVolume).sort().slice(0, 7); // Last 7 days
              var maxVolume = Math.max(...dates.map(d => dailyVolume[d].pickup + dailyVolume[d].delivery));
              
              dates.forEach(function(date, index) {
                var data = dailyVolume[date];
                var x = 50 + index * 40;
                var pickupHeight = maxVolume > 0 ? (data.pickup / maxVolume) * (canvas.height - 80) : 0;
                var deliveryHeight = maxVolume > 0 ? (data.delivery / maxVolume) * (canvas.height - 80) : 0;
                
                // Pickup (green)
                ctx.fillStyle = '#10b981';
                ctx.fillRect(x, canvas.height - 40 - pickupHeight, 15, pickupHeight);
                
                // Delivery (orange)
                ctx.fillStyle = '#f59e0b';
                ctx.fillRect(x + 18, canvas.height - 40 - deliveryHeight, 15, deliveryHeight);
                
                // Date label
                ctx.fillStyle = '#374151';
                ctx.font = '8px Arial';
                ctx.fillText(date.substr(-5), x, canvas.height - 10);
              });
              
              // Legend
              ctx.fillStyle = '#10b981';
              ctx.fillRect(10, canvas.height - 35, 10, 10);
              ctx.fillStyle = '#374151';
              ctx.font = '10px Arial';
              ctx.fillText('Pickup', 25, canvas.height - 27);
              
              ctx.fillStyle = '#f59e0b';
              ctx.fillRect(70, canvas.height - 35, 10, 10);
              ctx.fillText('Delivery', 85, canvas.height - 27);
            }

            function updateVehicleStats(trips){
              if(!trips || trips.length === 0){
                // Reset to empty state
                var totalGrid = $('vehicle-total-grid');
                var shiftContainer = $('vehicle-shift-container');
                if(totalGrid) totalGrid.innerHTML = '<div class="text-center text-xs text-gray-400 col-span-full py-4">Ch∆∞a c√≥ d·ªØ li·ªáu ph∆∞∆°ng ti·ªán</div>';
                if(shiftContainer) shiftContainer.innerHTML = '<div class="text-center text-xs text-gray-400 py-4">Ch∆∞a c√≥ d·ªØ li·ªáu ph∆∞∆°ng ti·ªán theo ca</div>';
                return;
              }

              // Aggregate vehicle types
              var vehicleTypeCount = {};
              var vehicleByShift = {};
              
              trips.forEach(function(trip){
                // Determine vehicle type from capacity or vehicle_id
                var capacity = trip.vehicle_payload_capacity_kg || 0;
                var vehicleType = 'Kh√°c';
                if(capacity >= 8000) vehicleType = '8 t·∫•n+';
                else if(capacity >= 5000) vehicleType = '5 t·∫•n';
                else if(capacity >= 3500) vehicleType = '3.5 t·∫•n';
                else if(capacity >= 1900) vehicleType = '1.9 t·∫•n';
                else if(capacity > 0) vehicleType = 'Nh·ªè (<1.9t)';
                else if(trip.vehicle_id && trip.vehicle_id.includes('1.9')) vehicleType = '1.9 t·∫•n';
                else if(trip.vehicle_id && trip.vehicle_id.includes('3.5')) vehicleType = '3.5 t·∫•n';
                else if(trip.vehicle_id && trip.vehicle_id.includes('5')) vehicleType = '5 t·∫•n';
                
                var shift = trip.shift || 'Kh√¥ng x√°c ƒë·ªãnh';
                
                // Total count
                if(!vehicleTypeCount[vehicleType]) vehicleTypeCount[vehicleType] = 0;
                vehicleTypeCount[vehicleType]++;
                
                // By shift
                if(!vehicleByShift[shift]) vehicleByShift[shift] = {};
                if(!vehicleByShift[shift][vehicleType]) vehicleByShift[shift][vehicleType] = 0;
                vehicleByShift[shift][vehicleType]++;
              });

              // Render total view
              var totalGrid = $('vehicle-total-grid');
              if(totalGrid){
                var html = '';
                var typeNames = Object.keys(vehicleTypeCount).sort();
                if(typeNames.length === 0){
                  html = '<div class="text-center text-xs text-gray-400 col-span-full py-4">Ch∆∞a c√≥ d·ªØ li·ªáu ph∆∞∆°ng ti·ªán</div>';
                } else {
                  typeNames.forEach(function(type){
                    var count = vehicleTypeCount[type];
                    var icon = 'üöõ';
                    var color = 'blue';
                    
                    // Set icon and color by vehicle type
                    if(type.includes('1.9') || type === 'Nh·ªè (<1.9t)') {
                      icon = 'üöê';
                      color = 'green';
                    } else if(type.includes('3.5')) {
                      icon = 'ÔøΩ';
                      color = 'orange';
                    } else if(type.includes('5')) {
                      icon = 'üöõ';
                      color = 'blue';
                    } else if(type.includes('8') || type.includes('+')) {
                      icon = 'ÔøΩ';
                      color = 'purple';
                    }
                    
                    html += '<div class="bg-gradient-to-br from-' + color + '-50 to-' + color + '-100 border border-' + color + '-200 rounded-lg p-3 text-center hover:shadow-md transition-shadow">';
                    html += '  <div class="text-2xl mb-1">' + icon + '</div>';
                    html += '  <div class="text-xs font-medium text-gray-700 mb-1">' + type + '</div>';
                    html += '  <div class="text-lg font-bold text-' + color + '-600">' + count + ' xe</div>';
                    html += '</div>';
                  });
                }
                totalGrid.innerHTML = html;
              }

              // Render shift view
              var shiftContainer = $('vehicle-shift-container');
              if(shiftContainer){
                var html = '';
                var shifts = Object.keys(vehicleByShift).sort();
                if(shifts.length === 0){
                  html = '<div class="text-center text-xs text-gray-400 py-4">Ch∆∞a c√≥ d·ªØ li·ªáu ph∆∞∆°ng ti·ªán theo ca</div>';
                } else {
                  shifts.forEach(function(shift){
                    html += '<div class="bg-gradient-to-r from-purple-50 to-purple-100 border border-purple-200 rounded-lg p-4">';
                    html += '  <div class="flex items-center gap-2 mb-3">';
                    html += '    <span class="text-purple-600 text-lg">‚è∞</span>';
                    html += '    <h5 class="text-sm font-bold text-gray-900">Ca: ' + shift + '</h5>';
                    html += '  </div>';
                    html += '  <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-2">';
                    
                    var types = Object.keys(vehicleByShift[shift]).sort();
                    types.forEach(function(type){
                      var count = vehicleByShift[shift][type];
                      var icon = 'üöõ';
                      if(type.includes('1.9') || type.includes('1,9')) icon = 'üöê';
                      else if(type.includes('5') || type.includes('t·∫•n 5')) icon = 'üöö';
                      
                      html += '<div class="bg-white border border-purple-200 rounded p-2 text-center">';
                      html += '  <div class="text-lg">' + icon + '</div>';
                      html += '  <div class="text-xs text-gray-600 truncate" title="' + type + '">' + type + '</div>';
                      html += '  <div class="text-sm font-bold text-purple-600">' + count + '</div>';
                      html += '</div>';
                    });
                    
                    html += '  </div>';
                    html += '</div>';
                  });
                }
                shiftContainer.innerHTML = html;
              }
            }

            function handleResponse(json){
              console.log('predict response', json);
              if(json && typeof json === 'object'){
                
                // Handle Journey data structure from API
                var journeyData = json.data || json; // Support both response wrapper and direct journey
                var trips = [];
                
                // Extract trips from Journey schedule
                if(journeyData && journeyData.schedule){
                  console.log('Processing Journey schedule:', journeyData.schedule);
                  trips = extractTripsFromJourney(journeyData);
                } 
                // Fallback: Handle legacy format
                else if(json.trips && Array.isArray(json.trips)){
                  trips = json.trips;
                }
                
                // Process summary if provided
                if(json.summary){
                  updateForecastSummaryFromAPI(json.summary);
                }
                // Calculate summary from extracted trips
                else if(trips.length > 0){
                  updateForecastSummary(trips);
                  updateForecastInsights(trips);
                }
                
                // Store trips data globally for chart updates
                window.lastTripsData = trips;
                
                // Render trips table
                if(trips.length > 0){
                  console.log('Rendering', trips.length, 'trips');
                  renderTripsTable(trips);
                  // Update both legacy vehicle stats renderer and the newer vehicle information
                  if (typeof updateVehicleStats === 'function') {
                    try { updateVehicleStats(trips); } catch(e){ console.error('updateVehicleStats error', e); }
                  }
                  if (typeof updateVehicleInformation === 'function') {
                    try { updateVehicleInformation(trips); } catch(e){ console.error('updateVehicleInformation error', e); }
                  }

                  // Forecast results section has been removed - no longer updating it
                  // Removed: updateForecastResults, updateForecastCharts, moveForecastToPreview calls
                } else {
                  console.warn('No trips found in response');
                }
              }
            }

            // Apply KTC timing parameters to trips for local visualization
            function applyKtcTimingToTrips(trips, ktcParams){
              if(!trips || !Array.isArray(trips)) return trips;
              var travelSec = (ktcParams && parseInt(ktcParams.travel_minutes,10)) ? parseInt(ktcParams.travel_minutes,10)*60 : 30*60;
              var returnMaxSec = (ktcParams && parseInt(ktcParams.return_max_delay_minutes,10)) ? parseInt(ktcParams.return_max_delay_minutes,10)*60 : 60*60;
              trips.forEach(function(t){
                t.simulated_travel_seconds = travelSec;
                t.simulated_return_max_delay_seconds = returnMaxSec;
                // Provide simulated times without overwriting server times
                if(!t.simulated_checkin_time && (t.expected_checkin_time || t.checkin_time)){
                  var base = t.checkin_time || t.expected_checkin_time || null;
                  if(base) t.simulated_checkin_time = base + travelSec;
                }
                if(!t.simulated_checkout_time && (t.expected_checkout_time || t.checkout_time)){
                  var base2 = t.checkout_time || t.expected_checkout_time || null;
                  if(base2) t.simulated_checkout_time = base2 + travelSec;
                }
              });
              return trips;
            }

            // Simple truck animation for KTC flow card
            var _ktcAnimationHandle = null;
            function animateKtcFlow(ktcParams){
              var svg = document.getElementById('ktc-flow-svg');
              var truck = document.getElementById('ktc-flow-truck');
              if(!svg || !truck) return;
              // clear any existing animation
              if(_ktcAnimationHandle){ clearInterval(_ktcAnimationHandle); _ktcAnimationHandle = null; }

              var animateEnabled = !!(ktcParams && ktcParams.animate);
              if(!animateEnabled) {
                // reset position
                truck.setAttribute('transform','translate(100,40)');
                return;
              }

              var travelMinutes = parseInt(ktcParams.travel_minutes || 30,10) || 30;
              // scale: 200ms per minute (so 30min -> 6s animation)
              var duration = Math.max(800, travelMinutes * 200);
              var startX = 100; var endX = 280;
              var start = null;
              var forward = true;
              var cycles = 0;

              function step(ts){
                if(!start) start = ts;
                var elapsed = ts - start;
                var t = Math.min(1, elapsed / duration);
                var x = forward ? (startX + (endX - startX) * t) : (endX - (endX - startX) * t);
                truck.setAttribute('transform','translate(' + x + ',40)');
                if(t >= 1){
                  // flip direction
                  forward = !forward;
                  start = ts;
                  cycles++;
                }
                // run for 4 half-cycles (2 full back-and-forth)
                if(cycles >= 4){
                  // stop and reset to start
                  truck.setAttribute('transform','translate(100,40)');
                  cancelAnimationFrame(_ktcAnimationHandle);
                  _ktcAnimationHandle = null;
                  return;
                }
                _ktcAnimationHandle = requestAnimationFrame(step);
              }
              _ktcAnimationHandle = requestAnimationFrame(step);
            }
            
            // Extract trips from Journey data structure
            function extractTripsFromJourney(journey) {
              var trips = [];
              
              if(!journey || !journey.schedule) return trips;
              
              // Iterate through schedule dates
              Object.keys(journey.schedule).forEach(function(date) {
                var tripData = journey.schedule[date];
                
                if(tripData && tripData.vehicle_trips) {
                  tripData.vehicle_trips.forEach(function(vehicleTrip) {
                    var trip = {
                      date: date,
                      vehicle_id: vehicleTrip.vehicle_id,
                      vehicle_payload_capacity_kg: vehicleTrip.vehicle_payload_capacity_kg,
                      
                      // Performance metrics
                      ontime_rate_percent: vehicleTrip.ontime_rate_percent || 0,
                      drop_rate_percent: vehicleTrip.drop_rate_percent || vehicleTrip.predicted_drop_rate || 0,
                      fill_rate_percent: vehicleTrip.fill_rate_percent || vehicleTrip.predicted_fill_rate || 0,
                      
                      // Totals
                      predicted_total_pickup_kg: vehicleTrip.predicted_total_pickup_kg || 0,
                      predicted_total_delivery_kg: vehicleTrip.predicted_total_delivery_kg || 0,
                      predicted_total_delay_sec: vehicleTrip.predicted_total_delay_sec || 0,
                      predicted_total_server_time_sec: vehicleTrip.predicted_total_server_time_sec || 0,
                      predicted_total_trip_time_sec: vehicleTrip.predicted_total_trip_time_sec || 0,
                      
                      // Load factor (using fill_rate as proxy)
                      load_factor: vehicleTrip.fill_rate_percent || vehicleTrip.predicted_fill_rate || 0,
                      
                      // Times (extract from first/last stops)
                      check_in: getFirstStopTime(vehicleTrip.stops, 'checkin_time'),
                      check_out: getLastStopTime(vehicleTrip.stops, 'checkout_time'),
                      
                      // Route info
                      route: buildRouteString(vehicleTrip.stops),
                      stops_count: (vehicleTrip.stops && vehicleTrip.stops.length) || 0,
                      
                      // Shift (extract from time)
                      shift: determineShift(getFirstStopTime(vehicleTrip.stops, 'checkin_time')),
                      
                      // Processing status
                      processing: 'ƒê√£ m√¥ ph·ªèng',
                      
                      // Volume 
                      pickup_volume: vehicleTrip.predicted_total_pickup_kg || 0,
                      delivery_volume: vehicleTrip.predicted_total_delivery_kg || 0,
                      
                      // Raw data for popup
                      _raw_vehicle_trip: vehicleTrip,
                      _raw_stops: vehicleTrip.stops || []
                    };
                    
                    trips.push(trip);
                  });
                }
              });
              
              console.log('Extracted', trips.length, 'trips from journey');
              return trips;
            }
            
            // Helper functions for data extraction
            function getFirstStopTime(stops, timeField) {
              if(!stops || stops.length === 0) return null;
              var firstStop = stops.find(function(s) { return s[timeField] != null; });
              if(!firstStop || !firstStop[timeField]) return null;
              return formatTimeFromSeconds(firstStop[timeField]);
            }
            
            function getLastStopTime(stops, timeField) {
              if(!stops || stops.length === 0) return null;
              var validStops = stops.filter(function(s) { return s[timeField] != null; });
              if(validStops.length === 0) return null;
              var lastStop = validStops[validStops.length - 1];
              return formatTimeFromSeconds(lastStop[timeField]);
            }
            
            function formatTimeFromSeconds(seconds) {
              if(!seconds || seconds < 0) return null;
              var hours = Math.floor(seconds / 3600);
              var minutes = Math.floor((seconds % 3600) / 60);
              return hours.toString().padStart(2, '0') + ':' + minutes.toString().padStart(2, '0');
            }
            
            function buildRouteString(stops) {
              if(!stops || stops.length === 0) return '-';
              var names = stops.map(function(s) { return s.name || 'Stop'; }).filter(Boolean);
              if(names.length <= 2) return names.join(' ‚Üí ');
              return names[0] + ' ‚Üí ... ‚Üí ' + names[names.length - 1] + ' (' + names.length + ' ƒëi·ªÉm)';
            }
            
            function determineShift(timeStr) {
              if(!timeStr) return '-';
              var parts = timeStr.split(':');
              var hour = parseInt(parts[0] || 0);
              if(hour >= 6 && hour < 14) return 'Ca 1';
              if(hour >= 14 && hour < 22) return 'Ca 2';
              return 'Ca 3';
            }
            
            // Update forecast from API summary
            function updateForecastSummaryFromAPI(summary) {
              // Helper to safely set textContent
              function setText(id, value) {
                var el = $(id);
                if (el) {
                  el.textContent = value;
                }
              }
              
              if (!$('forecast-total-trips') && !$('forecast-ontime-rate') && !$('forecast-drop-rate') && !$('forecast-load-factor')) {
                // Elements don't exist, skip update
                return;
              }
              
              setText('forecast-total-trips', summary.total_trips || '0');
              setText('forecast-ontime-rate', (summary.ontime_rate != null) ? (summary.ontime_rate.toFixed(1) + '%') : '0%');
              setText('forecast-drop-rate', (summary.drop_rate_percent != null) ? (summary.drop_rate_percent.toFixed(1) + '%') : ((summary.drop_rate != null) ? (summary.drop_rate.toFixed(1) + '%') : '0%'));
              setText('forecast-load-factor', (summary.load_factor != null) ? (summary.load_factor.toFixed(1) + '%') : '0%');
            }

            // Helper: Create timeline visualization for check-in/check-out
            function createTimelineHTML(trip) {
              // Parse times (assuming format HH:MM or HH:MM:SS)
              var parseTime = function(timeStr) {
                if (!timeStr) return null;
                var parts = timeStr.split(':');
                if (parts.length < 2) return null;
                return parseInt(parts[0]) * 60 + parseInt(parts[1]); // minutes from midnight
              };
              
              var checkInActual = parseTime(trip.check_in || trip.checkin);
              var checkOutActual = parseTime(trip.check_out || trip.checkout);
              var checkInPlan = parseTime(trip.check_in_plan || trip.planned_check_in);
              var checkOutPlan = parseTime(trip.check_out_plan || trip.planned_check_out);
              
              // If we don't have any data, return simple text
              if (!checkInActual && !checkOutActual && !checkInPlan && !checkOutPlan) {
                return {
                  checkIn: '<div class="text-xs text-gray-400">-</div>',
                  checkOut: '<div class="text-xs text-gray-400">-</div>'
                };
              }
              
              // Calculate time window (earliest to latest)
              var times = [checkInActual, checkOutActual, checkInPlan, checkOutPlan].filter(function(t){ return t != null; });
              if (times.length === 0) {
                return {
                  checkIn: '<div class="text-xs text-gray-400">-</div>',
                  checkOut: '<div class="text-xs text-gray-400">-</div>'
                };
              }
              
              var minTime = Math.min.apply(null, times);
              var maxTime = Math.max.apply(null, times);
              var timeRange = maxTime - minTime;
              if (timeRange === 0) timeRange = 60; // min 1 hour range
              
              // Add padding to timeline
              var padding = timeRange * 0.2;
              var timelineStart = minTime - padding;
              var timelineEnd = maxTime + padding;
              var timelineRange = timelineEnd - timelineStart;
              
              // Helper to calculate position (0-100%)
              var getPosition = function(time) {
                if (time == null) return null;
                return ((time - timelineStart) / timelineRange) * 100;
              };
              
              // Helper to format time
              var formatTime = function(minutes) {
                if (minutes == null) return '-';
                var h = Math.floor(minutes / 60);
                var m = minutes % 60;
                return (h < 10 ? '0' : '') + h + ':' + (m < 10 ? '0' : '') + m;
              };
              
              // Calculate deviations (in minutes)
              var checkInDeviation = (checkInActual != null && checkInPlan != null) ? (checkInActual - checkInPlan) : null;
              var checkOutDeviation = (checkOutActual != null && checkOutPlan != null) ? (checkOutActual - checkOutPlan) : null;
              
              // Determine colors based on deviation
              var getStatusColor = function(deviation) {
                if (deviation == null) return '#9ca3af'; // gray
                if (Math.abs(deviation) <= 5) return '#10b981'; // green - on time (within 5 min)
                if (deviation < 0) return '#3b82f6'; // blue - early
                return '#ef4444'; // red - late
              };
              
              var getStatusText = function(deviation) {
                if (deviation == null) return '';
                if (Math.abs(deviation) <= 5) return 'ƒê√∫ng gi·ªù';
                if (deviation < 0) return 'S·ªõm ' + Math.abs(deviation) + 'p';
                return 'Tr·ªÖ ' + deviation + 'p';
              };
              
              // Build Check-In Timeline SVG
              var checkInHTML = '<div class="relative" style="min-width: 160px;">';
              checkInHTML += '  <svg viewBox="0 0 200 60" class="w-full h-14">';
              checkInHTML += '    <!-- Timeline base -->';
              checkInHTML += '    <line x1="10" y1="30" x2="190" y2="30" stroke="#e5e7eb" stroke-width="3"/>';
              
              // Planned check-in marker
              if (checkInPlan != null) {
                var planPos = getPosition(checkInPlan);
                var planX = 10 + (planPos / 100) * 180;
                checkInHTML += '    <circle cx="' + planX + '" cy="30" r="5" fill="#fb923c" stroke="#fff" stroke-width="2"/>';
                checkInHTML += '    <text x="' + planX + '" y="12" text-anchor="middle" font-size="8" fill="#fb923c" font-weight="600">KH</text>';
              }
              
              // Actual check-in marker
              if (checkInActual != null) {
                var actualPos = getPosition(checkInActual);
                var actualX = 10 + (actualPos / 100) * 180;
                var color = getStatusColor(checkInDeviation);
                checkInHTML += '    <circle cx="' + actualX + '" cy="30" r="6" fill="' + color + '" stroke="#fff" stroke-width="2"/>';
                checkInHTML += '    <text x="' + actualX + '" y="50" text-anchor="middle" font-size="8" fill="#374151" font-weight="600">TT</text>';
                
                // Connection line between planned and actual
                if (checkInPlan != null) {
                  var planX2 = 10 + (getPosition(checkInPlan) / 100) * 180;
                  checkInHTML += '    <line x1="' + planX2 + '" y1="30" x2="' + actualX + '" y2="30" stroke="' + color + '" stroke-width="4" stroke-dasharray="2,2" opacity="0.6"/>';
                }
              }
              
              checkInHTML += '  </svg>';
              checkInHTML += '  <div class="flex items-center justify-between px-2 mt-1">';
              checkInHTML += '    <span class="text-xs font-medium text-gray-700">' + formatTime(checkInActual || checkInPlan) + '</span>';
              if (checkInDeviation != null) {
                var statusColor = getStatusColor(checkInDeviation);
                checkInHTML += '    <span class="text-xs font-semibold px-2 py-0.5 rounded" style="color: ' + statusColor + '; background-color: ' + statusColor + '20;">' + getStatusText(checkInDeviation) + '</span>';
              }
              checkInHTML += '  </div>';
              checkInHTML += '</div>';
              
              // Build Check-Out Timeline SVG
              var checkOutHTML = '<div class="relative" style="min-width: 160px;">';
              checkOutHTML += '  <svg viewBox="0 0 200 60" class="w-full h-14">';
              checkOutHTML += '    <!-- Timeline base -->';
              checkOutHTML += '    <line x1="10" y1="30" x2="190" y2="30" stroke="#e5e7eb" stroke-width="3"/>';
              
              // Planned check-out marker
              if (checkOutPlan != null) {
                var planPos = getPosition(checkOutPlan);
                var planX = 10 + (planPos / 100) * 180;
                checkOutHTML += '    <circle cx="' + planX + '" cy="30" r="5" fill="#fb923c" stroke="#fff" stroke-width="2"/>';
                checkOutHTML += '    <text x="' + planX + '" y="12" text-anchor="middle" font-size="8" fill="#fb923c" font-weight="600">KH</text>';
              }
              
              // Actual check-out marker
              if (checkOutActual != null) {
                var actualPos = getPosition(checkOutActual);
                var actualX = 10 + (actualPos / 100) * 180;
                var color = getStatusColor(checkOutDeviation);
                checkOutHTML += '    <circle cx="' + actualX + '" cy="30" r="6" fill="' + color + '" stroke="#fff" stroke-width="2"/>';
                checkOutHTML += '    <text x="' + actualX + '" y="50" text-anchor="middle" font-size="8" fill="#374151" font-weight="600">TT</text>';
                
                // Connection line between planned and actual
                if (checkOutPlan != null) {
                  var planX2 = 10 + (getPosition(checkOutPlan) / 100) * 180;
                  checkOutHTML += '    <line x1="' + planX2 + '" y1="30" x2="' + actualX + '" y2="30" stroke="' + color + '" stroke-width="4" stroke-dasharray="2,2" opacity="0.6"/>';
                }
              }
              
              checkOutHTML += '  </svg>';
              checkOutHTML += '  <div class="flex items-center justify-between px-2 mt-1">';
              checkOutHTML += '    <span class="text-xs font-medium text-gray-700">' + formatTime(checkOutActual || checkOutPlan) + '</span>';
              if (checkOutDeviation != null) {
                var statusColor = getStatusColor(checkOutDeviation);
                checkOutHTML += '    <span class="text-xs font-semibold px-2 py-0.5 rounded" style="color: ' + statusColor + '; background-color: ' + statusColor + '20;">' + getStatusText(checkOutDeviation) + '</span>';
              }
              checkOutHTML += '  </div>';
              checkOutHTML += '</div>';
              
              return {
                checkIn: checkInHTML,
                checkOut: checkOutHTML
              };
            }

            function renderTripsTable(trips){
              var tbody = $('simulation-table-body-2');
              if(!tbody) return;
              tbody.innerHTML = '';
              
              if (!trips || trips.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="px-6 py-8 text-center text-sm text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
                return;
              }
              
              // Build hierarchy: date -> shift -> vehicle -> stops
              var hierarchy = {};
              trips.forEach(function(trip) {
                var date = trip.date || 'N/A';
                var shift = trip.shift || trip.shift_name || 'Unknown';
                var vehicle = trip.vehicle_id || trip.code || trip.vehicle_code || 'N/A';
                
                if (!hierarchy[date]) hierarchy[date] = {};
                if (!hierarchy[date][shift]) hierarchy[date][shift] = {};
                if (!hierarchy[date][shift][vehicle]) {
                  hierarchy[date][shift][vehicle] = trip;
                }
              });
              
              var html = '';
              
              // Format time helper
              var formatTime = function(timestamp) {
                if (!timestamp) return '‚Äî';
                if (typeof timestamp === 'number') {
                  var totalSeconds = Math.floor(timestamp);
                  var hours = Math.floor(totalSeconds / 3600);
                  var minutes = Math.floor((totalSeconds % 3600) / 60);
                  return (hours.toString().padStart(2, '0') + ':' + minutes.toString().padStart(2, '0'));
                }
                if (typeof timestamp === 'string') {
                  return timestamp; // Already formatted
                }
                return '‚Äî';
              };
              
              Object.keys(hierarchy).sort().forEach(function(date) {
                var shifts = hierarchy[date];
                
                // Calculate row counts for rowspan
                var dateRowCount = 0;
                Object.keys(shifts).forEach(function(shift) {
                  var vehicles = shifts[shift];
                  Object.keys(vehicles).forEach(function(vehicle) {
                    var trip = vehicles[vehicle];
                    var stops = trip._raw_stops || [];
                    dateRowCount += stops.length > 0 ? stops.length : 1;
                  });
                });
                
                var dateFirstRow = true;
                Object.keys(shifts).sort().forEach(function(shift) {
                  var vehicles = shifts[shift];
                  
                  var shiftRowCount = 0;
                  Object.keys(vehicles).forEach(function(vehicle) {
                    var trip = vehicles[vehicle];
                    var stops = trip._raw_stops || [];
                    shiftRowCount += stops.length > 0 ? stops.length : 1;
                  });
                  
                  var shiftFirstRow = true;
                  Object.keys(vehicles).sort().forEach(function(vehicle) {
                    var trip = vehicles[vehicle];
                    var stops = trip._raw_stops || [];
                    
                    if (stops.length === 0) {
                      // No stops - render single row
                      html += '<tr class="hover:bg-blue-50 border-b border-gray-200">';
                      if (dateFirstRow) {
                        html += '<td rowspan="' + dateRowCount + '" class="px-3 py-2 text-sm font-semibold text-gray-900 bg-gray-50 border-r border-gray-300 align-top">' + date + '</td>';
                        dateFirstRow = false;
                      }
                      if (shiftFirstRow) {
                        html += '<td rowspan="' + shiftRowCount + '" class="px-3 py-2 text-sm font-medium text-gray-800 bg-blue-50 border-r border-gray-300 align-top">' + shift + '</td>';
                        shiftFirstRow = false;
                      }
                      html += '<td class="px-3 py-3 border-r-2 border-gray-400 align-top bg-gradient-to-br from-orange-50 to-amber-50" style="min-width: 220px;">';
                      html += '  <div class="space-y-2">';
                      html += '    <div class="flex items-center gap-2 pb-2 border-b border-orange-200">';
                      html += '      <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" /></svg>';
                      html += '      <span class="font-bold text-base text-orange-900">' + vehicle + '</span>';
                      html += '    </div>';
                      html += '  </div>';
                      html += '</td>';
                      html += '<td colspan="8" class="px-2 py-2 text-sm text-gray-400 text-left align-top">Kh√¥ng c√≥ d·ªØ li·ªáu ƒëi·ªÉm d·ª´ng</td>';
                      html += '</tr>';
                    } else {
                      // Render each stop as a row
                      stops.forEach(function(stop, stopIdx) {
                        var isLastStop = stopIdx === stops.length - 1;
                        var borderClass = isLastStop ? 'border-b-2 border-gray-400' : 'border-b border-gray-100';
                        html += '<tr class="hover:bg-blue-50 ' + borderClass + '">';
                        
                        if (dateFirstRow) {
                          html += '<td rowspan="' + dateRowCount + '" class="px-3 py-2 text-sm font-semibold text-gray-900 bg-gray-50 border-r border-gray-300 align-top">' + date + '</td>';
                          dateFirstRow = false;
                        }
                        
                        if (shiftFirstRow) {
                          html += '<td rowspan="' + shiftRowCount + '" class="px-3 py-2 text-sm font-medium text-gray-800 bg-blue-50 border-r border-gray-300 align-top">' + shift + '</td>';
                          shiftFirstRow = false;
                        }
                        
                        // Vehicle info card (only first stop)
                        if (stopIdx === 0) {
                          var payloadCap = trip.vehicle_payload_capacity_kg || 0;
                          var ontimeDisplay = trip.ontime_rate_percent != null ? trip.ontime_rate_percent.toFixed(1) + '%' : '‚Äî';
                          var dropDisplay = trip.drop_rate_percent != null ? trip.drop_rate_percent.toFixed(1) + '%' : '‚Äî';
                          var fillDisplay = trip.fill_rate_percent != null ? trip.fill_rate_percent.toFixed(1) + '%' : '‚Äî';
                          
                          // Store route data in cache for visualization (similar to renderForecast2Table)
                          if (!window._routeDataCache) window._routeDataCache = {};
                          var routeDataFor3D = {
                            vehicle_code: vehicle,
                            date: date,
                            shift: shift,
                            vehicle_type: payloadCap ? (payloadCap/1000).toFixed(1) + 'T' : '-',
                            stops: stops.map(function(s) {
                              return {
                                stt: s.stt || 0,
                                stop_name: s.stop_name || s.name || '',
                                stop_type: s.stop_type || s.type || '',
                                distance_km: s.planned_distance_km || s.distance_km || 0,
                                average_speed: s.average_speed || 0,
                                expected_checkin_time: s.expected_checkin_time || s.planned_checkin_time,
                                checkin_time: s.checkin_time,
                                expected_checkout_time: s.expected_checkout_time || s.planned_checkout_time,
                                checkout_time: s.checkout_time,
                                pickup_weight_kg: s.pickup_weight_kg || 0,
                                delivery_weight_kg: s.delivery_weight_kg || 0,
                                loaded_weight_kg: s.load_on_truck || s.loaded_weight_kg || 0,
                                drop_rate: (s.drop_rate_percent != null) ? s.drop_rate_percent : (s.drop_rate != null ? s.drop_rate : null),
                                ontime_rate: s.ontime_rate || null,
                                fill_rate: s.fill_rate || null
                              };
                            })
                          };
                          var routeKey = 'route_' + date + '_' + shift + '_' + vehicle;
                          routeKey = routeKey.replace(/[^a-zA-Z0-9_]/g, '_');
                          window._routeDataCache[routeKey] = routeDataFor3D;
                          
                          html += '<td rowspan="' + stops.length + '" class="px-3 py-3 border-r-2 border-gray-400 align-top bg-gradient-to-br from-orange-50 to-amber-50" style="min-width: 220px;">';
                          html += '  <div class="space-y-2">';
                          html += '    <div class="flex items-center gap-2 pb-2 border-b border-orange-200">';
                          html += '      <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" /></svg>';
                          html += '      <span class="font-bold text-base text-orange-900">' + vehicle + '</span>';
                          html += '    </div>';
                          html += '    <div class="grid grid-cols-1 gap-1.5 text-sm">';
                          html += '      <div class="flex items-center justify-between px-2 py-1 bg-white rounded shadow-sm border border-orange-100">';
                          html += '        <span class="text-gray-600 font-medium text-xs">üöõ Lo·∫°i xe:</span>';
                          html += '        <span class="font-bold text-orange-700">' + payloadCap.toLocaleString() + ' Kg</span>';
                          html += '      </div>';
                          html += '      <div class="flex items-center justify-between px-2 py-1 bg-white rounded shadow-sm border border-orange-100">';
                          html += '        <span class="text-gray-600 font-medium text-xs">‚è±Ô∏è On-time:</span>';
                          html += '        <span class="font-bold">' + ontimeDisplay + '</span>';
                          html += '      </div>';
                          html += '      <div class="flex items-center justify-between px-2 py-1 bg-white rounded shadow-sm border border-orange-100">';
                          html += '        <span class="text-gray-600 font-medium text-xs">üìâ R·ªõt h√†ng:</span>';
                          html += '        <span class="font-bold">' + dropDisplay + '</span>';
                          html += '      </div>';
                          html += '      <div class="flex items-center justify-between px-2 py-1 bg-white rounded shadow-sm border border-orange-100">';
                          html += '        <span class="text-gray-600 font-medium text-xs">üì¶ L·∫•p ƒë·∫ßy:</span>';
                          html += '        <span class="font-bold">' + fillDisplay + '</span>';
                          html += '      </div>';
                          html += '    </div>';
                          html += '    <!-- View Details Button -->';
                          html += '    <button data-route-key="' + routeKey + '" class="btn-eval-visualize w-full mt-2 px-3 py-2 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white text-sm font-semibold rounded-lg shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-200 flex items-center justify-center gap-2" title="M√¥ ph·ªèng">';
                          html += '      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">';
                          html += '        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />';
                          html += '        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />';
                          html += '      </svg>';
                          html += '      <span>M√¥ ph·ªèng</span>';
                          html += '    </button>';
                          html += '  </div>';
                          html += '</td>';
                        }
                        
                        // STT
                        html += '<td class="px-2 py-2 text-sm text-center text-gray-700 border-r border-gray-200 bg-gray-50" style="min-width: 50px; max-width: 50px;">';
                        html += '  <span class="font-bold text-blue-600 text-base">' + (stop.stt || (stopIdx + 1)) + '</span>';
                        html += '</td>';
                        
                        // L·ªô tr√¨nh (Stop name)
                        var stopType = (stop.stop_type || stop.type || '').toLowerCase();
                        var isPickup = stopType.includes('l·∫•y') || stopType.includes('pickup');
                        var stopIcon = isPickup ? 'üì•' : 'üì¶';
                        var stopBgColor = isPickup ? 'bg-emerald-50' : 'bg-blue-50';
                        var stopTextColor = isPickup ? 'text-emerald-700' : 'text-blue-700';
                        var distanceKm = stop.planned_distance_km || stop.distance_km || 0;
                        var avgSpeed = stop.average_speed || 0;
                        
                        html += '<td class="px-2 py-2 text-sm ' + stopBgColor + ' border-r border-gray-200" style="min-width: 180px; max-width: 180px;">';
                        html += '  <div class="space-y-1">';
                        html += '    <div class="flex items-center gap-1">';
                        html += '      <span class="text-lg">' + stopIcon + '</span>';
                        html += '      <span class="font-semibold ' + stopTextColor + ' truncate text-sm">' + (stop.stop_name || stop.name || '‚Äî') + '</span>';
                        html += '    </div>';
                        if (distanceKm > 0 || avgSpeed > 0) {
                          html += '    <div class="flex items-center justify-between text-xs text-gray-600">';
                          html += '      <span>üìç ' + (distanceKm > 0 ? distanceKm.toFixed(1) : '‚Äî') + ' km</span>';
                          html += '      <span>üöó ' + (avgSpeed > 0 ? avgSpeed.toFixed(1) : '‚Äî') + ' km/h</span>';
                          html += '    </div>';
                        }
                        html += '  </div>';
                        html += '</td>';
                        
                        // Check-in
                        var expCheckIn = stop.expected_checkin_time || stop.planned_checkin_time;
                        var actCheckIn = stop.checkin_time;
                        html += '<td class="px-2 py-2 text-sm bg-purple-50 border-r border-gray-200" style="min-width: 150px;">';
                        html += '  <div class="space-y-0.5">';
                        html += '    <div class="text-orange-600 text-sm">K·∫ø ho·∫°ch: ' + formatTime(expCheckIn) + '</div>';
                        html += '    <div class="font-bold text-sm">Th·ª±c t·∫ø: ' + formatTime(actCheckIn) + '</div>';
                        html += '  </div>';
                        html += '</td>';
                        
                        // Check-out
                        var expCheckOut = stop.expected_checkout_time || stop.planned_checkout_time;
                        var actCheckOut = stop.checkout_time;
                        html += '<td class="px-2 py-2 text-sm bg-purple-50 border-r border-gray-200" style="min-width: 150px;">';
                        html += '  <div class="space-y-0.5">';
                        html += '    <div class="text-orange-600 text-sm">K·∫ø ho·∫°ch: ' + formatTime(expCheckOut) + '</div>';
                        html += '    <div class="font-bold text-sm">Th·ª±c t·∫ø: ' + formatTime(actCheckOut) + '</div>';
                        html += '  </div>';
                        html += '</td>';
                        
                        // S·∫£n l∆∞·ª£ng
                        var pickup = stop.pickup_weight_kg || 0;
                        var delivery = stop.delivery_weight_kg || 0;
                        var loadOnTruck = stop.load_on_truck || stop.loaded_weight_kg || 0;
                        var totalVolume = pickup + delivery;
                        var throughput_rate = stop.throughput_rate != null ? parseFloat(stop.throughput_rate).toFixed(2) : null;
                        
                        html += '<td class="px-2 py-2 text-sm bg-blue-100 border-r border-gray-300" style="min-width: 180px;">';
                        html += '  <div class="space-y-1.5">';
                        html += '    <div class="flex items-center justify-between">';
                        html += '      <span class="text-gray-600 text-xs">üì• L·∫•y:</span>';
                        html += '      <span class="font-semibold text-emerald-700 text-sm">' + pickup.toLocaleString() + ' kg</span>';
                        html += '    </div>';
                        html += '    <div class="flex items-center justify-between">';
                        html += '      <span class="text-gray-600 text-xs">üì¶ Giao:</span>';
                        html += '      <span class="font-semibold text-blue-700 text-sm">' + delivery.toLocaleString() + ' kg</span>';
                        html += '    </div>';
                        html += '    <div class="flex items-center justify-between pt-1 border-t-2 border-blue-300">';
                        html += '      <span class="text-gray-800 font-bold text-xs">üìä T·ªïng:</span>';
                        html += '      <span class="font-extrabold text-blue-900 text-2xl">' + totalVolume.toLocaleString() + '</span>';
                        html += '    </div>';
                        if (loadOnTruck > 0) {
                          html += '    <div class="flex items-center justify-between pt-1 border-t border-blue-200">';
                          html += '      <span class="text-gray-700 font-semibold text-xs">üöõ Load:</span>';
                          html += '      <span class="font-extrabold text-orange-700 text-2xl">' + loadOnTruck.toLocaleString() + '</span>';
                          html += '    </div>';
                        }
                        if (throughput_rate) {
                          html += '    <div class="flex items-center justify-between px-2 py-1 bg-orange-100 rounded border border-orange-300 mt-1">';
                          html += '      <span class="text-orange-800 font-semibold text-xs">üìà Th√¥ng l∆∞·ª£ng:</span>';
                          html += '      <span class="font-bold text-orange-700 text-sm">' + throughput_rate + ' kg/s</span>';
                          html += '    </div>';
                        }
                        html += '  </div>';
                        html += '</td>';
                        
                        // T·ª∑ l·ªá R·ªõt h√†ng
                        var dropRate = stop.drop_rate_percent != null ? stop.drop_rate_percent : (trip.drop_rate_percent || 0);
                        var dropColor = dropRate <= 3 ? 'text-emerald-700' : dropRate <= 7 ? 'text-orange-600' : 'text-red-700';
                        var dropBg = dropRate <= 3 ? 'bg-emerald-50' : dropRate <= 7 ? 'bg-orange-50' : 'bg-red-50';
                        html += '<td class="px-2 py-2 text-center ' + dropBg + ' border-r border-gray-300" style="min-width: 100px;">';
                        html += '  <div class="space-y-1">';
                        html += '    <div class="text-xs text-gray-600">üìâ R·ªõt h√†ng</div>';
                        html += '    <div class="font-extrabold text-2xl ' + dropColor + '">' + dropRate.toFixed(1) + '%</div>';
                        html += '  </div>';
                        html += '</td>';
                        
                        // T·ª∑ l·ªá L·∫•p ƒë·∫ßy
                        var fillRate = stop.fill_rate != null ? stop.fill_rate : (trip.fill_rate_percent || trip.load_factor || 0);
                        var fillColor = fillRate >= 80 ? 'text-emerald-700' : fillRate >= 60 ? 'text-orange-600' : fillRate >= 40 ? 'text-amber-600' : 'text-red-700';
                        var fillBg = fillRate >= 80 ? 'bg-emerald-50' : fillRate >= 60 ? 'bg-orange-50' : fillRate >= 40 ? 'bg-amber-50' : 'bg-red-50';
                        html += '<td class="px-2 py-2 text-center ' + fillBg + ' border-r border-gray-300" style="min-width: 100px;">';
                        html += '  <div class="space-y-1">';
                        html += '    <div class="text-xs text-gray-600">üì¶ L·∫•p ƒë·∫ßy</div>';
                        html += '    <div class="font-extrabold text-2xl ' + fillColor + '">' + fillRate.toFixed(1) + '%</div>';
                        html += '  </div>';
                        html += '</td>';
                        
                        // X·ª≠ l√Ω
                        var proc_time_sec = stop.planned_processing_time != null ? (Math.ceil(stop.planned_processing_time) / 60) : null;
                        var serve_time_sec = stop.serve_time != null ? (Math.ceil(stop.serve_time) / 60) : null;
                        var procTimeColor = (serve_time_sec && proc_time_sec) ? (serve_time_sec <= proc_time_sec ? 'text-emerald-700' : 'text-red-600') : 'text-orange-600';
                        
                        html += '<td class="px-2 py-2 text-sm bg-amber-100 border-r border-gray-300" style="min-width: 150px;">';
                        html += '  <div class="space-y-2">';
                        if (proc_time_sec != null) {
                          html += '    <div class="flex items-center justify-between px-2 py-1.5 bg-white rounded border border-amber-200">';
                          html += '      <span class="font-semibold text-gray-700 text-sm">‚è±Ô∏è K·∫ø ho·∫°ch:</span>';
                          html += '      <span class="font-bold text-gray-800 text-base">' + proc_time_sec.toFixed(2) + ' ph√∫t</span>';
                          html += '    </div>';
                        }
                        if (serve_time_sec != null) {
                          html += '    <div class="flex items-center justify-between px-2 py-1.5 bg-white rounded border-2" style="border-color: ' + (procTimeColor === 'text-emerald-700' ? '#10b981' : procTimeColor === 'text-red-600' ? '#ef4444' : '#f97316') + ';">';
                          html += '      <span class="font-semibold text-gray-700 text-sm">‚ö° Th·ª±c t·∫ø:</span>';
                          html += '      <span class="font-bold ' + procTimeColor + ' text-base">' + serve_time_sec.toFixed(2) + ' ph√∫t</span>';
                          html += '    </div>';
                        }
                        if (proc_time_sec == null && serve_time_sec == null) {
                          html += '<div class="text-gray-500 text-xs">‚Äî</div>';
                        }
                        html += '  </div>';
                        html += '</td>';
                        
                        html += '</tr>';
                      });
                    }
                  });
                });
              });
              
              tbody.innerHTML = html;
            }

            // Update selected plan information in header
            function updateSelectedPlanInfo(planId, planName) {
              // Update sim-plan-id-2 input if it exists, or create it if needed
              var planIdInput = document.getElementById('sim-plan-id-2');
              if (!planIdInput) {
                // Try to find the form and create a hidden input
                var form = document.getElementById('sim-setup-form-2');
                if (form) {
                  planIdInput = document.createElement('input');
                  planIdInput.type = 'hidden';
                  planIdInput.id = 'sim-plan-id-2';
                  planIdInput.name = 'sim-plan-id-2';
                  form.appendChild(planIdInput);
                }
              }
              if (planIdInput && planId) {
                planIdInput.value = planId;
              }
              
              var planInfoElement = document.getElementById('selected-plan-info');
              var planNameElement = document.getElementById('selected-plan-name');
              var planSelectionStatus = document.getElementById('plan-selection-status');
              
              if (planInfoElement && planNameElement) {
                var runBtn = document.getElementById('btn-run-forecast-2');
                if (planId && planName) {
                  planNameElement.textContent = planName;
                  planInfoElement.classList.remove('hidden');
                  // Enable run button when a plan is selected
                  if (runBtn) { runBtn.disabled = false; runBtn.classList.remove('opacity-50'); }
                  // Update table message
                  if (planSelectionStatus) {
                    planSelectionStatus.innerHTML = `ƒê√£ ch·ªçn l·ªãch t·∫£i: <strong>"${planName}"</strong>`;
                  }
                } else {
                  planInfoElement.classList.add('hidden');
                  planNameElement.textContent = 'Ch∆∞a ch·ªçn';
                  // Disable run button when no plan selected
                  if (runBtn) { runBtn.disabled = true; runBtn.classList.add('opacity-50'); }
                  // Reset table message
                  if (planSelectionStatus) {
                    planSelectionStatus.textContent = 'Ch·ªçn l·ªãch t·∫£i t·ª´ tab "L·ª±a Ch·ªçn Plan"';
                  }
                }
              }
            }

            // Expose function globally for external access
            window.updateSelectedPlanInfo = updateSelectedPlanInfo;

            function callPredict(){
              var payload = buildPayload();
              
              // If buildPayload returned null, try to build a minimal payload from global state
              if (!payload) {
                console.warn('[callPredict] buildPayload returned null, trying to use global selectedPlanId');
                var planId = window.selectedPlanId || 
                            (window.planningState && window.planningState.selectedPlanId) ||
                            (window.planningState && window.planningState.currentPlan && (window.planningState.currentPlan.id || window.planningState.currentPlan.uuid));
                
                if (!planId) {
                  alert('Vui l√≤ng ch·ªçn plan tr∆∞·ªõc khi ch·∫°y m√¥ ph·ªèng.');
                  return;
                }
                
                // Build minimal payload with plan ID and default values
                var fromDateEl = $('sim-date-from-2');
                var toDateEl = $('sim-date-to-2');
                var fromDate = fromDateEl ? fromDateEl.value : '';
                var toDate = toDateEl ? toDateEl.value : '';
                
                // Set default dates to today if not set
                if (!fromDate || !toDate) {
                  var today = new Date();
                  var todayStr = today.toISOString().split('T')[0];
                  if (!fromDate) fromDate = todayStr;
                  if (!toDate) toDate = todayStr;
                }
                
                payload = {
                  plan_id: planId,
                  from_date: fromDate,
                  to_date: toDate,
                  persist: false,
                  buffer_throughtput: 1.0,
                  simulation: {
                    date_range: { start_date: fromDate, end_date: toDate },
                    cargo_type: 'normal',
                    weather: 'sunny',
                    ktc: {},
                    scenario: {
                      traffic_bias_percent: 0,
                      road_condition_percent: 0,
                      delivery_difficulty_percent: 0
                    },
                    scenario_tuning: {},
                    run_fast: false,
                    notes: ''
                  }
                };
              }
              
              // Try to get plan_id from global state if not in payload
              if(!payload.plan_id){
                var planId = window.selectedPlanId || 
                            (window.planningState && window.planningState.selectedPlanId) ||
                            (window.planningState && window.planningState.currentPlan && (window.planningState.currentPlan.id || window.planningState.currentPlan.uuid));
                if (planId) {
                  payload.plan_id = planId;
                }
              }
              
              if(!payload.plan_id){
                alert('Vui l√≤ng ch·ªçn plan tr∆∞·ªõc khi ch·∫°y m√¥ ph·ªèng.');
                return;
              }

              setLoading(true);
              var url = '/routing-deviation/internal/plan/predict';

              var doPost = function(url, body){
                if(window.apiClient && typeof window.apiClient.post === 'function'){
                  return window.apiClient.post(url, body);
                }
                return fetch(url, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(body)
                }).then(function(r){ return r.json(); });
              };

              doPost(url, payload)
                .then(function(json){
                  handleResponse(json);
                })
                .catch(function(err){
                  console.error('predict error', err);
                  alert('L·ªói khi g·ªçi API predict. Xem console ƒë·ªÉ bi·∫øt chi ti·∫øt.');
                })
                .finally(function(){ setLoading(false); });
            }

            // Initialize trip simulation button and controls - expose to window to ensure it runs after component loads
            window.initTripSimulationControls = function(){
              console.log('[Trip Simulation] Initializing controls...');
              var runBtn = $('btn-run-forecast-2');
              if(runBtn){
                console.log('[Trip Simulation] Found run button, attaching handler');
                runBtn.disabled = false; // enable now that fields exist
                
                // Remove any existing handler to prevent conflicts with forecast2.js
                // Clone node to remove all listeners, then replace
                var newBtn = runBtn.cloneNode(true);
                runBtn.parentNode.replaceChild(newBtn, runBtn);
                runBtn = newBtn;
                
                // Attach OUR handler that calls trip simulation's callPredict
                runBtn.addEventListener('click', function(e){
                  console.log('[Trip Simulation] Run button clicked - calling trip simulation predict');
                  e.preventDefault();
                  e.stopPropagation();
                  callPredict();
                });
                console.log('[Trip Simulation] Button handler attached successfully');
              } else {
                console.warn('[Trip Simulation] Run button not found');
              }

              // update slider labels live
              var t = $('traffic-bias-2'); if(t){ t.addEventListener('input', function(){ $('traffic-bias-value-2').textContent = t.value + '%'; }); }
              var r = $('road-condition-2'); if(r){ r.addEventListener('input', function(){ $('road-condition-value-2').textContent = r.value + '%'; }); }
              var d = $('delivery-difficulty-2'); if(d){ d.addEventListener('input', function(){ $('delivery-difficulty-value-2').textContent = d.value + '%'; }); }
              
              // update buffer throughput label live
              var bt = $('buffer-throughput-2'); 
              if(bt){ 
                bt.addEventListener('input', function(){ 
                  $('buffer-throughput-value-2').textContent = parseFloat(bt.value).toFixed(1); 
                }); 
              }

              // Delegate click on View Details buttons to show trip popup
              var tbody = document.getElementById('simulation-table-body-2');
              if(tbody && !tbody._viewDetailsAttached){
                tbody.addEventListener('click', function(ev){
                  var btn = ev.target.closest && ev.target.closest('.btn-view-trip-details');
                  if(!btn) return;
                  console.log('[Trip Simulation] View details button clicked, target:', ev.target);
                  ev.stopPropagation();
                  
                  var tr = btn.closest('tr');
                  if(!tr) { console.warn('[Trip Simulation] No parent tr found for clicked button'); return; }
                  
                  // Try to read JSON stored in data-trip attribute
                  var data = tr.getAttribute('data-trip');
                  if(data){
                    try{ 
                      var trip = JSON.parse(data);
                      console.log('[Trip Simulation] Parsed trip from data-trip attribute:', trip);
                      window.showTripPopup(trip); 
                      return; 
                    } catch(e){ console.warn('[Trip Simulation] invalid trip json in data-trip', e, 'raw:', data); }
                  }
                  // Otherwise build from cells
                  var cells = tr.querySelectorAll('td');
                  if(cells && cells.length){
                    var trip = {
                      date: cells[0] ? cells[0].innerText.trim() : '',
                      shift: cells[1] ? cells[1].innerText.trim() : '',
                      code: cells[2] ? cells[2].innerText.trim() : '',
                      stt: cells[3] ? cells[3].innerText.trim() : '',
                      route: cells[4] ? cells[4].innerText.trim() : ''
                    };
                    console.log('[Trip Simulation] Built trip object from table cells:', trip);
                    window.showTripPopup(trip);
                  } else {
                    console.warn('[Trip Simulation] No table cells found to build trip object');
                  }
                });
                tbody._viewDetailsAttached = true;
                console.log('[Trip Simulation] View details delegated handler attached');
              }
            };
            
            // Call immediately and also expose for external initialization
            document.addEventListener('DOMContentLoaded', function(){
              window.initTripSimulationControls();
              
              // Initialize plan info if already selected
              setTimeout(function() {
                if (window.selectedPlanData) {
                  updateSelectedPlanInfo(
                    window.selectedPlanData.id, 
                    window.selectedPlanData.name || window.selectedPlanData.title || `Plan ${window.selectedPlanData.id}`
                  );
                } else if (window.planningState && window.planningState.currentPlan) {
                  var plan = window.planningState.currentPlan;
                  updateSelectedPlanInfo(
                    plan.id, 
                    plan.name || plan.title || `Plan ${plan.id}`
                  );
                }
              }, 100);

              // KTC flow controls: Run and Reset
              var ktcRunBtn = document.getElementById('ktc-run-flow-sim');
              var ktcResetBtn = document.getElementById('ktc-reset-flow');
              if(ktcRunBtn){
                ktcRunBtn.addEventListener('click', function(ev){
                  ev.preventDefault();
                  var params = {
                    travel_minutes: parseInt(($('ktc-travel-ktc-to-bc') && $('ktc-travel-ktc-to-bc').value) || '30',10) || 30,
                    return_max_delay_minutes: parseInt(($('ktc-return-max-delay') && $('ktc-return-max-delay').value) || '60',10) || 60,
                    animate: !!($('ktc-flow-animate') && $('ktc-flow-animate').checked)
                  };
                  // store for later
                  window.lastKtcParams = params;
                  // apply locally to lastTripsData for visualization
                  try{
                    if(window.lastTripsData && Array.isArray(window.lastTripsData)){
                      applyKtcTimingToTrips(window.lastTripsData, params);
                      // Re-render table to show simulated fields
                      try{ renderTripsTable(window.lastTripsData); }catch(e){}
                      // Forecast results section has been removed
                    }
                  }catch(e){ console.error('applyKtcTimingToTrips error', e); }
                  // Trigger animation
                  try{ animateKtcFlow(params); }catch(e){ console.error('animateKtcFlow error', e); }
                });
              }
              if(ktcResetBtn){
                ktcResetBtn.addEventListener('click', function(ev){
                  ev.preventDefault();
                  // clear stored params
                  window.lastKtcParams = null;
                  // reset truck position
                  try{ animateKtcFlow({ animate: false }); }catch(e){ }
                  // re-render using original server data
                  if(window.lastTripsData && Array.isArray(window.lastTripsData)){
                    try{ renderTripsTable(window.lastTripsData); }catch(e){}
                    // Forecast results section has been removed
                  }
                });
              }
              // Load demand datasets - expose to window for external calling
              window.loadDemandDatasets = async function(){
                try {
                  console.log('[Demand Datasets] Loading list...');
                  
                  const response = await fetch('/routing-deviation/internal/dataset/list', {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                      'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                      size: 100,
                      offset: 0,
                      search: ''
                    })
                  });
                  
                  console.log('[Demand Datasets] Response status:', response.status);
                  
                  if(!response.ok) {
                    const errorText = await response.text();
                    console.error('[Demand Datasets] Error response:', errorText);
                    throw new Error('Failed to load datasets: ' + response.status);
                  }
                  
                  const result = await response.json();
                  console.log('[Demand Datasets] Result:', result);
                  
                  const datasets = result.data || [];
                  console.log('[Demand Datasets] Total datasets:', datasets.length);
                  
                  // Filter demand type datasets
                  const demandDatasets = datasets.filter(function(ds){ return ds.type === 'demand'; });
                  console.log('[Demand Datasets] Demand datasets:', demandDatasets.length, demandDatasets);
                  
                  // Populate selector
                  var selector = $('demand-dataset-selector-2');
                  if(selector){
                    selector.innerHTML = '<option value="">-- Ch·ªçn dataset demand --</option>';
                    demandDatasets.forEach(function(ds){
                      var opt = document.createElement('option');
                      opt.value = ds.id;
                      opt.textContent = ds.name;
                      selector.appendChild(opt);
                    });
                    console.log('[Demand Datasets] Populated selector with', demandDatasets.length, 'options');
                  } else {
                    console.error('[Demand Datasets] Selector not found!');
                  }
                } catch(err){
                  console.error('[Demand Datasets] Error loading datasets:', err);
                  alert('Kh√¥ng th·ªÉ t·∫£i danh s√°ch datasets. Ki·ªÉm tra console ƒë·ªÉ bi·∫øt chi ti·∫øt.');
                }
              }
              
              // Load demand details for selected dataset - expose to window
              window.loadDemandDetails = async function(datasetId){
                if(!datasetId) {
                  $('demand-details-container').classList.add('hidden');
                  return;
                }
                
                $('demand-details-container').classList.remove('hidden');
                $('demand-loading').classList.remove('hidden');
                $('demand-stats-summary').classList.add('hidden');
                $('demand-details-table-wrapper').classList.add('hidden');
                
                try {
                  const response = await fetch('/routing-deviation/internal/dataset/' + datasetId, {
                    method: 'GET',
                    headers: {
                      'Accept': 'application/json'
                    }
                  });
                  
                  if(!response.ok) throw new Error('Failed to load demand details');
                  
                  const result = await response.json();
                  const demandData = result.data || result;
                  
                  // Process demand data
                  renderDemandDetails(demandData);
                  
                } catch(err){
                  console.error('Error loading demand details:', err);
                  alert('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu demands. Vui l√≤ng th·ª≠ l·∫°i.');
                } finally {
                  $('demand-loading').classList.add('hidden');
                }
              }
              
              // Render demand details
              function renderDemandDetails(data){
                console.log('Demand data:', data);
                
                // Extract demands array
                var demands = [];
                if(Array.isArray(data)){
                  demands = data;
                } else if(data.demands && Array.isArray(data.demands)){
                  demands = data.demands;
                } else if(data.data && Array.isArray(data.data)){
                  demands = data.data;
                }
                
                if(demands.length === 0){
                  alert('Kh√¥ng c√≥ d·ªØ li·ªáu demands trong dataset n√†y.');
                  return;
                }
                
                // Calculate totals
                var totalHubs = 0;
                var totalPickup = 0;
                var totalDelivery = 0;
                var hubMap = {};
                
                demands.forEach(function(demand){
                  var hubId = demand.hub_id || demand.hubId || demand.hub;
                  var pickup = parseFloat(demand.pickup_volume || demand.pickup || 0);
                  var delivery = parseFloat(demand.delivery_volume || demand.delivery || 0);
                  
                  if(!hubMap[hubId]){
                    hubMap[hubId] = { hubId: hubId, pickup: 0, delivery: 0 };
                    totalHubs++;
                  }
                  
                  hubMap[hubId].pickup += pickup;
                  hubMap[hubId].delivery += delivery;
                  totalPickup += pickup;
                  totalDelivery += delivery;
                });
                
                // Update summary
                $('demand-total-hubs').textContent = totalHubs;
                $('demand-total-pickup').textContent = totalPickup.toLocaleString();
                $('demand-total-delivery').textContent = totalDelivery.toLocaleString();
                $('demand-total-volume').textContent = (totalPickup + totalDelivery).toLocaleString();
                $('demand-stats-summary').classList.remove('hidden');
                
                // Render table
                var tbody = $('demand-details-tbody');
                if(tbody){
                  tbody.innerHTML = '';
                  
                  var hubs = Object.values(hubMap).sort(function(a, b){
                    return (b.pickup + b.delivery) - (a.pickup + a.delivery);
                  });
                  
                  hubs.forEach(function(hub){
                    var total = hub.pickup + hub.delivery;
                    var pickupPercent = total > 0 ? ((hub.pickup / total) * 100).toFixed(1) : 0;
                    var deliveryPercent = total > 0 ? ((hub.delivery / total) * 100).toFixed(1) : 0;
                    
                    var tr = document.createElement('tr');
                    tr.className = 'hover:bg-blue-50 transition-colors';
                    tr.innerHTML = 
                      '<td class="px-3 py-2 text-xs font-medium text-gray-900">' + hub.hubId + '</td>' +
                      '<td class="px-3 py-2 text-xs text-right text-green-600 font-medium">' + hub.pickup.toLocaleString() + '</td>' +
                      '<td class="px-3 py-2 text-xs text-right text-orange-600 font-medium">' + hub.delivery.toLocaleString() + '</td>' +
                      '<td class="px-3 py-2 text-xs text-right text-purple-600 font-bold">' + total.toLocaleString() + '</td>' +
                      '<td class="px-3 py-2 text-center">' +
                        '<div class="flex gap-1 justify-center">' +
                          '<span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">' + pickupPercent + '%</span>' +
                          '<span class="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded">' + deliveryPercent + '%</span>' +
                        '</div>' +
                      '</td>';
                    tbody.appendChild(tr);
                  });
                  
                  $('demand-details-table-wrapper').classList.remove('hidden');
                }
              }
              
              // Event listeners for demand dataset
              var demandSelector = $('demand-dataset-selector-2');
              console.log('[Demand Selector] Element found:', !!demandSelector);
              if(demandSelector){
                demandSelector.addEventListener('change', function(){
                  console.log('[Demand Selector] Changed to:', this.value);
                  if(typeof window.loadDemandDetails === 'function'){
                    window.loadDemandDetails(this.value);
                  }
                });
                console.log('[Demand Selector] Change listener attached');
              } else {
                console.error('[Demand Selector] Element not found!');
              }
              
              var refreshBtn = $('refresh-demand-details');
              if(refreshBtn){
                refreshBtn.addEventListener('click', function(){
                  var selector = $('demand-dataset-selector-2');
                  if(selector && selector.value && typeof window.loadDemandDetails === 'function'){
                    window.loadDemandDetails(selector.value);
                  }
                });
              }
              
              // Load datasets on page load - don't auto-call here, let planning-simulation.js handle it
              console.log('[Demand Datasets] Functions exposed to window scope');
              // loadDemandDatasets(); // Removed - will be called from planning-simulation.js

              // Trip popup functions already defined at top of script
              // Removed duplicate definitions of renderTripHtml, populateTripDetails, showTripPopup, hideTripPopup

              // NOTE: delegated click handler moved into initTripSimulationControls()
              // so it is attached when controls are initialized (works with dynamic innerHTML loads).
              
              // Toggle JSON details
              var jsonToggle = document.getElementById('trip-json-toggle');
              var jsonContent = document.getElementById('trip-json-content');
              var jsonArrow = document.getElementById('trip-json-arrow');
              if(jsonToggle && jsonContent){
                jsonToggle.addEventListener('click', function(){
                  jsonContent.classList.toggle('hidden');
                  if(jsonArrow) jsonArrow.classList.toggle('rotate-180');
                });
              }
              
              // Wire up 3D controls in popup
              var popup3dPrev = document.getElementById('trip-popup-3d-prev');
              if(popup3dPrev) popup3dPrev.addEventListener('click', function(){ if(typeof window.prev3DStop === 'function') window.prev3DStop(); });
              
              var popup3dPlay = document.getElementById('trip-popup-3d-play');
              if(popup3dPlay) popup3dPlay.addEventListener('click', function(){ if(typeof window.togglePlay3D === 'function') window.togglePlay3D(); });
              
              var popup3dNext = document.getElementById('trip-popup-3d-next');
              if(popup3dNext) popup3dNext.addEventListener('click', function(){ if(typeof window.next3DStop === 'function') window.next3DStop(); });
              
              var popup3dFocus = document.getElementById('trip-popup-3d-focus');
              if(popup3dFocus) popup3dFocus.addEventListener('click', function(){ if(typeof window.focusCurrentStop === 'function') window.focusCurrentStop(); });

              // Close modal on ESC
              document.addEventListener('keydown', function(e){ 
                if(e.key === 'Escape') {
                  var modal = document.getElementById('trip-popup-modal');
                  if(modal && !modal.classList.contains('hidden')){
                    if(typeof window.hideTripPopup === 'function') window.hideTripPopup();
                  }
                }
              });

              // Close button (direct) and safety delegated handlers
              var closeBtn = document.getElementById('trip-popup-close');
              if(closeBtn) {
                // Ensure it's clickable even if styles interfere
                try{
                  closeBtn.style.zIndex = 99999;
                  closeBtn.style.pointerEvents = 'auto';
                  closeBtn.style.cursor = 'pointer';
                }catch(ignore){}

                closeBtn.addEventListener('click', function(e){
                  console.log('[Trip Popup] Close button clicked');
                  e.preventDefault();
                  e.stopPropagation();
                  if(typeof window.hideTripPopup === 'function') window.hideTripPopup();
                });
                console.log('[Trip Popup] Close button event listener attached');
              } else {
                console.warn('[Trip Popup] Close button not found');
              }

              // Background click: close when clicking on overlay (modal root)
              var modalEl = document.getElementById('trip-popup-modal');
              if(modalEl){ 
                modalEl.addEventListener('click', function(e){ 
                  if(e.target === modalEl) {
                    console.log('[Trip Popup] Background clicked');
                    if(typeof window.hideTripPopup === 'function') window.hideTripPopup(); 
                  }
                }); 
              }

              // Delegated document-level fallback: catch clicks that target the close icon even if element was replaced
              document.addEventListener('click', function(e){
                var btn = e.target.closest && e.target.closest('#trip-popup-close');
                if(btn){
                  console.log('[Trip Popup] Delegated close detected');
                  if(typeof window.hideTripPopup === 'function') window.hideTripPopup();
                }
              }, true); // capture phase to be early

              // Toggle vehicle view (total vs by shift)
              var vehicleToggle = $('vehicle-view-toggle');
              if(vehicleToggle){
                vehicleToggle.addEventListener('click', function(){
                  var currentView = vehicleToggle.getAttribute('data-view');
                  var totalView = $('vehicle-total-view');
                  var shiftView = $('vehicle-shift-view');
                  
                  if(currentView === 'total'){
                    // Switch to shift view
                    vehicleToggle.setAttribute('data-view', 'shift');
                    vehicleToggle.innerHTML = 'üìä Xem t·ªïng';
                    if(totalView) totalView.classList.add('hidden');
                    if(shiftView) shiftView.classList.remove('hidden');
                  } else {
                    // Switch to total view
                    vehicleToggle.setAttribute('data-view', 'total');
                    vehicleToggle.innerHTML = 'üìä Xem theo ca';
                    if(totalView) totalView.classList.remove('hidden');
                    if(shiftView) shiftView.classList.add('hidden');
                  }
                });
              }
              
              // Chart controls event listeners
              var chartMetric1 = document.getElementById('chart-metric-1');
              if(chartMetric1) {
                chartMetric1.addEventListener('change', function() {
                  // Re-render daily performance chart with selected metric
                  var lastTripsData = window.lastTripsData || [];
                  if(lastTripsData.length > 0) {
                    updateDailyPerformanceChart(lastTripsData);
                  }
                });
              }
              
              var chartView2 = document.getElementById('chart-view-2');
              if(chartView2) {
                chartView2.addEventListener('change', function() {
                  var lastTripsData = window.lastTripsData || [];
                  if(lastTripsData.length > 0) {
                    updateTimeDistributionChart(lastTripsData);
                  }
                });
              }
              
              var chartView4 = document.getElementById('chart-view-4');
              if(chartView4) {
                chartView4.addEventListener('change', function() {
                  var lastTripsData = window.lastTripsData || [];
                  if(lastTripsData.length > 0) {
                    updateCargoVolumeChart(lastTripsData);
                  }
                });
              }

            });
          })();
          
          // ================================================
          // Scenario Tuning Checkbox Handlers
          // ================================================
          (function() {
            // Get all scenario checkboxes
            const checkboxes = [
              'checkin-early', 'checkin-late', 'checkin-mixed',
              'transit-early', 'transit-late', 'transit-waiting',
              'speed-boost-1-2', 'speed-boost-1-5',
              'weather-impact', 'peak-hour', 'staff-shortage'
            ];
            
            // Scenario configuration object
            window.scenarioConfig = {
              checkin: [],
              transit: [],
              speed: [],
              extra: []
            };
            
            // Update scenario summary
            function updateScenarioSummary() {
              const summary = document.getElementById('scenario-summary');
              if (!summary) return;
              
              const config = window.scenarioConfig;
              const parts = [];
              
              // Check-in scenarios
              if (config.checkin.length > 0) {
                const checkinMap = {
                  'early': 'S·ªõm',
                  'late': 'Tr·ªÖ', 
                  'mixed': 'Tr·ªôn'
                };
                const checkinText = config.checkin.map(c => checkinMap[c]).join(', ');
                parts.push(`üïê Check-in: ${checkinText}`);
              }
              
              // Transit scenarios
              if (config.transit.length > 0) {
                const transitMap = {
                  'early': 'ƒê·∫øn s·ªõm',
                  'late': 'ƒê·∫øn tr·ªÖ',
                  'waiting': 'Ph·∫£i ch·ªù'
                };
                const transitText = config.transit.map(t => transitMap[t]).join(', ');
                parts.push(`üöö Di chuy·ªÉn: ${transitText}`);
              }
              
              // Speed scenarios
              if (config.speed.length > 0) {
                const speedMap = {
                  '1.2': 'TƒÉng t·ªëc 1.2x',
                  '1.5': 'TƒÉng t·ªëc 1.5x'
                };
                const speedText = config.speed.map(s => speedMap[s]).join(', ');
                parts.push(`‚ö° T·ªëc ƒë·ªô: ${speedText}`);
              }
              
              // Extra scenarios
              if (config.extra.length > 0) {
                const extraMap = {
                  'weather': 'Th·ªùi ti·∫øt x·∫•u',
                  'peak': 'Gi·ªù cao ƒëi·ªÉm',
                  'shortage': 'Thi·∫øu nh√¢n l·ª±c'
                };
                const extraText = config.extra.map(e => extraMap[e]).join(', ');
                parts.push(`üéØ Kh√°c: ${extraText}`);
              }
              
              if (parts.length === 0) {
                summary.innerHTML = '<em>Ch·ªçn c√°c t√πy ch·ªçn tr√™n ƒë·ªÉ xem t√≥m t·∫Øt k·ªãch b·∫£n m√¥ ph·ªèng</em>';
              } else {
                summary.innerHTML = parts.join('<br>');
              }
            }
            
            // Handle checkbox changes
            function handleCheckboxChange(checkbox) {
              const value = checkbox.value;
              const name = checkbox.name;
              
              if (checkbox.checked) {
                // Add to config
                switch (name) {
                  case 'scenario-checkin':
                    if (!window.scenarioConfig.checkin.includes(value)) {
                      window.scenarioConfig.checkin.push(value);
                    }
                    break;
                  case 'scenario-transit':
                    if (!window.scenarioConfig.transit.includes(value)) {
                      window.scenarioConfig.transit.push(value);
                    }
                    break;
                  case 'scenario-speed':
                    if (!window.scenarioConfig.speed.includes(value)) {
                      window.scenarioConfig.speed.push(value);
                    }
                    break;
                  case 'scenario-extra':
                    if (!window.scenarioConfig.extra.includes(value)) {
                      window.scenarioConfig.extra.push(value);
                    }
                    break;
                }
              } else {
                // Remove from config
                switch (name) {
                  case 'scenario-checkin':
                    window.scenarioConfig.checkin = window.scenarioConfig.checkin.filter(c => c !== value);
                    break;
                  case 'scenario-transit':
                    window.scenarioConfig.transit = window.scenarioConfig.transit.filter(t => t !== value);
                    break;
                  case 'scenario-speed':
                    window.scenarioConfig.speed = window.scenarioConfig.speed.filter(s => s !== value);
                    break;
                  case 'scenario-extra':
                    window.scenarioConfig.extra = window.scenarioConfig.extra.filter(e => e !== value);
                    break;
                }
              }
              
              updateScenarioSummary();
              console.log('Scenario Config Updated:', window.scenarioConfig);
            }
            
            // Add event listeners to all scenario checkboxes
            checkboxes.forEach(id => {
              const checkbox = document.getElementById(id);
              if (checkbox) {
                checkbox.addEventListener('change', function() {
                  handleCheckboxChange(this);
                });
              }
            });
            
            // Function to get current scenario configuration for API calls
            window.getScenarioConfig = function() {
              return window.scenarioConfig;
            };
            
            // Function to apply scenario configuration to simulation parameters
            window.applyScenarioToParams = function(baseParams) {
              const config = window.scenarioConfig;
              const params = { ...baseParams };
              
              // Add scenario parameters
              params.scenario_config = {
                checkin_timing: config.checkin,
                transit_timing: config.transit,
                speed_multiplier: config.speed,
                extra_factors: config.extra
              };
              
              return params;
            };
            
            console.log('Scenario tuning system initialized');
          })();
        </script>
        </div>
      </div>
    </div>

  <!-- Collapsible Setup Form -->
  <div id="sim-setup-form-2" class="bg-white border-b border-orange-200">
    <div class="">
    
      <!-- Form Rows -->
      <div class="divide-y divide-orange-100">
        
        <!-- Row 1: Date Range -->
        <div class="grid grid-cols-1 lg:grid-cols-12 bg-white hover:bg-orange-50 transition-colors">
          <div class="lg:col-span-3 px-4 py-3 bg-orange-50 border-r border-orange-100">
            <label class="text-sm font-medium text-gray-800 flex items-center gap-2">
              <span class="text-orange-500">üìÖ</span>
              <span>Th·ªùi Gian M√¥ Ph·ªèng</span>
            </label>
            <p class="text-xs text-gray-500 mt-1">Kho·∫£ng th·ªùi gian ch·∫°y m√¥ ph·ªèng</p>
          </div>
          <div class="lg:col-span-9 px-4 py-3">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label for="sim-date-from-2" class="block text-xs font-medium text-gray-600 mb-1">T·ª´ ng√†y</label>
                <input 
                  id="sim-date-from-2" 
                  type="date" 
                  class="w-full px-3 py-2 border border-orange-200 rounded focus:ring-2 focus:ring-orange-400 focus:border-orange-400 text-sm" />
              </div>
              <div>
                <label for="sim-date-to-2" class="block text-xs font-medium text-gray-600 mb-1">ƒê·∫øn ng√†y</label>
                <input 
                  id="sim-date-to-2" 
                  type="date" 
                  class="w-full px-3 py-2 border border-orange-200 rounded focus:ring-2 focus:ring-orange-400 focus:border-orange-400 text-sm" />
              </div>
            </div>
          </div>
        </div>

        <!-- Row 2: Buffer Settings -->
        <div class="grid grid-cols-1 lg:grid-cols-12 bg-white hover:bg-orange-50 transition-colors">
          <div class="lg:col-span-3 px-4 py-3 bg-orange-50 border-r border-orange-100">
            <label class="text-sm font-medium text-gray-800 flex items-center gap-2">
              <span class="text-orange-500">‚öôÔ∏è</span>
              <span>C√†i ƒê·∫∑t Buffer</span>
            </label>
            <p class="text-xs text-gray-500 mt-1">H·ªá s·ªë ƒëi·ªÅu ch·ªânh th√¥ng l∆∞·ª£ng x·ª≠ l√Ω</p>
          </div>
          <div class="lg:col-span-9 px-4 py-3">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="buffer-throughput-2" class="block text-xs font-medium text-gray-600 mb-1">
                  Buffer Th√¥ng l∆∞·ª£ng
                </label>
                <div class="flex items-center gap-3">
                  <input 
                    id="buffer-throughput-2" 
                    type="number" 
                    min="0.1"
                    max="10.0"
                    step="0.1"
                    value="1.0"
                    class="flex-1 px-3 py-2 border border-orange-200 rounded focus:ring-2 focus:ring-orange-400 focus:border-orange-400 text-sm" />
                  <span class="text-xs text-gray-600 font-medium min-w-[60px]">
                    <span id="buffer-throughput-value-2">1.0</span>x
                  </span>
                </div>
                <p class="text-xs text-gray-500 mt-1">
                  H·ªá s·ªë nh√¢n v·ªõi th√¥ng l∆∞·ª£ng x·ª≠ l√Ω (1.0 = 100%, 1.5 = 150%)
                </p>
              </div>
              
              <!-- Data Product Selector -->
              <div>
                <label for="demand-dataset-selector-2" class="block text-xs font-medium text-gray-600 mb-1">
                  Data Product (Demands)
                </label>
                <select 
                  id="demand-dataset-selector-2" 
                  class="w-full px-3 py-2 border border-orange-200 rounded focus:ring-2 focus:ring-orange-400 focus:border-orange-400 text-sm">
                  <option value="">-- Ch·ªçn dataset demand --</option>
                </select>
                <p class="text-xs text-gray-500 mt-1">
                  Ch·ªçn dataset ƒë·ªÉ xem s·∫£n l∆∞·ª£ng l·∫•y/giao c·ªßa c√°c b∆∞u c·ª•c
                </p>
              </div>
            </div>
            
            <!-- Demand Details Display -->
            <div id="demand-details-container" class="mt-4 hidden">
              <div class="bg-gradient-to-r from-blue-50 to-blue-100 border border-blue-200 rounded-lg p-4">
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center gap-2">
                    <span class="text-blue-600 text-lg">üìä</span>
                    <h5 class="text-sm font-bold text-gray-900">Th√¥ng Tin S·∫£n L∆∞·ª£ng Demands</h5>
                  </div>
                  <button 
                    id="refresh-demand-details" 
                    class="px-3 py-1.5 text-xs bg-blue-500 hover:bg-blue-600 text-white rounded transition-colors">
                    üîÑ L√†m m·ªõi
                  </button>
                </div>
                
                <!-- Loading State -->
                <div id="demand-loading" class="text-center py-8 hidden">
                  <svg class="w-8 h-8 mx-auto mb-2 animate-spin text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                  </svg>
                  <p class="text-xs text-gray-600">ƒêang t·∫£i d·ªØ li·ªáu demands...</p>
                </div>
                
                <!-- Demand Stats Summary -->
                <div id="demand-stats-summary" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4 hidden">
                  <div class="bg-white border border-blue-200 rounded p-3 text-center">
                    <div class="text-xs text-gray-600 mb-1">T·ªïng B∆∞u C·ª•c</div>
                    <div class="text-lg font-bold text-blue-600" id="demand-total-hubs">0</div>
                  </div>
                  <div class="bg-white border border-green-200 rounded p-3 text-center">
                    <div class="text-xs text-gray-600 mb-1">T·ªïng L·∫•y (kg)</div>
                    <div class="text-lg font-bold text-green-600" id="demand-total-pickup">0</div>
                  </div>
                  <div class="bg-white border border-orange-200 rounded p-3 text-center">
                    <div class="text-xs text-gray-600 mb-1">T·ªïng Giao (kg)</div>
                    <div class="text-lg font-bold text-orange-600" id="demand-total-delivery">0</div>
                  </div>
                  <div class="bg-white border border-purple-200 rounded p-3 text-center">
                    <div class="text-xs text-gray-600 mb-1">T·ªïng C·ªông (kg)</div>
                    <div class="text-lg font-bold text-purple-600" id="demand-total-volume">0</div>
                  </div>
                </div>
                
                <!-- Demand Details Table -->
                <div id="demand-details-table-wrapper" class="hidden">
                  <div class="bg-white border border-blue-200 rounded-lg overflow-hidden">
                    <div class="overflow-x-auto max-h-96">
                      <table class="min-w-full divide-y divide-gray-300">
                        <thead class="bg-gray-100 sticky top-0">
                          <tr>
                            <th class="px-3 py-2 text-left text-xs font-bold text-gray-900 uppercase">B∆∞u C·ª•c</th>
                            <th class="px-3 py-2 text-right text-xs font-bold text-gray-900 uppercase">L·∫•y (kg)</th>
                            <th class="px-3 py-2 text-right text-xs font-bold text-gray-900 uppercase">Giao (kg)</th>
                            <th class="px-3 py-2 text-right text-xs font-bold text-gray-900 uppercase">T·ªïng (kg)</th>
                            <th class="px-3 py-2 text-center text-xs font-bold text-gray-900 uppercase">T·ª∑ L·ªá</th>
                          </tr>
                        </thead>
                        <tbody id="demand-details-tbody" class="bg-white divide-y divide-gray-200">
                          <!-- Populated by JS -->
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Row 3: Scenario Tuning Options -->
        <div class="grid grid-cols-1 lg:grid-cols-12 bg-white hover:bg-orange-50 transition-colors">
          <div class="lg:col-span-3 px-4 py-3 bg-orange-50 border-r border-orange-100">
            <label class="text-sm font-medium text-gray-800 flex items-center gap-2">
              <span class="text-orange-500">üéõÔ∏è</span>
              <span>Tinh Ch·ªânh K·ªãch B·∫£n</span>
            </label>
            <p class="text-xs text-gray-500 mt-1">C√°c t√πy ch·ªçn ƒëi·ªÅu ch·ªânh th·ªùi gian check-in/check-out</p>
          </div>
          <div class="lg:col-span-9 px-4 py-3">
            
            <!-- Scenario Cards Container -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              
              <!-- Card 1: Check-in Timing Options -->
              <div class="bg-white border border-orange-200 rounded-lg p-4 shadow-sm">
                <div class="flex items-center gap-3 mb-4">
                  <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                    <span class="text-lg">üïê</span>
                  </div>
                  <div>
                    <h4 class="text-sm font-bold text-gray-900">Check-in L·∫ßn ƒê·∫ßu</h4>
                    <p class="text-xs text-gray-500">ƒêi·ªÅu ch·ªânh th·ªùi gian b·∫Øt ƒë·∫ßu</p>
                  </div>
                </div>
                
                <div class="space-y-3">
                  <label class="flex items-center gap-3 cursor-pointer p-2 rounded hover:bg-blue-50 transition-colors">
                    <input type="checkbox" id="checkin-early" name="scenario-checkin" value="early" 
                           class="w-4 h-4 text-blue-500 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2">
                    <div class="flex-1">
                      <span class="text-sm font-medium text-gray-700">S·ªõm</span>
                      <p class="text-xs text-gray-500">ƒê·∫øn s·ªõm h∆°n k·∫ø ho·∫°ch 5-15 ph√∫t</p>
                    </div>
                  </label>
                  
                  <label class="flex items-center gap-3 cursor-pointer p-2 rounded hover:bg-yellow-50 transition-colors">
                    <input type="checkbox" id="checkin-late" name="scenario-checkin" value="late" 
                           class="w-4 h-4 text-yellow-500 bg-gray-100 border-gray-300 rounded focus:ring-yellow-500 focus:ring-2">
                    <div class="flex-1">
                      <span class="text-sm font-medium text-gray-700">Tr·ªÖ</span>
                      <p class="text-xs text-gray-500">ƒê·∫øn mu·ªôn h∆°n k·∫ø ho·∫°ch 5-20 ph√∫t</p>
                    </div>
                  </label>
                  
                  <label class="flex items-center gap-3 cursor-pointer p-2 rounded hover:bg-purple-50 transition-colors">
                    <input type="checkbox" id="checkin-mixed" name="scenario-checkin" value="mixed" 
                           class="w-4 h-4 text-purple-500 bg-gray-100 border-gray-300 rounded focus:ring-purple-500 focus:ring-2">
                    <div class="flex-1">
                      <span class="text-sm font-medium text-gray-700">Tr·ªôn</span>
                      <p class="text-xs text-gray-500">Ng·∫´u nhi√™n s·ªõm/mu·ªôn/ƒë√∫ng gi·ªù</p>
                    </div>
                  </label>
                </div>
              </div>
              
              <!-- Card 2: Transit Time Options -->
              <div class="bg-white border border-orange-200 rounded-lg p-4 shadow-sm">
                <div class="flex items-center gap-3 mb-4">
                  <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                    <span class="text-lg">üöö</span>
                  </div>
                  <div>
                    <h4 class="text-sm font-bold text-gray-900">Th·ªùi Gian Di Chuy·ªÉn</h4>
                    <p class="text-xs text-gray-500">ƒêi·ªÅu ch·ªânh t·ªëc ƒë·ªô v√† timing</p>
                  </div>
                </div>
                
                <div class="space-y-3">
                  <label class="flex items-center gap-3 cursor-pointer p-2 rounded hover:bg-green-50 transition-colors">
                    <input type="checkbox" id="transit-early" name="scenario-transit" value="early" 
                           class="w-4 h-4 text-green-500 bg-gray-100 border-gray-300 rounded focus:ring-green-500 focus:ring-2">
                    <div class="flex-1">
                      <span class="text-sm font-medium text-gray-700">ƒê·∫øn S·ªõm</span>
                      <p class="text-xs text-gray-500">TƒÉng t·ªëc ƒë·ªô, ƒë·∫øn s·ªõm h∆°n d·ª± ki·∫øn</p>
                    </div>
                  </label>
                  
                  <label class="flex items-center gap-3 cursor-pointer p-2 rounded hover:bg-red-50 transition-colors">
                    <input type="checkbox" id="transit-late" name="scenario-transit" value="late" 
                           class="w-4 h-4 text-red-500 bg-gray-100 border-gray-300 rounded focus:ring-red-500 focus:ring-2">
                    <div class="flex-1">
                      <span class="text-sm font-medium text-gray-700">ƒê·∫øn Tr·ªÖ</span>
                      <p class="text-xs text-gray-500">Ch·∫≠m l·∫°i do traffic, ƒë∆∞·ªùng x·∫•u</p>
                    </div>
                  </label>
                  
                  <label class="flex items-center gap-3 cursor-pointer p-2 rounded hover:bg-amber-50 transition-colors">
                    <input type="checkbox" id="transit-waiting" name="scenario-transit" value="waiting" 
                           class="w-4 h-4 text-amber-500 bg-gray-100 border-gray-300 rounded focus:ring-amber-500 focus:ring-2">
                    <div class="flex-1">
                      <span class="text-sm font-medium text-gray-700">Ph·∫£i Ch·ªù</span>
                      <p class="text-xs text-gray-500">Ch·ªù ƒë·ª£i t·∫°i ƒëi·ªÉm d·ª´ng, x·∫øp h√†ng</p>
                    </div>
                  </label>
                </div>
              </div>
            </div>
            
            <!-- Speed Boost Options -->
            <div class="mt-6">
              <div class="bg-gradient-to-r from-indigo-50 to-indigo-100 border border-indigo-200 rounded-lg p-4">
                <div class="flex items-center gap-3 mb-4">
                  <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center">
                    <span class="text-lg">‚ö°</span>
                  </div>
                  <div>
                    <h4 class="text-sm font-bold text-gray-900">TƒÉng T·ªëc ƒê·∫∑c Bi·ªát</h4>
                    <p class="text-xs text-gray-500">C√°c k·ªãch b·∫£n tƒÉng t·ªëc ƒë·ªô x·ª≠ l√Ω</p>
                  </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <label class="flex items-center gap-3 cursor-pointer p-3 bg-white border border-indigo-200 rounded-lg hover:bg-indigo-50 transition-colors">
                    <input type="checkbox" id="speed-boost-1-2" name="scenario-speed" value="1.2" 
                           class="w-4 h-4 text-indigo-500 bg-gray-100 border-gray-300 rounded focus:ring-indigo-500 focus:ring-2">
                    <div class="flex-1">
                      <span class="text-sm font-medium text-gray-700">TƒÉng T·ªëc 1.2x</span>
                      <p class="text-xs text-gray-500">Nhanh h∆°n 20%, √≠t traffic</p>
                    </div>
                    <div class="text-xs font-bold text-indigo-600">+20%</div>
                  </label>
                  
                  <label class="flex items-center gap-3 cursor-pointer p-3 bg-white border border-indigo-200 rounded-lg hover:bg-indigo-50 transition-colors">
                    <input type="checkbox" id="speed-boost-1-5" name="scenario-speed" value="1.5" 
                           class="w-4 h-4 text-indigo-500 bg-gray-100 border-gray-300 rounded focus:ring-indigo-500 focus:ring-2">
                    <div class="flex-1">
                      <span class="text-sm font-medium text-gray-700">TƒÉng T·ªëc 1.5x</span>
                      <p class="text-xs text-gray-500">Nhanh h∆°n 50%, ƒë∆∞·ªùng tr·ªëng</p>
                    </div>
                    <div class="text-xs font-bold text-indigo-600">+50%</div>
                  </label>
                </div>
              </div>
            </div>
            
            <!-- Additional Scenario Options -->
            <div class="mt-6">
              <div class="bg-gradient-to-r from-gray-50 to-gray-100 border border-gray-200 rounded-lg p-4">
                <div class="flex items-center gap-3 mb-4">
                  <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center">
                    <span class="text-lg">üéØ</span>
                  </div>
                  <div>
                    <h4 class="text-sm font-bold text-gray-900">K·ªãch B·∫£n Kh√°c</h4>
                    <p class="text-xs text-gray-500">C√°c t√≠nh nƒÉng m·ªü r·ªông cho m√¥ ph·ªèng</p>
                  </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                  <label class="flex items-center gap-3 cursor-pointer p-2 bg-white border border-gray-200 rounded hover:bg-gray-50 transition-colors">
                    <input type="checkbox" id="weather-impact" name="scenario-extra" value="weather" 
                           class="w-4 h-4 text-gray-500 bg-gray-100 border-gray-300 rounded focus:ring-gray-500 focus:ring-2">
                    <div class="flex-1">
                      <span class="text-xs font-medium text-gray-700">üåßÔ∏è Th·ªùi Ti·∫øt X·∫•u</span>
                      <p class="text-xs text-gray-400">M∆∞a, b√£o ·∫£nh h∆∞·ªüng</p>
                    </div>
                  </label>
                  
                  <label class="flex items-center gap-3 cursor-pointer p-2 bg-white border border-gray-200 rounded hover:bg-gray-50 transition-colors">
                    <input type="checkbox" id="peak-hour" name="scenario-extra" value="peak" 
                           class="w-4 h-4 text-gray-500 bg-gray-100 border-gray-300 rounded focus:ring-gray-500 focus:ring-2">
                    <div class="flex-1">
                      <span class="text-xs font-medium text-gray-700">‚è∞ Gi·ªù Cao ƒêi·ªÉm</span>
                      <p class="text-xs text-gray-400">Rush hour ·∫£nh h∆∞·ªüng</p>
                    </div>
                  </label>
                  
                  <label class="flex items-center gap-3 cursor-pointer p-2 bg-white border border-gray-200 rounded hover:bg-gray-50 transition-colors">
                    <input type="checkbox" id="staff-shortage" name="scenario-extra" value="shortage" 
                           class="w-4 h-4 text-gray-500 bg-gray-100 border-gray-300 rounded focus:ring-gray-500 focus:ring-2">
                    <div class="flex-1">
                      <span class="text-xs font-medium text-gray-700">üë• Thi·∫øu Nh√¢n L·ª±c</span>
                      <p class="text-xs text-gray-400">√çt ng∆∞·ªùi x·ª≠ l√Ω</p>
                    </div>
                  </label>
                </div>
              </div>
            </div>
            
            <!-- Scenario Summary -->
            <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
              <div class="flex items-start gap-2">
                <span class="text-blue-500 text-lg flex-shrink-0">üìã</span>
                <div class="text-xs text-gray-700">
                  <p class="font-semibold text-blue-700 mb-1">T√≥m t·∫Øt c√°c t√πy ch·ªçn:</p>
                  <div id="scenario-summary" class="text-gray-600">
                    <em>Ch·ªçn c√°c t√πy ch·ªçn tr√™n ƒë·ªÉ xem t√≥m t·∫Øt k·ªãch b·∫£n m√¥ ph·ªèng</em>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        
          <!-- Row 5: KTC Delivery Time Adjustment -->
        <div class="grid grid-cols-1 lg:grid-cols-12 bg-white hover:bg-orange-50 transition-colors">
          <div class="lg:col-span-3 px-4 py-3 bg-orange-50 border-r border-orange-100">
            <label class="text-sm font-medium text-gray-800 flex items-center gap-2">
              <span class="text-orange-500">üè≠</span>
              <span>ƒêi·ªÅu Ch·ªânh Th·ªùi Gian KTC</span>
            </label>
            <p class="text-xs text-gray-500 mt-1">T·ª∑ l·ªá h√†ng l·∫•y v·ªÅ/giao ƒë·∫øn KTC theo gi·ªù qu√©t</p>
          </div>
          <div class="lg:col-span-9 px-4 py-3">
            
            <!-- KTC Adjustment Cards -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              
              <!-- Card 1: BC ‚Üí KTC Flow -->
              <div class="bg-white border border-orange-200 rounded-lg p-6 shadow-sm">
                <div class="flex items-center gap-3 mb-4">
                  <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center">
                    <span class="text-2xl">üì§</span>
                  </div>
                  <div>
                    <h4 class="text-lg font-bold text-gray-900">Lu·ªìng BC ‚Üí KTC</h4>
                    <p class="text-sm text-gray-600">R·ªõt h√†ng t·∫°i BC</p>
                  </div>
                </div>
                
                <!-- Timeline -->
                <div class="mb-4">
                  <div class="text-center mb-2">
                    <div class="text-sm font-medium text-gray-700">Scanned Time Timeline</div>
                  </div>
                  <div class="relative">
                    <div class="flex items-center justify-center">
                      <span class="text-xs text-gray-500">00:00</span>
                      <div class="flex-1 h-1 bg-gray-300 mx-4 relative rounded">
                        <div class="absolute left-1/3 w-3 h-3 bg-green-500 rounded-full border-2 border-white shadow" title="19:00"></div>
                        <div class="absolute right-1/3 w-3 h-3 bg-yellow-500 rounded-full border-2 border-white shadow" title="23:00"></div>
                      </div>
                      <span class="text-xs text-gray-500">24:00</span>
                    </div>
                    <div class="text-center mt-2">
                      <span class="text-xs text-gray-600">Cut-off: 19:00 & 23:00</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Card 2: KTC ‚Üí BC Flow -->
              <div class="bg-white border border-orange-200 rounded-lg p-6 shadow-sm">
                <div class="flex items-center gap-3 mb-4">
                  <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                    <span class="text-2xl">üì•</span>
                  </div>
                  <div>
                    <h4 class="text-lg font-bold text-gray-900">Lu·ªìng KTC ‚Üí BC</h4>
                    <p class="text-sm text-gray-600">R·ªõt h√†ng t·∫°i KTC</p>
                  </div>
                </div>
                
                <!-- Timeline -->
                <div class="mb-4">
                  <div class="text-center mb-2">
                    <div class="text-sm font-medium text-gray-700">Ready Time Timeline</div>
                  </div>
                  <div class="relative">
                    <div class="flex items-center justify-center">
                      <span class="text-xs text-gray-500">00:00</span>
                      <div class="flex-1 h-1 bg-gray-300 mx-4 relative rounded">
                        <div class="absolute left-1/3 w-3 h-3 bg-green-500 rounded-full border-2 border-white shadow" title="11:00"></div>
                        <div class="absolute right-1/3 w-3 h-3 bg-yellow-500 rounded-full border-2 border-white shadow" title="15:00"></div>
                      </div>
                      <span class="text-xs text-gray-500">24:00</span>
                    </div>
                    <div class="text-center mt-2">
                      <span class="text-xs text-gray-600">Cut-off: 11:00 & 15:00</span>
                    </div>
                  </div>
                </div>
                
              </div>
              
            </div>


            <!-- Removed: KTC Simulation Chart card per product request -->
            <!-- KTC Flow Simulation Card -->
            <div class="mt-4 w-full">
              <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-indigo-100 flex items-center justify-center">üõ£Ô∏è</div>
                    <div>
                      <h4 class="text-sm font-bold text-gray-900">M√¥ ph·ªèng Lu·ªìng BC ‚Üî KTC</h4>
                      <p class="text-xs text-gray-500">ƒêi·ªÅu ch·ªânh th·ªùi gian di chuy·ªÉn gi·ªØa KTC v√† B∆∞u c·ª•c v√† xem animation</p>
                    </div>
                  </div>
                  <div class="flex items-center gap-2">
                    <label class="text-xs text-gray-600 mr-2">Animation</label>
                    <input type="checkbox" id="ktc-flow-animate" class="h-4 w-4" />
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <label class="block text-xs text-gray-600">Th·ªùi gian KTC ‚Üí BC (ph√∫t)</label>
                    <input id="ktc-travel-ktc-to-bc" type="number" min="1" value="30" class="mt-1 block w-full border rounded px-2 py-1 text-sm" />
                    <p class="text-xs text-gray-400 mt-1">Th·ªùi gian trung b√¨nh xe ch·∫°y t·ª´ KTC v·ªÅ B∆∞u c·ª•c</p>
                  </div>

                  <div>
                    <label class="block text-xs text-gray-600">Ch·∫≠m nh·∫•t ƒë·ªÉ quay v·ªÅ KTC (ph√∫t)</label>
                    <input id="ktc-return-max-delay" type="number" min="1" value="60" class="mt-1 block w-full border rounded px-2 py-1 text-sm" />
                    <p class="text-xs text-gray-400 mt-1">N·∫øu tr·ªÖ h∆°n gi√° tr·ªã n√†y, chuy·∫øn s·∫Ω ƒë∆∞·ª£c ƒë√°nh d·∫•u ch·∫≠m/kh√¥ng v·ªÅ k·ªãp</p>
                  </div>

                  <div class="flex flex-col items-start">
                    <label class="block text-xs text-gray-600">Ch·∫°y m√¥ ph·ªèng lu·ªìng</label>
                    <div class="mt-1 flex items-center gap-2">
                      <button id="ktc-run-flow-sim" class="px-3 py-1 text-sm bg-indigo-500 text-white rounded">Ch·∫°y</button>
                      <button id="ktc-reset-flow" class="px-3 py-1 text-sm bg-gray-200 rounded">Reset</button>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">C√°c tham s·ªë n√†y s·∫Ω ƒë∆∞·ª£c g·ª≠i c√πng payload m√¥ ph·ªèng v√† ·∫£nh h∆∞·ªüng ƒë·∫øn th·ªùi gian check-in/check-out c≈©ng nh∆∞ th·ªùi gian ch·ªù.</p>
                  </div>
                </div>

                <div class="mt-4">
                  <!-- Simple SVG animation: two nodes and a truck moving -->
                  <div class="w-full bg-gray-50 rounded p-3">
                    <svg id="ktc-flow-svg" viewBox="0 0 400 80" class="w-full h-20">
                      <defs>
                        <linearGradient id="g1" x1="0%" x2="100%"><stop offset="0%" stop-color="#fb923c"/><stop offset="100%" stop-color="#f97316"/></linearGradient>
                      </defs>
                      <!-- Nodes -->
                      <rect id="ktc-node-ktc" x="40" y="22" width="60" height="36" rx="6" fill="#f3f4f6" stroke="#d1d5db" />
                      <text x="70" y="44" text-anchor="middle" font-size="11" fill="#374151">KTC</text>
                      <rect id="ktc-node-bc" x="300" y="22" width="60" height="36" rx="6" fill="#f3f4f6" stroke="#d1d5db" />
                      <text x="330" y="44" text-anchor="middle" font-size="11" fill="#374151">B∆∞u c·ª•c</text>
                      <!-- Truck -->
                      <g id="ktc-flow-truck" transform="translate(100,40)">
                        <rect x="-12" y="-8" width="24" height="16" rx="3" fill="url(#g1)" stroke="#ea580c"/> 
                        <circle cx="-6" cy="10" r="4" fill="#1f2937"/>
                        <circle cx="6" cy="10" r="4" fill="#1f2937"/>
                      </g>
                    </svg>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Row 3: Cargo Type -->
        <div class="grid grid-cols-1 lg:grid-cols-12 bg-white hover:bg-orange-50 transition-colors">
          <div class="lg:col-span-3 px-4 py-3 bg-orange-50 border-r border-orange-100">
            <label class="text-sm font-medium text-gray-800 flex items-center gap-2">
              <span class="text-orange-500">üì¶</span>
              <span>Lo·∫°i H√†ng H√≥a</span>
            </label>
            <p class="text-xs text-gray-500 mt-1">Ph√¢n lo·∫°i theo tr·ªçng l∆∞·ª£ng h√†ng h√≥a</p>
          </div>
          <div class="lg:col-span-9 px-4 py-3">
            <div class="grid grid-cols-4 gap-4">
              <label class="relative cursor-pointe  r group">
                <input type="radio" name="cargo-type-2" value="heavy" class="peer sr-only" />
                <div class="px-3 py-2 border-2 border-orange-200 rounded text-center transition-all peer-checked:border-orange-500 peer-checked:bg-orange-50 hover:border-orange-300">
                  <div class="text-2xl mb-1">üì¶</div>
                  <div class="text-xs font-medium text-gray-700">N·∫∑ng</div>
                  <div class="text-xs text-gray-500">&gt;50kg</div>
                  <div class="text-xs text-gray-500">Th√¥ng nƒÉng: - g/s</div>
                </div>
              </label>
              <label class="relative cursor-pointer group">
                <input type="radio" name="cargo-type-2" value="normal" class="peer sr-only" checked />
                <div class="px-3 py-2 border-2 border-orange-200 rounded text-center transition-all peer-checked:border-orange-500 peer-checked:bg-orange-50 hover:border-orange-300">
                  <div class="text-2xl mb-1">üì¶</div>
                  <div class="text-xs font-medium text-gray-700">B√¨nh th∆∞·ªùng</div>
                  <div class="text-xs text-gray-500">20-50kg</div>
                  <div class="text-xs text-gray-500">Th√¥ng nƒÉng: - g/s</div>
                </div>
              </label>
              <label class="relative cursor-pointer group">
                <input type="radio" name="cargo-type-2" value="light" class="peer sr-only" />
                <div class="px-3 py-2 border-2 border-orange-200 rounded text-center transition-all peer-checked:border-orange-500 peer-checked:bg-orange-50 hover:border-orange-300">
                  <div class="text-2xl mb-1">üì¶</div>
                  <div class="text-xs font-medium text-gray-700">Nh·∫π</div>
                  <div class="text-xs text-gray-500">&lt;20kg</div>
                  <div class="text-xs text-gray-500">Th√¥ng nƒÉng: - g/s</div>
                </div>
              </label>
              <label class="relative cursor-pointer group">
                <input type="radio" name="cargo-type-2" value="light" class="peer sr-only" />
                <div class="px-3 py-2 border-2 border-orange-200 rounded text-center transition-all peer-checked:border-orange-500 peer-checked:bg-orange-50 hover:border-orange-300">
                  <div class="text-2xl mb-1">üì¶</div>
                  <div class="text-xs font-medium text-gray-700">Mix</div>
                  <div class="text-xs text-gray-500">0 - 70kg</div>
                  <div class="text-xs text-gray-500">Th√¥ng nƒÉng: - g/s</div>
                </div>
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- Explanatory Notes Section -->
      <div class="mt-4 p-3 bg-orange-50 border border-orange-200 rounded-lg">
        <div class="flex items-start gap-2">
          <span class="text-orange-500 text-lg flex-shrink-0">üí°</span>
          <div class="text-xs text-gray-700 space-y-1">
            <p class="font-semibold text-orange-700">Gi·∫£i th√≠ch c√°c th√¥ng s·ªë:</p>
            <ul class="list-disc list-inside space-y-0.5 ml-2">
              <li><strong>KTC (Kho Trung Chuy·ªÉn):</strong> Quy t·∫Øc lu√¢n chuy·ªÉn h√†ng gi·ªØa B∆∞u c·ª•c v√† KTC theo gi·ªù qu√©t/ready</li>
              <li><strong>T·ª∑ l·ªá r·ªõt h√†ng:</strong> Ph·∫ßn trƒÉm h√†ng kh√¥ng ƒë√°p ·ª©ng ƒëi·ªÅu ki·ªán th·ªùi gian theo quy t·∫Øc ƒë√£ c·∫•u h√¨nh</li>
              <li><strong>ƒê·ªô kh√≥ k·ªãch b·∫£n:</strong> C√°c slider ƒëi·ªÅu ch·ªânh m·ª©c ƒë·ªô kh√≥ khƒÉn (0% = d·ªÖ nh·∫•t, 50% = kh√≥ nh·∫•t)</li>
              <li><strong>Th√¥ng l∆∞·ª£ng (Throughput):</strong> S·ªë l∆∞·ª£ng h√†ng h√≥a/ƒë∆°n x·ª≠ l√Ω ƒë∆∞·ª£c trong m·ªôt ƒë∆°n v·ªã th·ªùi gian</li>
            </ul>
          </div>
        </div>
      </div>

    </div>
  </div>

    </div>
  </div>

  <div class="overflow-x-auto">
    <div>
      <table class="w-full divide-y divide-gray-300" style="table-layout: auto;">
        <thead class="sticky top-0 z-10">
          <!-- Main Headers -->
          <tr class="bg-gradient-to-r from-orange-200 to-orange-100">
            <th rowspan="2" class="px-2 py-3 text-left text-xs font-bold text-gray-900 uppercase w-24 border-r border-gray-300 align-middle">Ng√†y</th>
            <th rowspan="2" class="px-2 py-3 text-left text-xs font-bold text-gray-900 uppercase w-20 border-r border-gray-300 align-middle">Ca</th>
            <th rowspan="2" class="px-2 py-3 text-left text-xs font-bold text-gray-900 uppercase w-24 border-r-2 border-gray-400 align-middle" style="min-width: 250px;">Th√¥ng tin chuy·∫øn</th>
            <th rowspan="2" class="px-2 py-3 text-left text-xs font-bold text-gray-900 uppercase w-16 border-r border-gray-300 align-middle">STT</th>
            <th rowspan="2" class="px-2 py-2 text-left text-xs font-bold text-gray-900 uppercase bg-blue-100 border-r border-gray-300 align-middle" style="min-width: 250px;">L·ªô Tr√¨nh</th>
            <th colspan="2" class="px-2 py-2 text-center text-xs font-bold text-gray-900 uppercase bg-purple-100 border-r border-gray-300">Th·ªùi Gian</th>
            <th rowspan="2" class="px-2 py-3 text-center text-xs font-bold text-gray-900 uppercase bg-blue-100 border-r border-gray-300 align-middle" style="min-width: 180px;">S·∫£n L∆∞·ª£ng<br/><span class="text-[10px] font-normal">(kg + Throughput)</span></th>
            <th rowspan="2" class="px-2 py-3 text-center text-xs font-bold text-gray-900 uppercase bg-red-50 border-r border-gray-300 align-middle" style="min-width: 100px;">T·ª∑ L·ªá<br/>R·ªõt H√†ng<br/>(%)</th>
            <th rowspan="2" class="px-2 py-3 text-center text-xs font-bold text-gray-900 uppercase bg-emerald-50 border-r border-gray-300 align-middle" style="min-width: 100px;">T·ª∑ L·ªá<br/>L·∫•p ƒê·∫ßy<br/>(%)</th>
            <th rowspan="2" class="px-2 py-3 text-left text-xs font-bold text-gray-900 uppercase bg-amber-100 border-r border-gray-300 align-middle" style="min-width: 150px;">X·ª≠ l√Ω</th>
            <th rowspan="2" class="timeline-column px-2 py-2 text-center text-xs font-bold text-gray-900 uppercase bg-purple-100 align-middle" style="min-width: 400px; display: none;">
              Timeline Chuy·∫øn Xe<br/>
              <span class="text-[10px] font-normal text-gray-600">(To√†n b·ªô l·ªô tr√¨nh)</span>
            </th>
          </tr>
          <!-- Sub Headers -->
          <tr class="bg-gradient-to-r from-orange-100 to-orange-50">
            <th class="px-2 py-2 text-center text-xs font-semibold text-gray-800 bg-purple-50 border-r border-gray-200" style="min-width: 150px;">Check-in</th>
            <th class="px-2 py-2 text-center text-xs font-semibold text-gray-800 bg-purple-50 border-r border-gray-200" style="min-width: 150px;">Check-out</th>
          </tr>
        </thead>
        <tbody id="simulation-table-body-2" class="bg-white divide-y-2 divide-gray-400">
          <tr id="no-simulation-message">
            <td colspan="11" class="px-6 py-8 text-center">
              <div class="flex flex-col items-center gap-3">
                <div class="text-4xl">üöÄ</div>
                <div class="text-sm text-orange-600 font-semibold">
                  <span id="plan-selection-status">Ch·ªçn l·ªãch t·∫£i t·ª´ tab "L·ª±a Ch·ªçn Plan"</span>
                  <span class="block text-xs text-gray-500 mt-1 font-normal">Sau ƒë√≥ nh·∫•n "M√¥ Ph·ªèng" ƒë·ªÉ xem k·∫øt qu·∫£ d·ª± b√°o</span>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

  <!-- Trip Visualization Popup Modal - FLAT ORANGE REDESIGN -->
      <div class="bg-white border border-blue-200 rounded-lg shadow-sm overflow-hidden mb-4">
        <div class="bg-gradient-to-r from-blue-50 to-blue-100 px-4 py-3 border-b border-blue-200">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="text-blue-600 text-lg">üöõ</span>
              <h4 class="text-sm font-bold text-gray-900">T·ªïng Quan L·ªãch T·∫£i - Ph∆∞∆°ng Ti·ªán Theo Lo·∫°i & Ca</h4>
            </div>
            <div class="flex items-center gap-2">
              <button 
                id="vehicle-view-toggle" 
                class="px-3 py-1.5 text-xs bg-blue-500 hover:bg-blue-600 text-white rounded transition-colors font-medium"
                data-view="total">
                üìä Xem theo ca
              </button>
            </div>
          </div>
        </div>
        
        <!-- Total View -->
        <div id="vehicle-total-view" class="px-4 py-3">
          <!-- Summary Row -->
          <div class="mb-4 p-3 bg-gradient-to-r from-gray-50 to-gray-100 border border-gray-200 rounded-lg">
            <div class="flex items-center justify-between mb-2">
              <h5 class="text-sm font-semibold text-gray-800 flex items-center gap-2">
                <span>üìä</span>
                <span>T·ªïng Quan To√†n B·ªô</span>
              </h5>
              <div class="text-lg font-bold text-blue-600" id="total-vehicles-count">0 xe</div>
            </div>
            <div class="grid grid-cols-3 gap-3 text-center">
              <div class="bg-white border border-gray-200 rounded px-3 py-2">
                <div class="text-xs text-gray-600 mb-1">T·ªïng Chuy·∫øn</div>
                <div class="text-lg font-bold text-gray-900" id="total-trips-summary">0</div>
              </div>
              <div class="bg-white border border-gray-200 rounded px-3 py-2">
                <div class="text-xs text-gray-600 mb-1">T·ªïng T·∫£i Tr·ªçng</div>
                <div class="text-lg font-bold text-gray-900" id="total-weight-summary">0 kg</div>
              </div>
              <div class="bg-white border border-gray-200 rounded px-3 py-2">
                <div class="text-xs text-gray-600 mb-1">Hi·ªáu Su·∫•t TB</div>
                <div class="text-lg font-bold text-gray-900" id="avg-efficiency-summary">0%</div>
              </div>
            </div>
          </div>

          <!-- Vehicle Types Grid -->
          <div class="mb-4">
            <h5 class="text-sm font-semibold text-gray-800 mb-3 flex items-center gap-2">
              <span>üöö</span>
              <span>Ph√¢n Lo·∫°i Theo T·∫£i Tr·ªçng</span>
            </h5>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3" id="vehicle-total-grid">
              
              <!-- Heavy Trucks -->
              <div class="bg-gradient-to-br from-red-50 to-red-100 border-2 border-red-200 rounded-lg p-4 text-center hover:shadow-md transition-all">
                <div class="text-2xl mb-2">üöõ</div>
                <div class="text-xs font-medium text-gray-700 mb-1">Xe N·∫∑ng</div>
                <div class="text-xs text-gray-500 mb-2">&gt; 15 t·∫•n</div>
                <div class="text-xl font-bold text-red-600" id="heavy-truck-count">0</div>
                <div class="text-xs text-gray-500 mt-1" id="heavy-truck-trips">0 chuy·∫øn</div>
              </div>

              <!-- Medium Trucks -->
              <div class="bg-gradient-to-br from-orange-50 to-orange-100 border-2 border-orange-200 rounded-lg p-4 text-center hover:shadow-md transition-all">
                <div class="text-2xl mb-2">üöö</div>
                <div class="text-xs font-medium text-gray-700 mb-1">Xe Trung</div>
                <div class="text-xs text-gray-500 mb-2">5-15 t·∫•n</div>
                <div class="text-xl font-bold text-orange-600" id="medium-truck-count">0</div>
                <div class="text-xs text-gray-500 mt-1" id="medium-truck-trips">0 chuy·∫øn</div>
              </div>

              <!-- Light Trucks -->
              <div class="bg-gradient-to-br from-green-50 to-green-100 border-2 border-green-200 rounded-lg p-4 text-center hover:shadow-md transition-all">
                <div class="text-2xl mb-2">üöê</div>
                <div class="text-xs font-medium text-gray-700 mb-1">Xe Nh·∫π</div>
                <div class="text-xs text-gray-500 mb-2">1-5 t·∫•n</div>
                <div class="text-xl font-bold text-green-600" id="light-truck-count">0</div>
                <div class="text-xs text-gray-500 mt-1" id="light-truck-trips">0 chuy·∫øn</div>
              </div>

              <!-- Vans -->
              <div class="bg-gradient-to-br from-blue-50 to-blue-100 border-2 border-blue-200 rounded-lg p-4 text-center hover:shadow-md transition-all">
                <div class="text-2xl mb-2">üöô</div>
                <div class="text-xs font-medium text-gray-700 mb-1">Van/Pickup</div>
                <div class="text-xs text-gray-500 mb-2">&lt; 1 t·∫•n</div>
                <div class="text-xl font-bold text-blue-600" id="van-count">0</div>
                <div class="text-xs text-gray-500 mt-1" id="van-trips">0 chuy·∫øn</div>
              </div>

              <!-- Motorcycles -->
              <div class="bg-gradient-to-br from-purple-50 to-purple-100 border-2 border-purple-200 rounded-lg p-4 text-center hover:shadow-md transition-all">
                <div class="text-2xl mb-2">üèçÔ∏è</div>
                <div class="text-xs font-medium text-gray-700 mb-1">Xe M√°y</div>
                <div class="text-xs text-gray-500 mb-2">&lt; 200kg</div>
                <div class="text-xl font-bold text-purple-600" id="motorcycle-count">0</div>
                <div class="text-xs text-gray-500 mt-1" id="motorcycle-trips">0 chuy·∫øn</div>
              </div>

              <!-- Other Vehicles -->
              <div class="bg-gradient-to-br from-gray-50 to-gray-100 border-2 border-gray-200 rounded-lg p-4 text-center hover:shadow-md transition-all">
                <div class="text-2xl mb-2">üöó</div>
                <div class="text-xs font-medium text-gray-700 mb-1">Kh√°c</div>
                <div class="text-xs text-gray-500 mb-2">ƒê·∫∑c bi·ªát</div>
                <div class="text-xl font-bold text-gray-600" id="other-vehicle-count">0</div>
                <div class="text-xs text-gray-500 mt-1" id="other-vehicle-trips">0 chuy·∫øn</div>
              </div>

            </div>
          </div>

          <!-- No data placeholder (hidden by default) -->
          <div id="vehicle-no-data" class="text-center text-xs text-gray-400 col-span-full py-4 hidden">
            Ch∆∞a c√≥ d·ªØ li·ªáu ph∆∞∆°ng ti·ªán
          </div>
        </div>

        <!-- Shift View (Hidden by default) -->
        <div id="vehicle-shift-view" class="px-4 py-3 hidden">
          <div class="space-y-4" id="vehicle-shift-container">
            
            <!-- Ca S√°ng -->
            <div class="bg-gradient-to-r from-yellow-50 to-yellow-100 border border-yellow-200 rounded-lg p-4">
              <div class="flex items-center justify-between mb-3">
                <h5 class="text-sm font-semibold text-gray-800 flex items-center gap-2">
                  <span class="text-yellow-600">üåÖ</span>
                  <span>Ca S√°ng (06:00-14:00)</span>
                </h5>
                <div class="text-lg font-bold text-yellow-600" id="morning-shift-total">0 xe</div>
              </div>
              <div class="grid grid-cols-3 md:grid-cols-6 gap-2" id="morning-shift-vehicles">
                <!-- Dynamically populated -->
              </div>
            </div>

            <!-- Ca Chi·ªÅu -->
            <div class="bg-gradient-to-r from-orange-50 to-orange-100 border border-orange-200 rounded-lg p-4">
              <div class="flex items-center justify-between mb-3">
                <h5 class="text-sm font-semibold text-gray-800 flex items-center gap-2">
                  <span class="text-orange-600">üåá</span>
                  <span>Ca Chi·ªÅu (14:00-22:00)</span>
                </h5>
                <div class="text-lg font-bold text-orange-600" id="afternoon-shift-total">0 xe</div>
              </div>
              <div class="grid grid-cols-3 md:grid-cols-6 gap-2" id="afternoon-shift-vehicles">
                <!-- Dynamically populated -->
              </div>
            </div>

            <!-- Ca ƒê√™m -->
            <div class="bg-gradient-to-r from-blue-50 to-blue-100 border border-blue-200 rounded-lg p-4">
              <div class="flex items-center justify-between mb-3">
                <h5 class="text-sm font-semibold text-gray-800 flex items-center gap-2">
                  <span class="text-blue-600">üåÉ</span>
                  <span>Ca ƒê√™m (22:00-06:00)</span>
                </h5>
                <div class="text-lg font-bold text-blue-600" id="night-shift-total">0 xe</div>
              </div>
              <div class="grid grid-cols-3 md:grid-cols-6 gap-2" id="night-shift-vehicles">
                <!-- Dynamically populated -->
              </div>
            </div>

            <!-- No data placeholder -->
            <div id="shift-no-data" class="text-center text-xs text-gray-400 py-4 hidden">
              Ch∆∞a c√≥ d·ªØ li·ªáu ph∆∞∆°ng ti·ªán theo ca
            </div>
          </div>
        </div>
      </div>

      <!-- Charts Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        
        <!-- Trip Visualization Popup Modal - FLAT ORANGE REDESIGN -->
        <div 
          id="trip-popup-modal" 
          class="fixed inset-0 z-50 bg-black bg-opacity-70 hidden" 
          style="backdrop-filter: blur(4px);"
          onclick="if(event.target === this && typeof window.hideTripPopup === 'function') window.hideTripPopup();">
          <div class="h-full w-full overflow-auto p-4">
            <div class="bg-white rounded-3xl shadow-2xl max-w-7xl mx-auto my-4 overflow-hidden">
              
              <!-- Header - Flat Orange Design -->
              <div class="relative bg-gradient-to-r from-orange-500 to-orange-600 px-8 py-6">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-4">
                    <div class="w-16 h-16 bg-white/20 backdrop-blur rounded-2xl flex items-center justify-center">
                      <span class="text-4xl">üöö</span>
                    </div>
                    <div>
                      <h3 class="text-2xl font-bold text-white">Chi Ti·∫øt Chuy·∫øn Xe</h3>
                      <div class="text-sm text-orange-100 mt-1 flex items-center gap-2">
                        <span>üó∫Ô∏è</span>
                        <span id="trip-popup-route-title">Tuy·∫øn ƒë∆∞·ªùng</span>
                      </div>
                    </div>
                  </div>
                  <button 
                    id="trip-popup-close" 
                    onclick="if(typeof window.hideTripPopup === 'function') window.hideTripPopup();"
                    class="text-white hover:bg-white/20 rounded-2xl p-3 transition-all">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                  </button>
                </div>
                <!-- Stats badges - Flat Orange -->
                <div class="flex flex-wrap gap-3 mt-5">
                  <div class="bg-white/95 backdrop-blur rounded-xl px-5 py-3 flex items-center gap-3 shadow-md">
                    <div class="w-10 h-10 rounded-lg bg-orange-100 flex items-center justify-center">
                      <span class="text-xl">üìÖ</span>
                    </div>
                    <div>
                      <div class="text-xs text-gray-500 font-medium">Ng√†y</div>
                      <div class="font-bold text-gray-900 text-lg" id="trip-stat-date">-</div>
                    </div>
                  </div>
                  <div class="bg-white/95 backdrop-blur rounded-xl px-5 py-3 flex items-center gap-3 shadow-md">
                    <div class="w-10 h-10 rounded-lg bg-orange-100 flex items-center justify-center">
                      <span class="text-xl">‚è∞</span>
                    </div>
                    <div>
                      <div class="text-xs text-gray-500 font-medium">Ca</div>
                      <div class="font-bold text-gray-900 text-lg" id="trip-stat-shift">-</div>
                    </div>
                  </div>
                  <div class="bg-white/95 backdrop-blur rounded-xl px-5 py-3 flex items-center gap-3 shadow-md flex-1 min-w-[140px]">
                    <div class="w-10 h-10 rounded-lg bg-green-100 flex items-center justify-center">
                      <span class="text-xl">‚úÖ</span>
                    </div>
                    <div>
                      <div class="text-xs text-gray-500 font-medium">Ontime</div>
                      <div class="font-bold text-green-600 text-2xl" id="trip-stat-ontime">-</div>
                    </div>
                  </div>
                  <div class="bg-white/95 backdrop-blur rounded-xl px-5 py-3 flex items-center gap-3 shadow-md flex-1 min-w-[140px]">
                    <div class="w-10 h-10 rounded-lg bg-red-100 flex items-center justify-center">
                      <span class="text-xl">üì¶</span>
                    </div>
                    <div>
                      <div class="text-xs text-gray-500 font-medium">R·ªõt h√†ng</div>
                      <div class="font-bold text-red-600 text-2xl" id="trip-stat-drop">-</div>
                    </div>
                  </div>
                  <div class="bg-white/95 backdrop-blur rounded-xl px-5 py-3 flex items-center gap-3 shadow-md flex-1 min-w-[140px]">
                    <div class="w-10 h-10 rounded-lg bg-orange-100 flex items-center justify-center">
                      <span class="text-xl">üìä</span>
                    </div>
                    <div>
                      <div class="text-xs text-gray-500 font-medium">L·∫•p ƒë·∫ßy</div>
                      <div class="font-bold text-orange-600 text-2xl" id="trip-stat-load">-</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Main Content -->
              <div class="p-8 bg-gray-50">
                
                <!-- Visual Metrics Section - NEW -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                  
                  <!-- Truck Load Factor Visualization -->
                  <div class="bg-white rounded-2xl p-6 shadow-lg border-2 border-orange-100">
                    <div class="text-center mb-4">
                      <h4 class="font-bold text-gray-800 text-lg mb-1">T·ªâ L·ªá L·∫•p ƒê·∫ßy</h4>
                      <p class="text-sm text-gray-500">Kh·ªëi l∆∞·ª£ng h√†ng h√≥a</p>
                    </div>
                    <!-- SVG Truck with fill animation -->
                    <div class="relative mx-auto" style="width: 180px; height: 140px;">
                      <svg viewBox="0 0 200 150" class="w-full h-full">
                        <!-- Truck body outline -->
                        <defs>
                          <linearGradient id="truckGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" stop-color="#fb923c"/>
                            <stop offset="100%" stop-color="#f97316"/>
                          </linearGradient>
                        </defs>
                        <!-- Truck container -->
                        <rect x="30" y="40" width="120" height="70" rx="6" fill="#e5e7eb" stroke="#9ca3af" stroke-width="3"/>
                        <!-- Fill level (animated) -->
                        <rect id="truck-fill-level" x="33" y="107" width="114" height="0" fill="url(#truckGradient)" style="transition: all 0.8s ease-out;">
                          <animate attributeName="y" from="110" to="43" dur="0.8s" fill="freeze" begin="indefinite" id="truck-fill-anim-y"/>
                          <animate attributeName="height" from="0" to="67" dur="0.8s" fill="freeze" begin="indefinite" id="truck-fill-anim-h"/>
                        </rect>
                        <!-- Truck cabin -->
                        <rect x="145" y="60" width="30" height="50" rx="4" fill="#fb923c" stroke="#f97316" stroke-width="2"/>
                        <rect x="150" y="65" width="15" height="15" rx="2" fill="#fef3c7"/>
                        <!-- Wheels -->
                        <circle cx="55" cy="115" r="12" fill="#374151" stroke="#1f2937" stroke-width="3"/>
                        <circle cx="55" cy="115" r="6" fill="#6b7280"/>
                        <circle cx="125" cy="115" r="12" fill="#374151" stroke="#1f2937" stroke-width="3"/>
                        <circle cx="125" cy="115" r="6" fill="#6b7280"/>
                        <circle cx="160" cy="115" r="12" fill="#374151" stroke="#1f2937" stroke-width="3"/>
                        <circle cx="160" cy="115" r="6" fill="#6b7280"/>
                        <!-- Percentage text overlay -->
                        <text id="truck-fill-text" x="90" y="80" text-anchor="middle" font-size="24" font-weight="bold" fill="#f97316">0%</text>
                      </svg>
                    </div>
                    <div class="mt-4 text-center">
                      <div class="text-3xl font-bold text-orange-600" id="load-factor-value">0%</div>
                      <div class="text-xs text-gray-500 mt-1">Dung t√≠ch s·ª≠ d·ª•ng</div>
                    </div>
                  </div>

                  <!-- Ontime Rate Visualization -->
                  <div class="bg-white rounded-2xl p-6 shadow-lg border-2 border-green-100">
                    <div class="text-center mb-4">
                      <h4 class="font-bold text-gray-800 text-lg mb-1">T·ªâ L·ªá Ontime</h4>
                      <p class="text-sm text-gray-500">Giao h√†ng ƒë√∫ng gi·ªù</p>
                    </div>
                    <!-- SVG Clock with progress ring -->
                    <div class="relative mx-auto" style="width: 140px; height: 140px;">
                      <svg viewBox="0 0 140 140" class="w-full h-full transform -rotate-90">
                        <!-- Background circle -->
                        <circle cx="70" cy="70" r="60" fill="none" stroke="#e5e7eb" stroke-width="12"/>
                        <!-- Progress circle -->
                        <circle id="ontime-progress-ring" cx="70" cy="70" r="60" fill="none" stroke="#10b981" stroke-width="12" 
                                stroke-dasharray="377" stroke-dashoffset="377" stroke-linecap="round"
                                style="transition: stroke-dashoffset 1s ease-out"/>
                      </svg>
                      <!-- Clock icon in center -->
                      <div class="absolute inset-0 flex items-center justify-center">
                        <div class="text-5xl">‚è±Ô∏è</div>
                      </div>
                    </div>
                    <div class="mt-4 text-center">
                      <div class="text-3xl font-bold text-green-600" id="ontime-rate-value">0%</div>
                      <div class="text-xs text-gray-500 mt-1">Chuy·∫øn ƒë√∫ng gi·ªù</div>
                    </div>
                  </div>

                  <!-- Drop Rate Visualization -->
                  <div class="bg-white rounded-2xl p-6 shadow-lg border-2 border-red-100">
                    <div class="text-center mb-4">
                      <h4 class="font-bold text-gray-800 text-lg mb-1">T·ªâ L·ªá R·ªõt H√†ng</h4>
                      <p class="text-sm text-gray-500">H√†ng h√≥a th·∫•t l·∫°c</p>
                    </div>
                    <!-- SVG Package with damage indicator -->
                    <div class="relative mx-auto" style="width: 140px; height: 140px;">
                      <svg viewBox="0 0 140 140" class="w-full h-full transform -rotate-90">
                        <!-- Background circle -->
                        <circle cx="70" cy="70" r="60" fill="none" stroke="#e5e7eb" stroke-width="12"/>
                        <!-- Progress circle (red) -->
                        <circle id="drop-progress-ring" cx="70" cy="70" r="60" fill="none" stroke="#ef4444" stroke-width="12" 
                                stroke-dasharray="377" stroke-dashoffset="377" stroke-linecap="round"
                                style="transition: stroke-dashoffset 1s ease-out"/>
                      </svg>
                      <!-- Package icon in center -->
                      <div class="absolute inset-0 flex items-center justify-center">
                        <div class="text-5xl">üì¶</div>
                      </div>
                    </div>
                    <div class="mt-4 text-center">
                      <div class="text-3xl font-bold text-red-600" id="drop-rate-value">0%</div>
                      <div class="text-xs text-gray-500 mt-1">H√†ng b·ªã r·ªõt</div>
                    </div>
                  </div>
                </div>

                <!-- Route Map Visualization -->
                <div class="mb-6">
                  <div class="bg-white border-2 border-orange-100 rounded-2xl overflow-hidden shadow-lg">
                    <div class="px-6 py-4 bg-gradient-to-r from-orange-50 to-orange-100 border-b border-orange-200 flex items-center justify-between">
                      <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-orange-500 flex items-center justify-center">
                          <span class="text-xl">üó∫Ô∏è</span>
                        </div>
                        <div>
                          <h4 class="text-gray-900 font-bold text-lg">S∆° ƒê·ªì Tuy·∫øn ƒê∆∞·ªùng</h4>
                          <p class="text-xs text-gray-600">L·ªô tr√¨nh di chuy·ªÉn gi·ªØa c√°c b∆∞u c·ª•c v√† kho</p>
                        </div>
                      </div>
                      <div class="flex items-center gap-2">
                        <button id="route-map-play" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white text-sm font-medium rounded-xl transition flex items-center gap-2 shadow-md">
                          <span id="route-map-play-icon">‚ñ∂</span>
                          <span id="route-map-play-text">Ch·∫°y</span>
                        </button>
                        <button id="route-map-reset" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm font-medium rounded-xl transition shadow-md">
                          Reset
                        </button>
                        <div class="flex items-center gap-2 ml-2 bg-white px-3 py-2 rounded-xl">
                          <span class="text-xs text-gray-600 font-medium">T·ªëc ƒë·ªô:</span>
                          <input id="route-map-speed" type="range" min="0.5" max="3" step="0.5" value="1" class="w-20 h-2 accent-orange-500" />
                        </div>
                      </div>
                    </div>
                    <!-- Route Graph Canvas -->
                    <div class="relative bg-gradient-to-br from-gray-900 to-gray-800" style="height: 320px;">
                      <svg id="route-map-svg" class="w-full h-full" viewBox="0 0 900 300" preserveAspectRatio="xMidYMid meet">
                        <defs>
                          <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                            <path d="M 40 0 L 0 0 0 40" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="1"/>
                          </pattern>
                          <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                            <feGaussianBlur stdDeviation="3" result="blur"/>
                            <feComposite in="SourceGraphic" in2="blur" operator="over"/>
                          </filter>
                          <linearGradient id="routeGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" stop-color="#fb923c"/>
                            <stop offset="50%" stop-color="#f97316"/>
                            <stop offset="100%" stop-color="#ea580c"/>
                          </linearGradient>
                        </defs>
                        <rect width="100%" height="100%" fill="url(#grid)"/>
                        <g id="route-paths"></g>
                        <g id="route-nodes"></g>
                        <!-- Orange Truck -->
                        <g id="route-truck" transform="translate(0,0)" style="filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));">
                          <rect x="-20" y="-12" width="40" height="24" rx="4" fill="#f97316" stroke="#ea580c" stroke-width="2"/>
                          <rect x="-16" y="-8" width="20" height="16" rx="2" fill="#fb923c"/>
                          <rect x="6" y="-6" width="10" height="12" rx="1" fill="#fef3c7"/>
                          <circle cx="-10" cy="12" r="5" fill="#1f2937" stroke="#374151" stroke-width="1.5"/>
                          <circle cx="10" cy="12" r="5" fill="#1f2937" stroke="#374151" stroke-width="1.5"/>
                          <circle cx="-10" cy="12" r="2" fill="#6b7280"/>
                          <circle cx="10" cy="12" r="2" fill="#6b7280"/>
                        </g>
                      </svg>
                      <!-- Loading overlay -->
                      <div id="route-map-loading" class="absolute inset-0 bg-gray-900/90 flex items-center justify-center hidden">
                        <div class="text-center">
                          <div class="animate-spin rounded-full h-12 w-12 border-4 border-orange-200 border-t-orange-500 mx-auto mb-3"></div>
                          <div class="text-orange-300 text-sm font-medium">ƒêang t·∫£i s∆° ƒë·ªì...</div>
                        </div>
                      </div>
                      <!-- Legend -->
                      <div class="absolute bottom-4 left-4 bg-gray-900/80 backdrop-blur rounded-xl px-4 py-3 text-xs text-white shadow-lg border border-gray-700">
                        <div class="flex items-center gap-5">
                          <div class="flex items-center gap-2">
                            <div class="w-5 h-5 rounded bg-purple-500"></div>
                            <span class="font-medium">Kho TC</span>
                          </div>
                          <div class="flex items-center gap-2">
                            <div class="w-5 h-5 rounded bg-orange-500"></div>
                            <span class="font-medium">B∆∞u c·ª•c</span>
                          </div>
                          <div class="flex items-center gap-2">
                            <div class="w-5 h-5 rounded bg-emerald-500"></div>
                            <span class="font-medium">ƒê√£ gh√©</span>
                          </div>
                        </div>
                      </div>
                      <!-- Current stop info -->
                      <div id="route-map-info" class="absolute top-4 right-4 bg-orange-500/90 backdrop-blur rounded-xl px-5 py-3 text-white shadow-lg hidden">
                        <div class="text-xs opacity-90 font-medium">ƒêi·ªÉm hi·ªán t·∫°i:</div>
                        <div id="route-map-current-stop" class="font-bold text-lg">-</div>
                      </div>
                    </div>
                    <!-- Stop timeline -->
                    <div class="px-6 py-4 bg-orange-50 border-t border-orange-200">
                      <div id="route-timeline" class="flex items-center gap-1 overflow-x-auto pb-2">
                        <!-- Timeline items generated dynamically -->
                      </div>
                    </div>
                  </div>
                </div>

                <!-- 3D Visualization Section - Three.js -->
                <div class="mb-6">
                  <div class="bg-white border-2 border-orange-100 rounded-2xl overflow-hidden shadow-lg">
                    <div class="px-6 py-4 bg-gradient-to-r from-orange-50 to-orange-100 border-b border-orange-200 flex items-center justify-between">
                      <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-orange-500 flex items-center justify-center">
                          <span class="text-xl">üé®</span>
                        </div>
                        <div>
                          <h4 class="text-gray-900 font-bold text-lg">M√¥ Ph·ªèng 3D</h4>
                          <p class="text-xs text-gray-600">Tr·ª±c quan h√≥a tuy·∫øn ƒë∆∞·ªùng trong kh√¥ng gian 3D</p>
                        </div>
                      </div>
                      <button id="reset-3d-view" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white text-sm font-medium rounded-xl transition shadow-md">
                        Reset Camera
                      </button>
                    </div>
                    <div class="relative bg-gradient-to-br from-gray-900 to-gray-800" style="height: 400px;">
                      <canvas id="trip-popup-3d-canvas" class="w-full h-full"></canvas>
                      <div id="trip-popup-3d-loading" class="absolute inset-0 bg-gray-900/90 flex items-center justify-center">
                        <div class="text-center">
                          <div class="animate-spin rounded-full h-12 w-12 border-4 border-orange-200 border-t-orange-500 mx-auto mb-3"></div>
                          <div class="text-orange-300 text-sm font-medium">ƒêang t·∫£i m√¥ h√¨nh 3D...</div>
                        </div>
                      </div>
                      <!-- 3D Controls hint -->
                      <div class="absolute bottom-4 left-4 bg-gray-900/80 backdrop-blur rounded-xl px-4 py-3 text-xs text-white shadow-lg border border-gray-700">
                        <div class="font-medium mb-2">‚å®Ô∏è ƒêi·ªÅu khi·ªÉn:</div>
                        <div class="space-y-1 text-gray-300">
                          <div>üñ±Ô∏è K√©o chu·ªôt tr√°i: Xoay</div>
                          <div>üñ±Ô∏è K√©o chu·ªôt ph·∫£i: Di chuy·ªÉn</div>
                          <div>üîç LƒÉn chu·ªôt: Ph√≥ng to/thu nh·ªè</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Two column layout for details -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  
                  <!-- Left: Trip Info Cards -->
                  <div class="space-y-4">
                    
                    <!-- Route & Time Combined -->
                    <div class="bg-white rounded-2xl p-6 shadow-lg border-2 border-orange-100">
                      <div class="flex items-center gap-3 mb-5">
                        <div class="w-10 h-10 rounded-xl bg-orange-100 flex items-center justify-center">
                          <span class="text-xl">üó∫Ô∏è</span>
                        </div>
                        <h4 class="font-bold text-gray-800 text-lg">Th√¥ng Tin Tuy·∫øn & Th·ªùi Gian</h4>
                      </div>
                      <div class="grid grid-cols-2 gap-4 text-sm">
                        <div class="bg-orange-50 rounded-xl p-3">
                          <span class="text-gray-600 text-xs block mb-1 font-medium">M√£ code</span>
                          <span class="font-bold text-gray-900 text-base" id="trip-detail-code">-</span>
                        </div>
                        <div class="bg-orange-50 rounded-xl p-3">
                          <span class="text-gray-600 text-xs block mb-1 font-medium">STT</span>
                          <span class="font-bold text-gray-900 text-base" id="trip-detail-stt">-</span>
                        </div>
                        <div class="col-span-2 bg-orange-50 rounded-xl p-3">
                          <span class="text-gray-600 text-xs block mb-1 font-medium">L·ªô tr√¨nh</span>
                          <span class="font-semibold text-gray-900" id="trip-detail-route">-</span>
                        </div>
                        <div class="bg-green-50 rounded-xl p-3">
                          <span class="text-gray-600 text-xs block mb-1 font-medium">‚è∞ Check-in</span>
                          <span class="font-bold text-green-700 text-base" id="trip-detail-checkin">-</span>
                        </div>
                        <div class="bg-red-50 rounded-xl p-3">
                          <span class="text-gray-600 text-xs block mb-1 font-medium">‚è∞ Check-out</span>
                          <span class="font-bold text-red-700 text-base" id="trip-detail-checkout">-</span>
                        </div>
                      </div>
                    </div>

                    <!-- Volume -->
                    <div class="bg-white rounded-2xl p-6 shadow-lg border-2 border-orange-100">
                      <div class="flex items-center gap-3 mb-5">
                        <div class="w-10 h-10 rounded-xl bg-orange-100 flex items-center justify-center">
                          <span class="text-xl">üì¶</span>
                        </div>
                        <h4 class="font-bold text-gray-800 text-lg">S·∫£n L∆∞·ª£ng (kg)</h4>
                      </div>
                      <div class="grid grid-cols-2 gap-4">
                        <div class="bg-green-50 rounded-xl p-4 text-center border-2 border-green-200">
                          <div class="text-xs text-gray-600 mb-2 font-medium">L·∫•y h√†ng</div>
                          <div class="text-2xl font-bold text-green-600" id="trip-detail-pickup">-</div>
                        </div>
                        <div class="bg-orange-50 rounded-xl p-4 text-center border-2 border-orange-200">
                          <div class="text-xs text-gray-600 mb-2 font-medium">Giao h√†ng</div>
                          <div class="text-2xl font-bold text-orange-600" id="trip-detail-delivery">-</div>
                        </div>
                      </div>
                    </div>

                    <!-- Processing -->
                    <div class="bg-white rounded-2xl p-6 shadow-lg border-2 border-orange-100">
                      <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 rounded-xl bg-orange-100 flex items-center justify-center">
                          <span class="text-xl">‚öôÔ∏è</span>
                        </div>
                        <h4 class="font-bold text-gray-800 text-lg">Tr·∫°ng Th√°i X·ª≠ L√Ω</h4>
                      </div>
                      <div class="text-sm font-bold text-gray-900 bg-orange-50 rounded-xl px-5 py-4 border-2 border-orange-200" id="trip-detail-processing">-</div>
                    </div>
                  </div>

                  <!-- Right: Performance Metrics & Stops -->
                  <div class="space-y-4">
                    
                    <!-- Detailed Metrics -->
                    <div class="bg-white rounded-2xl p-6 shadow-lg border-2 border-orange-100">
                      <div class="flex items-center gap-3 mb-5">
                        <div class="w-10 h-10 rounded-xl bg-orange-100 flex items-center justify-center">
                          <span class="text-xl">üìä</span>
                        </div>
                        <h4 class="font-bold text-gray-800 text-lg">Chi Ti·∫øt Hi·ªáu Su·∫•t</h4>
                      </div>
                      <div class="space-y-4">
                        <!-- Ontime -->
                        <div class="bg-green-50 rounded-xl p-4 border-2 border-green-200">
                          <div class="flex justify-between items-center mb-3">
                            <span class="text-sm text-gray-700 flex items-center gap-2 font-medium">
                              <span class="w-4 h-4 bg-green-500 rounded-full"></span>
                              T·ª∑ l·ªá Ontime
                            </span>
                            <span class="text-2xl font-bold text-green-600" id="trip-metric-ontime">0%</span>
                          </div>
                          <div class="w-full bg-green-200 rounded-full h-4 overflow-hidden">
                            <div id="trip-bar-ontime" class="bg-gradient-to-r from-green-500 to-green-600 h-4 rounded-full transition-all duration-700 shadow-md" style="width: 0%"></div>
                          </div>
                        </div>
                        <!-- Drop rate -->
                        <div class="bg-red-50 rounded-xl p-4 border-2 border-red-200">
                          <div class="flex justify-between items-center mb-3">
                            <span class="text-sm text-gray-700 flex items-center gap-2 font-medium">
                              <span class="w-4 h-4 bg-red-500 rounded-full"></span>
                              T·ª∑ l·ªá R·ªõt h√†ng
                            </span>
                            <span class="text-2xl font-bold text-red-600" id="trip-metric-drop">0%</span>
                          </div>
                          <div class="w-full bg-red-200 rounded-full h-4 overflow-hidden">
                            <div id="trip-bar-drop" class="bg-gradient-to-r from-red-500 to-red-600 h-4 rounded-full transition-all duration-700 shadow-md" style="width: 0%"></div>
                          </div>
                        </div>
                        <!-- Load factor -->
                        <div class="bg-orange-50 rounded-xl p-4 border-2 border-orange-200">
                          <div class="flex justify-between items-center mb-3">
                            <span class="text-sm text-gray-700 flex items-center gap-2 font-medium">
                              <span class="w-4 h-4 bg-orange-500 rounded-full"></span>
                              T·ª∑ l·ªá L·∫•p ƒë·∫ßy
                            </span>
                            <span class="text-2xl font-bold text-orange-600" id="trip-metric-load">0%</span>
                          </div>
                          <div class="w-full bg-orange-200 rounded-full h-4 overflow-hidden">
                            <div id="trip-bar-load" class="bg-gradient-to-r from-orange-500 to-orange-600 h-4 rounded-full transition-all duration-700 shadow-md" style="width: 0%"></div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Stops List -->
                    <div class="bg-white rounded-2xl border-2 border-orange-100 overflow-hidden shadow-lg">
                      <div class="px-6 py-4 bg-gradient-to-r from-orange-50 to-orange-100 border-b border-orange-200 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                          <div class="w-10 h-10 rounded-xl bg-orange-500 flex items-center justify-center">
                            <span class="text-xl">üìç</span>
                          </div>
                          <h4 class="font-bold text-gray-800 text-base">Danh S√°ch ƒêi·ªÉm D·ª´ng</h4>
                        </div>
                        <span id="stops-count" class="text-xs bg-white text-orange-600 px-3 py-1.5 rounded-full font-bold border-2 border-orange-200">0 ƒëi·ªÉm</span>
                      </div>
                      <div id="stops-list" class="max-h-64 overflow-y-auto divide-y divide-gray-100">
                        <div class="px-6 py-5 text-center text-gray-400 text-sm">
                          Ch∆∞a c√≥ d·ªØ li·ªáu ƒëi·ªÉm d·ª´ng
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Footer: JSON toggle -->
              <div class="border-t-2 border-orange-100">
                <button id="trip-json-toggle" class="w-full px-6 py-4 text-left text-sm font-medium text-gray-600 hover:bg-orange-50 flex items-center justify-between transition">
                  <span class="flex items-center gap-2">
                    <span>üìÑ</span>
                    <span>Xem d·ªØ li·ªáu JSON chi ti·∫øt</span>
                  </span>
                  <svg class="w-5 h-5 transform transition-transform text-orange-500" id="trip-json-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7"/>
                  </svg>
                </button>
                <div id="trip-json-content" class="hidden px-6 py-5 bg-gray-50 max-h-64 overflow-auto border-t border-orange-100">
                  <pre id="trip-popup-content" class="text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-4 rounded-xl border border-gray-200"></pre>
                </div>
              </div>
              
            </div>
          </div>
        </div>
        
        <!-- Hidden: Keep old IDs for 3D compatibility but hidden -->
        <div class="hidden">
          <canvas id="trip-popup-3d-canvas"></canvas>
          <div id="trip-popup-2d-svg-wrapper"></div>
          <div id="trip-popup-3d-loading"></div>
        </div>

